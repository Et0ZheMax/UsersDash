<!doctype html><html lang="ru"><head>
<meta charset="utf-8"><title>Central</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/99.png" type="image/x-icon">
<style>
 body{margin:0;font:14px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
 .header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;
         padding:10px 16px;background:#fff;box-shadow:0 1px 3px #0001}
 .header h2{margin:0;font-size:20px;font-weight:600;text-align:center}
 .btn{padding:6px 14px;border:none;border-radius:8px;background:#0070c9;color:#fff;cursor:pointer}
 .grid{display:grid;gap:14px;padding:16px}
 .card{background:#fff;border-radius:14px;box-shadow:0 1px 4px #0002;
       padding:10px;display:flex;flex-direction:column;position:relative}
 .cardSpin{position:absolute;top:45%;left:45%;width:30px;height:30px;border:4px solid #ccc;
           border-top-color:#0070c9;border-radius:50%;animation:spin 1s linear infinite}
 .srvTitle{font-size:16px;margin:0;font-weight:600}
 .srvTitle .accCount {
  font-weight: bold;
  font-style: italic;
  margin-left: 8px;
  color: #0070c9;
}
 .statusBar{display:flex;gap:8px;margin:6px 0 4px}
 .statusItem{display:flex;align-items:center;gap:4px;font-size:11px}
 .dot{width:10px;height:10px;border-radius:50%}
 .ok{background:#34c759}.fail{background:#ff3b30}.warn{background:#ff9f0a}
 .scr{width:100%;border-radius:8px;object-fit:cover;background:#0001;cursor:pointer}
 .updTime{font-size:10px;color:#8e8e93;margin-top:4px;text-align:right}
 .tagsRow{display:flex;gap:4px;margin:6px 0}
 .tag{font-size:11px;padding:2px 6px;border-radius:6px;background:#e5e5ea}
 .tag.payOver{background:#ff3b30;color:#fff}.tag.paySoon{background:#ff9f0a;color:#000}
 .tag.payMiss{background:#d1d1d6;color:#000}
 .payTbl{width:100%;table-layout:fixed;margin-top:4px;font-size:11px;border-collapse:collapse}
 .payTbl td{padding:1px 4px;border-bottom:1px solid #f0f0f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
 .payTbl th{position:relative}
 .resizer{position:absolute;right:0;top:0;bottom:0;width:5px;cursor:col-resize}

 .logBox{font-size:10px;background:#f7f7f7;border-radius:6px;padding:6px;height:90px;overflow:auto;white-space:pre-wrap}
 @keyframes spin{to{transform:rotate(360deg)}}
 #imgModal{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:9999}
 #imgModal img{max-width:80vw;max-height:80vh;border-radius:10px}

 /* settings modal (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
 .modal{position:fixed;inset:0;background:#0005;display:none;align-items:center;justify-content:center;z-index:9999}
 .modalBox{background:#fff;border-radius:12px;padding:16px;width:90%;max-width:700px;max-height:90vh;overflow:auto;display:flex;flex-direction:column}
 .modalBox h3{margin:0 0 8px}
 .field{margin-bottom:10px;font-size:13px}.field label{display:block;margin-bottom:3px;font-weight:600}.field input{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px}
 .serversTbl{width:100%;border-collapse:collapse;margin-top:6px;font-size:13px}
 .serversTbl th,.serversTbl td{border:1px solid #ddd;padding:4px 6px;text-align:left}
 .serversTbl th{background:#f7f7f7}
/*  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  –ú–û–ë–ò–õ–¨–ù–´–ô –®–ï–ô–ü  (<700 px)  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */
@media (max-width:700px){
    .grid{                         /* –∏–º–µ–Ω–Ω–æ –¥–≤–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
      grid-template-columns:repeat(2,minmax(0,1fr)) !important;
      gap:10px;padding:10px;
    }
    .card{padding:8px}
    .srvTitle{font-size:14px}
    .statusBar{flex-wrap:wrap}
    .statusItem{font-size:10px}
    .tag{font-size:10px;padding:1px 4px}
    .payTbl{font-size:10px}
    .logBox{height:70px}

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  –ù–û–í–û–ï  ‚Üì‚Üì‚Üì  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .header{
      grid-template-columns:1fr;           /* –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ */
      gap:8px;                             /* –Ω–µ–±–æ–ª—å—à–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
      text-align:center;
    }
    .header h2{
      font-size:16px;                      /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—å—à–µ */
      order:-1;                            /* –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤–≤–µ—Ä—Ö */
    }
    .header>div:first-child{
      display:flex;
      justify-content:center;
      flex-wrap:wrap;                      /* –∫–Ω–æ–ø–∫–∏ –∏ summary –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è */
      gap:6px 10px;
    }
    .btn{
      padding:4px 10px;                    /* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
      font-size:12px;
      min-width:10px;
    }
   
        /* —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö; –∏–∫–æ–Ω–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è */
    .btnTxt{display:none}

    /* —Å–∞–º–∏ –∫–Ω–æ–ø–∫–∏ –¥–µ–ª–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç–∞–º–∏ 36√ó36 px, —á—Ç–æ–±—ã –Ω–µ ¬´–¥–∞–≤–∏–ª–∏¬ª */
    .btn{
      padding:0;
      width:36px;height:36px;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;                 /* —Ä–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ */
    }

    /* —à–∞–ø–∫–∞: –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ (–∫–Ω–æ–ø–∫–∏ + summary + –∑–∞–≥–æ–ª–æ–≤–æ–∫) */
    .header{
      grid-template-columns:auto 1fr;          /* –ª–µ–≤—ã–π flex & –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
      column-gap:8px;
    }
    .header h2{
      font-size:14px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    #summary{font-size:10px;line-height:1;margin-left:0}

}

</style>
</head>
<body>
<div class="header">
  <div style="display:flex;gap:8px">
    <button class="btn" id="btnSettings">‚öô <span class="btnTxt">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
    <button class="btn" id="btnRefresh">‚ü≥ <span class="btnTxt">–û–±–Ω–æ–≤–∏—Ç—å</span></button>
    <table id="summary" style="margin-left:16px;font-size:12px;border-collapse:collapse">
      <tr><td>–ê–∫–∫–∞—É–Ω—Ç—ã</td><td id="sumAcc">‚Äî</td></tr>
      <tr><td>–î–æ—Ö–æ–¥, ‚ÇΩ</td><td id="sumInc">‚Äî</td></tr>
    </table>

  </div>
  <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤</h2>
  <div id="spin" style="width:26px;height:26px;border:3px solid #ccc;border-top-color:#0070c9;border-radius:50%;animation:spin 1s linear infinite;display:none"></div>
</div>


<div class="grid" id="grid"></div>

<div id="imgModal" onclick="this.style.display='none'"><img></div>

<!-- SETTINGS (–ø–æ–ª–Ω–∞—è —Ñ–æ—Ä–º–∞) -->
<div class="modal" id="modal">
  <div class="modalBox">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <div class="field"><label>–°–∫—Ä–∏–Ω—à–æ—Ç—ã, –ø–∞–ø–∫–∞</label><input id="inScreens"></div>
    <div style="display:flex;gap:10px">
      <div class="field" style="flex:1"><label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫)</label><input id="inInterval" type="number"></div>
      <div class="field" style="flex:1"><label>–¢–∞–π–º–∞—É—Ç offline (—Å–µ–∫)</label><input id="inOff" type="number"></div>
      <div class="field" style="flex:1"><label>Widget %</label><input id="inWidth" type="number"></div>
      <div class="field" style="flex:1">
        <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
        <input id="inFont" type="number">
</div>

    </div>
    <div class="field"><label>Tasks (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input id="inTasks"></div>
    <div style="display:flex;gap:10px">
      <div class="field" style="flex:1"><label>Telegram Token</label><input id="inTgTok"></div>
      <div class="field" style="flex:1"><label>Telegram Chat</label><input id="inTgChat"></div>
    </div>
    <h4>–°–µ—Ä–≤–µ—Ä—ã</h4>
    <table class="serversTbl" id="srvTable">
      <thead>
        <tr><th>Name</th><th>IP</th><th>URL</th><th>Mon URL</th><th>Logs</th><th>Œ£</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn" id="btnAddSrv">+ –°–µ—Ä–≤–µ—Ä</button>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="btnCancel">–û—Ç–º–µ–Ω–∞</button><button class="btn" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ- –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const spin = document.getElementById('spin');
const grid = document.getElementById('grid');
const imgModal = document.getElementById('imgModal');   // ‚ú® –±–µ–∑ –Ω–µ–≥–æ ReferenceError
function busy(on){ spin.style.display = on ? 'block' : 'none'; }

async function updateSummary(){
  const s = await (await fetch('/api/central/summary')).json();
  console.debug("[UI] summary", s);
  document.getElementById('sumAcc').textContent = s.accounts;
  document.getElementById('sumInc').textContent =
    `${s.total.toLocaleString('ru-RU')} / ${s.left.toLocaleString('ru-RU')}`;
}



function safeCols(){
  try{
    return JSON.parse(localStorage.getItem('pay_cols') || '[45,25,30]');
  }catch{
    localStorage.removeItem('pay_cols');
    return [45,25,30];
  }
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ applyPayWidths ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function applyPayWidths(tbl){
  const cols = safeCols();
  [...tbl.tHead.rows[0].cells].forEach((c,i)=>c.style.width = cols[i] + '%');
  [...tbl.tBodies[0].rows].forEach(r =>
      [...r.cells].forEach((c,i)=>c.style.width = cols[i] + '%'));
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ makeResizable ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function makeResizable(th,idx,tbl){
  const res = th.querySelector('.resizer');
  res.style.height = tbl.offsetHeight + 'px';
  res.onmousedown = e=>{
    const startX=e.pageX, startW=parseFloat(th.style.width)|| (safeCols()[idx]);
    const cols=safeCols();
    document.onmousemove = ev=>{
      const dx=ev.pageX-startX;
      cols[idx] = Math.min(80, Math.max(10, startW + dx/tbl.offsetWidth*100));
      localStorage.setItem('pay_cols', JSON.stringify(cols));
      applyPayWidths(tbl);
    };
    document.onmouseup = ()=> document.onmousemove=null;
  };
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –®–†–ò–§–¢–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(async ()=>{
  try{
    const cfg  = await (await fetch('/api/config')).json();
    const size = cfg.font_size || localStorage.fontSizePx || 14;
    document.documentElement.style.fontSize = size + 'px';
    localStorage.fontSizePx = size;
  }catch{
    document.documentElement.style.fontSize =
        (localStorage.fontSizePx || 14) + 'px';
  }
})();




/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ- —É—Ç–∏–ª–∏—Ç—ã —Å—Ç–∞—Ç—É—Å–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const colorRU = {"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞":"#ff3b30","–°–∫–æ—Ä–æ":"#ff9f0a","–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö":"#d1d1d6"};
function circle(state){
  return `<span class="dot ${
           state==null ? 'warn' : state ? 'ok' : 'fail'
         }"></span>`;
}
function statusItem(label, state){
  if (typeof state === 'number')
      return `<div class="statusItem">${state} ${label}</div>`;
  const colour = state==null ? 'warn' : state ? 'ok' : 'fail';
  return `<div class="statusItem"><span class="dot ${colour}"></span>${label}</div>`;
}



/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ- Pay-—Ç–∞–±–ª–∏—Ü–∞ + —Ä–µ—Å–∞–π–∑–µ—Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
/* --- –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ pay_cols ------------- */


function payTable(list){
  if(!list.length) return '';
  const head = ['–ê–∫–∫','–î–∞—Ç–∞','–°—Ç–∞—Ç—É—Å']
     .map((h,i)=>`<th><span class="resizer"></span>${h}</th>`).join('');
  const rows = list.map(p=>`
     <tr style="color:${colorRU[p.status]}">
       <td>${p.name}</td><td>${p.pay||'‚Äî'}</td><td>${p.status}</td></tr>`).join('');
  return `<table class="payTbl"><thead><tr>${head}</tr></thead><tbody>${rows}</tbody></table>`;
}
function crashList(arr, url){
  return arr.length
    ? `<div style="font-size:11px;margin-top:4px;color:#ff3b30">
         <a href="${url}/fix" target="_blank">${arr.join(', ')}</a>
       </div>`
    : '';
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ- –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function render(data){
  /* —Å–µ—Ç–∫–∞-–∫–æ–ª–æ–Ω–∫–∏: –¥–µ—Å–∫—Ç–æ–ø ‚Äì auto, –º–æ–±–∏–ª—å–Ω—ã–π ‚Äì —Ä–æ–≤–Ω–æ 2 */
  const isMobile = window.innerWidth <= 700;
  grid.style.gridTemplateColumns = isMobile
        ? 'repeat(2, minmax(0,1fr))'
        : `repeat(auto-fill, minmax(${data.widget_width}%, 1fr))`;
  grid.innerHTML = '';

  data.servers.forEach(s => {

    /* ---------- –∫–∞—Ä–∫–∞—Å –∫–∞—Ä—Ç–æ—á–∫–∏ ---------- */
    const card = document.createElement('div');
    card.className = 'card' + (s.loading ? ' mask' : '');
    card.innerHTML = `
      <h3 class="srvTitle">
        <a href="${s.url||'#'}" target="_blank">${s.name}</a>
        <span class="accCount">${s.accCount || 0}</span>
      </h3>

      <div class="statusBar">
      ${statusItem('ping',   s.ping)}
      ${statusItem('gn',     s.gnOk)}
      ${statusItem('dn',     s.dnOk)}
      ${statusItem('–æ–∫–Ω–∞',   s.dnCount)}

      ${Object.entries(s.scripts||{})          // ‚¨Ö –ù–û–í–û–ï
                 .map(([name,val])=>statusItem(name,val))
                 .join('')}

      ${Object.entries(s.tasks||{})
                 .map(([t,v])=>statusItem(t,v))
                 .join('')}

      </div>

      <img class="scr" src="${s.screenshot||''}">

      <div class="tagsRow">
        <span class="tag">${s.fixCount||''}</span>
        <span class="tag">${s.crashCount||''}</span>
        <span class="tag payOver">${s.payCounts?.overdue||0}</span>
        <span class="tag paySoon">${s.payCounts?.soon||0}</span>
        <span class="tag payMiss">${s.payCounts?.missing||0}</span>
      </div>

      ${payTable(s.payList||[])}
      ${crashList(s.crashList||[], s.url)}

      <div class="updTime">
        ‚è± ${new Date(s.updated_iso).toLocaleTimeString()}
      </div>


      <details style="margin-top:4px">
        <summary style="cursor:pointer;font-size:11px">üìÑ –ª–æ–≥–∏</summary>
        <div class="logBox">–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </details>
    `;

    /* ---------- —Å–∫—Ä–∏–Ω—à–æ—Ç: –ª–∞–π—Ç–±–æ–∫—Å ---------- */
    const img = card.querySelector('img.scr');
    if (img){
      img.onclick = () => {
        document.querySelector('#imgModal img').src = img.src.split('?')[0];
        imgModal.style.display = 'flex';
      };
    }

    /* ---------- Pay-—Ç–∞–±–ª–∏—Ü–∞: —à–∏—Ä–∏–Ω—ã + —Ä–µ—Å–∞–π–∑–µ—Ä ---------- */
    const tbl = card.querySelector('.payTbl');
    if (tbl){
      applyPayWidths(tbl);
      [...tbl.querySelectorAll('th')].forEach((th,i) => makeResizable(th,i,tbl));
    }

    /* ---------- lazy-–ª–æ–≥ ---------- */
    const det = card.querySelector('details');
    det?.addEventListener('toggle', async () => {
      if (det.open && !det.dataset.loaded){
        const box = det.querySelector('.logBox');
        box.innerHTML =
          '<div class="cardSpin" style="position:static;margin:20px auto"></div>';
        const d = await (await fetch(
          `/api/log_lazy?url=${encodeURIComponent(s.url)}&n=50`)).json();
        box.textContent = d.lines.join('\n');
        det.dataset.loaded = 1;          // –ø–æ–º–µ—Ç–∏–ª–∏: –ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω
      }
    });

    grid.appendChild(card);
  });
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function pollUntilReady(){
  const data = await (await fetch('/api/central/status')).json();
  console.debug("[UI] status poll ‚Äî", data.servers.filter(s=>!s.loading).length,"servers ready");
  render(data);
  if (data.servers.some(s => s.loading))
      setTimeout(pollUntilReady, 2000);
}


async function firstLoad(){
  busy(true);
  render(await (await fetch('/api/central/status')).json()); // —Å—Ä–∞–∑—É –º–∞—Å–∫–∏
  fetch('/api/central/refresh');     // –∑–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä, –Ω–æ –ù–ï –∂–¥—ë–º
  pollUntilReady();                  // –±—É–¥–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–∫–∞  –≤—Å—ë –Ω–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è
  updateSummary();
  busy(false);
}

firstLoad();  
/* –∞–¥–∞–ø—Ç–∏–≤: –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Ç–∫—É –ø—Ä–∏ —Å–º–µ–Ω–µ —à–∏—Ä–∏–Ω—ã –æ–∫–Ω–∞ */
/* –∞–¥–∞–ø—Ç–∏–≤: –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Ç–∫—É –ø—Ä–∏ —Å–º–µ–Ω–µ —à–∏—Ä–∏–Ω—ã –æ–∫–Ω–∞ */
/* –∞–¥–∞–ø—Ç–∏–≤: –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫–∏, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö */
window.addEventListener('resize', () => {
  const isMob = window.innerWidth <= 700;
  grid.style.gridTemplateColumns = isMob
      ? 'repeat(2, minmax(0,1fr))'
      : '';                          // –æ—á–∏—â–∞–µ–º inline-style ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç CSS
});


                                 // ‚¨Ö —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
setInterval(async () => {                      // ‚¨Ö –æ–±—â–∏–π —Ç–∞–π–º–µ—Ä
  render(await (await fetch('/api/central/status')).json());
}, 900000); // 15 –º–∏–Ω—É—Ç
updateSummary();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∫–Ω–æ–ø–∫–∞ ‚ü≥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function manualRefresh(){
  console.debug("[UI] Manual refresh started");
  busy(true);
  await fetch('/api/central/refresh');          // –∑–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä
  pollUntilReady();                             // –¥–æ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
  await updateSummary();
  busy(false);
  console.debug("[UI] Manual refresh done");
}
document.getElementById('btnRefresh').onclick = manualRefresh;


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ- SETTINGS (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π –±–ª–æ–∫) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const modal   = document.getElementById('modal');
const srvBody = document.querySelector('#srvTable tbody');
const cfgFields={inScreens:'screens_dir',inInterval:'check_interval',inOff:'offline_threshold',
                 inTasks:'tasks_to_check',inFont : 'font_size',inTgTok:'telegram_token',inTgChat:'telegram_chat',
                 inWidth:'widget_width'};
let CFG={};

document.getElementById('btnSettings').onclick=async()=>{
  CFG=await (await fetch('/api/config')).json();
  document.documentElement.style.fontSize =
  (CFG.font_size || localStorage.fontSizePx || 14) + 'px';
  for (const [inp, key] of Object.entries(cfgFields)) {
    document.getElementById(inp).value =
      Array.isArray(CFG[key]) ? CFG[key].join(',') : CFG[key];
}
  fillSrvTable(); modal.style.display='flex';
};

/* ------------------------------------------------------------
   fillSrvTable()
   –†–µ–Ω–¥–µ—Ä–∏—Ç —Ç–∞–±–ª–∏—Ü—É —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.
   ‚Ä¢ –ö–∞–∂–¥—ã–π <tr> –ø–æ–ª—É—á–∞–µ—Ç data-i="–∏–Ω–¥–µ–∫—Å", —á—Ç–æ–±—ã
     –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –∑–Ω–∞–ª –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–æ–∫–∏.
   ‚Ä¢ –í—Å–µ–º <input type="text"> –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω data-key
     ‚Äî –ø–æ –Ω–µ–º—É btnSave —Å–æ–±–∏—Ä–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è.
------------------------------------------------------------ */
function fillSrvTable () {
  srvBody.innerHTML = '';                           // –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë —Å—Ç–∞—Ä–æ–µ

  CFG.servers.forEach((s, i) => {                   // i ‚Äî —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
    srvBody.insertAdjacentHTML('beforeend', `
      <tr data-i="${i}">
        <td><input type="text" value="${s.name     || ''}" data-key="name"></td>
        <td><input type="text" value="${s.ip       || ''}" data-key="ip"></td>
        <td><input type="text" value="${s.url      || ''}" data-key="url"></td>
        <td><input type="text" value="${s.mon_url  || ''}" data-key="mon_url"></td>
        <td><input type="text" value="${s.log_path || ''}" data-key="log_path"></td>

        <!-- include_acc: —á–µ–∫–±–æ–∫—Å -->
        <td style="text-align:center">
          <input type="checkbox"
                 class="incBox"
                 ${s.include_acc !== false ? 'checked' : ''}>
        </td>

        <!-- —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–æ–º / —É–¥–∞–ª–µ–Ω–∏–µ -->
        <td style="white-space:nowrap">
          <button class="btn up">‚ñ≤</button>
          <button class="btn down">‚ñº</button>
          <button class="btn del">‚úñ</button>
        </td>
      </tr>
    `);
  });
}



srvBody.onclick = e => {
  // –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø—Ä—è–º–æ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –∏–ª–∏ —á–µ–∫–±–æ–∫—Å ‚îÄ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
  if (e.target.closest('input[type="text"]') ||
      e.target.classList.contains('incBox')) return;

  const tr  = e.target.closest('tr');
  if (!tr) return;
  const idx = +tr.dataset.i;

  let changed = false;                         // –±—É–¥–µ—Ç true, –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ–º/—É–¥–∞–ª—è–µ–º

  if (e.target.classList.contains('del')) {
      CFG.servers.splice(idx, 1);
      changed = true;
  } else if (e.target.classList.contains('up') && idx > 0) {
      [CFG.servers[idx - 1], CFG.servers[idx]] =
        [CFG.servers[idx], CFG.servers[idx - 1]];
      changed = true;
  } else if (e.target.classList.contains('down') &&
             idx < CFG.servers.length - 1) {
      [CFG.servers[idx + 1], CFG.servers[idx]] =
        [CFG.servers[idx], CFG.servers[idx + 1]];
      changed = true;
  }

  if (changed) fillSrvTable();                 // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
};


document.getElementById('btnAddSrv').onclick=()=>{
  CFG.servers.push({name:'', ip:'', url:'', mon_url:'', log_path:''});
  fillSrvTable();

};
document.getElementById('btnCancel').onclick=()=>modal.style.display='none';
modal.onclick=e=>{if(e.target===modal)modal.style.display='none';};

/* —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è */
document.getElementById('btnSave').onclick = async () => {
  /* --- –ø–ª–æ—Å–∫–∏–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã --- */
  for (const [inp, key] of Object.entries(cfgFields)) {
    const val = document.getElementById(inp).value.trim();
    CFG[key]  = (key === 'tasks_to_check')
      ? val.split(',').map(s => s.trim()).filter(Boolean)
      : (+val || val);                     // —á–∏—Å–ª–æ  –∏–ª–∏  —Å—Ç—Ä–æ–∫–∞
  }

  /* --- Pay-—à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ --- */
  CFG.pay_cols = JSON.parse(localStorage.getItem('pay_cols') || '[45,25,30]');
  
  /* --- —Ç–∞–±–ª–∏—Ü–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ --- */
  CFG.servers = [...srvBody.querySelectorAll('tr')].map(tr => {
    const txts = [...tr.querySelectorAll('input[type=text]')].map(x => x.value.trim());

    //     name     ip        url       mon_url   log_path
    const [name,   ip,       url,      mon_url,  log] = txts;

    const inc = tr.querySelector('.incBox').checked;
    return {name, ip, url, mon_url, log_path: log, include_acc: inc};
  }).filter(s => s.name && s.ip && s.url);   // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏


  /* --- –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ --- */
  localStorage.fontSizePx = CFG.font_size;                    // –∑–∞–ø–æ–º–Ω–∏—Ç—å
  document.documentElement.style.fontSize = CFG.font_size + 'px';

  /* --- –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥ --- */
  await fetch('/api/config', {
    method : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body   : JSON.stringify(CFG)
  });

  modal.style.display = 'none';
  firstLoad();                           // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
  
};

</script>
</body>
</html>
