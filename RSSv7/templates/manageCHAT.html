<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Управление {{ server_name }}</title>
  <style>
    :root{
      --bg:#F5F5F7; --fg:#1D1D1F; --card:#fff; --line:#E5E5E9;
      --brand:#0070C9; --ok:#34C759; --error:#FF3B30;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    .header{padding:16px;background:var(--card);border-bottom:1px solid var(--line);text-align:center;font-size:20px;font-weight:600}
    .toolbar{padding:8px 16px;background:var(--card);border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .btn{position:relative;background:var(--brand);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:14px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn .spinner{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:none}
    .btn.loading .spinner{display:block}
    @keyframes spin{0%{transform:translateY(-50%) rotate(0)}100%{transform:translateY(-50%) rotate(360deg)}}

    .container{display:flex;height:calc(100vh - 96px)}
    .sidebar{flex:0 0 200px;background:var(--card);border-right:1px solid var(--line);overflow:auto}
    .sidebar .account{padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
    .sidebar .account:hover{background:#F8F8FA}
    .sidebar .account.active{background:#E5F4FF}
    .sidebar .toggle{width:32px;height:16px;background:#E5E5EA;border-radius:8px;position:relative;transition:background .2s}
    .sidebar .toggle.on{background:var(--ok)}
    .sidebar .toggle::before{content:'';position:absolute;width:12px;height:12px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}
    .sidebar .toggle.on::before{transform:translateX(16px)}
    .resizer{width:4px;cursor:ew-resize;background:rgba(0,0,0,.08)}
    .pane{flex:1;display:flex}
    .tabs{flex:0 0 150px;background:var(--card);border-right:1px solid var(--line);overflow:auto}
    .tabs .tab{padding:10px;cursor:pointer;font-size:14px}
    .tab-row{display:flex;align-items:center;margin:4px 0;padding:0 6px}
    .tabs .tab:hover,.tabs .tab.selected{background:#F0F8FF;border-radius:8px}
    .switch{width:32px;height:16px;border-radius:8px;background:#CCC;position:relative;margin-right:8px;cursor:pointer;transition:background .2s;flex:0 0 auto}
    .switch.on{background:#4CD964}
    .switch::after{content:'';position:absolute;top:1px;left:1px;width:14px;height:14px;border-radius:50%;background:#fff;transition:transform .2s}
    .switch.on::after{transform:translateX(16px)}
    .timer-icon{cursor:pointer;margin-left:8px;font-size:16px;opacity:.6;transition:opacity .2s}
    .timer-icon:hover{opacity:1}
    .settings{flex:1;padding:16px;overflow:auto}
    .settings fieldset{margin-bottom:12px;border:1px solid var(--line);border-radius:6px;padding:12px}
    .settings legend{padding:0 6px;font-weight:600}
    .settings label{display:block;margin:6px 0;font-size:14px}
    .settings .k{font-weight:600;margin-right:6px}
    .settings select,.settings input[type=text]{width:100%;padding:6px;margin-top:4px;border:1px solid #CCC;border-radius:4px}
    .resizer-vert{width:4px;cursor:ew-resize;background:rgba(0,0,0,.08)}

    .tabs-header,.settings-header{position:sticky;top:0;z-index:1;background:#fff;border-bottom:1px solid #EAEAEA;padding:8px 10px;font-size:12px;color:#666}
    .tabs-header b,.settings-header b{color:#111}
    .settings-header .fn{margin-left:8px;color:#444}
    .save-hint{margin-left:10px;font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(52,199,89,.12);color:#2e7d32;opacity:0;transition:opacity .2s}
    .save-hint.show{opacity:1}
    .save-hint.error{background:rgba(255,59,48,.12);color:#a3160f}

    .templateBtn{display:inline-block;padding:4px 12px;font-size:13px;border:none;border-radius:20px;cursor:pointer;background:linear-gradient(135deg,#cc95ff 0%,#9367fa 100%);color:#fff;transition:opacity .2s;margin:0 6px 6px 0}
    .templateBtn:hover{opacity:.85}
    .templateBtn.Btn1100{background:linear-gradient(135deg,#a363f6 0%,#6e3bcd 100%)}
    .templateBtn.premBtn{background:linear-gradient(135deg,#8932fc 0%,#3d128e 100%)}
    .templateBtn.BtnTRAIN{background:linear-gradient(135deg,#04048a 0%,#3d128e 100%)}
    .templateBtn.BtnTRAIN2{background:linear-gradient(135deg,#010181 0%,#2d0b6c 100%)}

    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 16px;border-radius:20px;font-size:14px;opacity:0;animation:fadeIn .25s forwards}
    @keyframes fadeIn{to{opacity:1}} @keyframes fadeOut{to{opacity:0}}

    /* Copy modal */
    #copyOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9998}
    #copyModal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:9999;width:300px;max-height:70vh;overflow:auto}

    /* Page preloader */
    .page-loader{position:fixed;inset:0;background:rgba(255,255,255,.75);backdrop-filter:saturate(1.1) blur(2px);display:none;align-items:center;justify-content:center;z-index:2000}
    .page-loader .dot{width:10px;height:10px;border-radius:50%;background:#555;margin:0 4px;animation:dot .8s infinite alternate}
    .page-loader .dot:nth-child(2){animation-delay:.1s}
    .page-loader .dot:nth-child(3){animation-delay:.2s}
    @keyframes dot{from{opacity:.3;transform:scale(.8)}to{opacity:1;transform:scale(1)}}

    /* Mobile ≤640px */
    @media (max-width:640px){
      .container{display:block;height:auto}
      .resizer,.resizer-vert{display:none}
      .sidebar{flex:none;border-right:none;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5;background:#fff;max-height:40vh;overflow:auto}
      .pane{display:block}
      .tabs{flex:none;border-right:none;background:transparent;padding:10px 10px 0;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
      .tab-row{gap:6px;background:#fff;border:1px solid #EAEAEA;border-radius:10px;padding:8px;min-height:44px}
      .tabs .tab{flex:1 1 auto;padding:0;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      .switch{width:26px;height:14px;border-radius:7px;margin-right:4px}
      .switch::after{width:12px;height:12px;top:1px;left:1px}
      .switch.on::after{transform:translateX(12px)}
      .settings{padding:10px}
    }
  </style>
</head>
<body>
  <div class="header">Управление аккаунтами</div>

  <div class="toolbar">
    <button class="btn" onclick="goBack()">Назад</button>
    <button class="btn" id="sortBtn" onclick="cycleSortMode()">Сортировка</button>
    <button class="btn" id="rebootBtn" onclick="reboot(this)">Перезапуск<div class="spinner"></div></button>
    <button class="btn" id="copyBtn" onclick="openCopyModal()">Копировать<div class="spinner"></div></button>
    <button class="btn mobileOnly" id="toggleSidebarBtn">Аккаунты</button>
  </div>

  <div class="container">
    <div class="sidebar" id="sidebar"></div>
    <div class="resizer" id="resizer1" title="Изменить ширину"></div>
    <div class="pane">
      <div class="tabs" id="tabs"></div>
      <div class="resizer-vert" id="resizer2" title="Изменить ширину"></div>
      <div class="settings" id="settings"></div>
    </div>
  </div>

  <!-- copy modal -->
  <div id="copyOverlay"></div>
  <div id="copyModal">
    <h3 style="margin-top:0;font-size:18px;">Куда скопировать?</h3>
    <div id="copyTargets" style="max-height:45vh;overflow:auto;margin-bottom:12px;"></div>
    <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="closeCopyModal()">Отмена</button>
      <button class="btn" id="copyApplyBtn" onclick="doCopySettings(this)">Применить<div class="spinner"></div></button>
    </div>
  </div>

  <!-- page loader -->
  <div class="page-loader" id="pageLoader" aria-hidden="true">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>

  <script>
    /* ===== State ===== */
    let accounts = [], sortMode = 'status', selectedAcc = null,
        settingsData = [], menuData = null, selectedTab = null;

    const sidebar  = document.getElementById('sidebar');
    const tabs     = document.getElementById('tabs');
    const settings = document.getElementById('settings');
    const resizer1 = document.getElementById('resizer1');
    const resizer2 = document.getElementById('resizer2');
    const container= document.querySelector('.container');

    /* ===== Dictionaries ===== */
    const CONFIG_LABELS = {
      skip:"Пропуск", useResources:"Позволить боту использовать ресурсы из сумки",
      useSpeedUps:"Позволить боту использовать ускоры", marches:"Количество походов",
      ignoreSuicide:"Игнорировать предупреждение о тяжелой битве",
      redMission:"Проходить красные миссии (босс этот вонючий красный)",
      highestMission:"Самая высокая миссия", lowestMission:"Самая низкая миссия",
      fastestMission:"Самая быстрая миссия",
      LevelStartAt:"Уровень начала", Monster:"Атаковать монстров",
      Niflung:"Нифлунги", Divine:"Божественные",
      Farm:"Еда", Sawmill:"Дерево", Quarry:"Камень", Gold:"Золото",
      RallyTime:"Время митинга", reduceLevel:"Снижать уровень",
      farmLowestResource:"Копать ресурс, которого меньше всего на ферме",
      quest:"Квесты", recruit:"Рекрутмент", vip:"VIP", worker:"Рабочий", gems:"Самоцветы",
      errands:"Поручения", specialFarmer:"Спец-фермер", skipVoyageLushLand:"Пропуск «Lush Land»",
      events:"События", collectCrystals:"Сбор кристаллов",
      allianceGift:"Подарки альянса", allianceDonation:"Пожертвования альянсу",
      Attack:"Атака", Defense:"Защита", Gather:"Сбор", Workers:"Рабочие",
      Deception:"Обман", Trade:"Торговля", Patrol:"Патруль", useGems:"Тратить гемы",
      Infantry:"Пехота", Archer:"Лучники", Pikemen:"Копейщики", Porter:"Грузчики",
      Amount:"Количество тренируемых", UpgradeInfantry:"Апгрейд Пехоты",
      UpgradeArcher:"Апгрейд Лучников", UpgradePikemen:"Апгрейд Копейщиков",
      UpgradePorter:"Апгрейд Грузчиков",
      Upgrade:"Что улучшать", EagleNest:"Орлиное гнездо", Warehouse:"Склад",
      HallofValor:"Зал доблести", TribeHall:"Племенной зал", DivinationShack:"Гадальная хижина",
      Academy:"Академия", Watchtower:"Сторожевая башня", Infirmary:"Лазарет",
      SquadBase:"Штаб отрядов", VillageHall:"Ратуша поселения", Workshop:"Мастерская",
      Prison:"Тюрьма", DefenderCamp:"Лагерь защитников", SuppyHub:"Склад снабжения",
      Market:"Рынок", research:"Ветка исследований", upgrade:"Улучшаем исследования",
      SpeedUp:"Ускорения", Food:"Еда", Stones:"Камни", Gems:"Гемы", Lumber:"Дерево",
      ConstructionSpeed:"Скорость строительства", TrainExpansion:"Расширение обучения",
      ForgingSpeed:"Скорость ковки", ResearchSpeed:"Скорость исследований",
      TrainingSpeed:"Скорость тренировок", ForgingConsumption:"Расход ковки",
      HealingSpeed:"Скорость лечения", TrainingConsumption:"Расход тренировок",
      HealingConsumption:"Расход лечения"
    };

    const OPTION_LABELS = {
      worker:{Off:"Выкл",Common:"Обычный",Rare:"Редкий",Legend:"Легендарный",All:"Все"},
      Amount:{"100%":"100%","75%":"75%","50%":"50%","25%":"25%"},
      RallyTime:{"5min":"5 минут","10min":"10 минут","30min":"30 минут","8hours":"8 часов"},
      Upgrade:{MainHall:"Главное здание",Specfic:"Конкретное",Villages:"Посёлки"},
      research:{Economy:"Экономика",Military:"Армия"},
      allianceDonation:{Recommended:"Рекомендовано",Development:"Развитие",Territory:"Территория",War:"Война",Skills:"Навыки",Off:"Выкл"},
      "*":{Off:"Выкл",Any:"Любой",Auto:"Авто",on:"Вкл",off:"Выкл"}
    };

    const SCRIPT_LABELS = {
      'vikingbot.base.gathervip':'Сбор ресурсов',
      'vikingbot.base.dailies':'Ежедневные задания',
      'vikingbot.base.alliancedonation':'Техи и подарки племени',
      'vikingbot.base.mail':'Почта',
      'vikingbot.base.buffs':'Баффы',
      'vikingbot.base.recruitment':'Найм войск',
      'vikingbot.base.upgrade':'Стройка',
      'vikingbot.base.research':'Исследования',
      'vikingbot.base.divinationshack':'Хижина Гадалки',
      'vikingbot.base.exploration':'Экспедиции в поручениях (перья, яблоки)',
      'vikingbot.base.commission':'Выполнять поручения',
      'vikingbot.base.dragoncave':'Пещера дракона',
      'vikingbot.base.stagingpost':'Пост разгрузки',
      'vikingbot.base.build':'Строить новые здания (молоток)',
      'vikingbot.base.villages':'Сбор наград с орлов',
      'vikingbot.base.heal':'Лечение',
      'vikingbot.base.eaglenest':'Орлиное гнездо'
    };

    const ORDER_MAP = {
      'vikingbot.base.gathervip': [
        'Farm','Quarry','Sawmill','Gold','reduceLevel','farmLowestResource',
        'LevelStartAt','RallyTime','Monster','Niflung','marches','Divine'
      ],
      'vikingbot.base.dailies': [
        'quest','recruit','vip','gems','errands','worker','specialFarmer',
        'skipVoyageLushLand','events','collectCrystals'
      ],
      'vikingbot.base.alliancedonation': ['allianceGift','allianceDonation'],
      'vikingbot.base.buffs': ['Gather','Workers','Attack','Defense','Patrol','Trade','Deception','useGems'],
      'vikingbot.base.recruitment': [
        'Infantry','Archer','Pikemen','Porter','Amount',
        'UpgradeInfantry','UpgradeArcher','UpgradePikemen','UpgradePorter',
        'useResources','useSpeedUps'
      ],
      'vikingbot.base.upgrade': [
        'Upgrade','useResources','useSpeedUps',
        'TribeHall','VillageHall','MainHall',
        'EagleNest','Warehouse','HallofValor','DivinationShack','Academy',
        'Watchtower','Infirmary','SquadBase','Workshop','Prison','DefenderCamp',
        'SuppyHub','Market','Porter','Infantry','Archer','Pikemen'
      ],
      'vikingbot.base.research': ['research','upgrade','useResources','useSpeedUps'],
      'vikingbot.base.divinationshack': [
        'Gold','Gems','Food','Lumber','Stones',
        'SpeedUp','ConstructionSpeed','ResearchSpeed','TrainingSpeed','HealingSpeed',
        'ForgingSpeed','TrainExpansion',
        'ForgingConsumption','TrainingConsumption','HealingConsumption'
      ]
    };

    function getScriptTitle(id){ return SCRIPT_LABELS[id] || id; }
    function getConfigLabel(key){ return CONFIG_LABELS[key] || key; }
    function translateOption(key,val){
      const map = OPTION_LABELS[key] || {};
      return map[val] || OPTION_LABELS["*"][val] || val;
    }
    function getConfigOrder(scriptId, cfgKeys){
      const preferred = ORDER_MAP[scriptId] || [];
      const seen = new Set(preferred);
      const rest = cfgKeys.filter(k=>!seen.has(k)).sort((a,b)=>a.localeCompare(b,'ru'));
      return [...preferred.filter(k=>cfgKeys.includes(k)), ...rest];
    }

    /* ===== Page loader helpers ===== */
    const pageLoader = document.getElementById('pageLoader');
    let loaderCount = 0;
    function showPageLoader(show){
      if(show){ loaderCount++; pageLoader.style.display='flex'; }
      else{ loaderCount=Math.max(0,loaderCount-1); if(!loaderCount) pageLoader.style.display='none'; }
    }

    /* ===== Init ===== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      // restore widths
      const sbw = localStorage.getItem('manage_sidebar_width');
      if(sbw) sidebar.style.flex = `0 0 ${sbw}px`;
      const tbw = localStorage.getItem('manage_tabs_width');
      if(tbw) tabs.style.flex = `0 0 ${tbw}px`;

      // load accounts
      showPageLoader(true);
      try{
        const r = await fetch('/api/manage/accounts');
        accounts = await r.json();
        renderSidebar();
      }catch(e){
        showToast('Ошибка загрузки аккаунтов', true);
      }finally{
        showPageLoader(false);
      }
    });

    /* ===== Resizers ===== */
    let dragId = null;
    function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

    resizer1.addEventListener('pointerdown', e=>{ dragId='r1'; resizer1.setPointerCapture(e.pointerId); document.body.style.cursor='ew-resize'; document.body.style.userSelect='none';});
    resizer2.addEventListener('pointerdown', e=>{ dragId='r2'; resizer2.setPointerCapture(e.pointerId); document.body.style.cursor='ew-resize'; document.body.style.userSelect='none';});
    document.addEventListener('pointerup', ()=>{ dragId=null; document.body.style.cursor=''; document.body.style.userSelect=''; });

    document.addEventListener('pointermove', (e)=>{
      if(!dragId) return;
      if(dragId==='r1'){
        const rect = container.getBoundingClientRect();
        const w = clamp(e.clientX - rect.left, 160, rect.width-300);
        sidebar.style.flex = `0 0 ${w}px`;
        localStorage.setItem('manage_sidebar_width', String(w));
      }else if(dragId==='r2'){
        const tabsRect = tabs.getBoundingClientRect();
        const contRect = container.getBoundingClientRect();
        const w = clamp(e.clientX - tabsRect.left, 160, contRect.width-300);
        tabs.style.flex = `0 0 ${w}px`;
        localStorage.setItem('manage_tabs_width', String(w));
      }
    });

    document.getElementById('toggleSidebarBtn')?.addEventListener('click', ()=>{
      document.getElementById('sidebar')?.classList.toggle('open');
    });

    /* ===== Sidebar ===== */
    function getSortedAccounts(){
      const arr = [...accounts];
      if(sortMode==='status'){
        arr.sort((a,b)=> a.Active!==b.Active ? (a.Active?-1:1) : a.Name.localeCompare(b.Name,'ru'));
      }else if(sortMode==='alphaAsc'){
        arr.sort((a,b)=> a.Name.localeCompare(b.Name,'ru'));
      }else{
        arr.sort((a,b)=> b.Name.localeCompare(a.Name,'ru'));
      }
      return arr;
    }

    function renderSidebar(){
      sidebar.innerHTML = '';
      getSortedAccounts().forEach(acc=>{
        const d = document.createElement('div');
        d.className = 'account' + (selectedAcc?.Id===acc.Id ? ' active' : '');
        d.onclick = ()=> selectAccount(acc);

        d.innerHTML = `
          <span>${acc.Name}</span>
          <div class="toggle${acc.Active ? ' on' : ''}" title="Вкл/Выкл"></div>
        `;
        const toggle = d.querySelector('.toggle');
        toggle.addEventListener('click', async (e)=>{
          e.stopPropagation();
          const newVal = !acc.Active;
          toggle.classList.toggle('on', newVal);
          try{
            const res = await fetch(`/api/manage/account/${acc.Id}`,{
              method:'PUT', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ Active:newVal })
            });
            if(!res.ok) throw 0;
            acc.Active = newVal;
          }catch(_){
            toggle.classList.toggle('on', !newVal);
            showToast('Не удалось сохранить изменение', true);
          }
        });
        sidebar.appendChild(d);
      });
    }

    async function selectAccount(acc){
      selectedAcc = acc;
      renderSidebar();
      tabs.innerHTML = '';
      settings.innerHTML = '';
      showPageLoader(true);
      try{
        const res = await fetch(`/api/manage/account/${acc.Id}/settings`);
        const json = await res.json();
        settingsData = json.Data || [];
        menuData = json.MenuData || null;
        renderTabs();
        selectedTab = null;
      }catch(e){
        showToast('Не удалось загрузить настройки', true);
      }finally{
        showPageLoader(false);
      }
    }

    /* ===== Tabs & Template buttons ===== */
    function renderTabs(){
      tabs.innerHTML = '';

      const hdr = document.createElement('div');
      hdr.className = 'tabs-header';
      hdr.innerHTML = selectedAcc ? `@Аккаунт: <b>${selectedAcc.Name}</b> <span id="saveHint" class="save-hint"></span>` : `Выберите аккаунт`;
      tabs.appendChild(hdr);

      settingsData.forEach((step, i)=>{
        const row = document.createElement('div'); row.className='tab-row';

        const sw = document.createElement('div'); sw.className='switch'+(step.IsActive?' on':'');
        sw.onclick = async ()=>{
          const newVal = !step.IsActive;
          try{
            const res = await fetch(`/api/manage/account/${selectedAcc.Id}/settings/${i}`,{
              method:'PUT', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ IsActive:newVal })
            });
            if(!res.ok) throw 0;
            step.IsActive = newVal;
            renderTabs();
            if(selectedTab===i) renderSettings();
            showSavedHint('Сохранено');
          }catch(_){
            showToast('Не удалось сохранить', true);
          }
        };
        row.appendChild(sw);

        const t = document.createElement('div');
        t.className = 'tab'+(i===selectedTab?' selected':'');
        t.textContent = getScriptTitle(step.ScriptId);
        t.title = step.ScriptId;
        t.onclick = ()=>{ selectedTab=i; renderTabs(); renderSettings(); };
        row.appendChild(t);

        if(step.ScheduleRules && step.ScheduleRules.length){
          const ico = document.createElement('span');
          ico.className='timer-icon'; ico.textContent='⏰';
          ico.onclick = e=>{ e.stopPropagation(); showTimerEditor(i, ico); };
          row.appendChild(ico);
        }

        tabs.appendChild(row);
      });

      const tplBox = document.createElement('div'); tplBox.style.margin='12px 10px';
      const mkTplBtn = (title, cls, key)=> {
        const b = document.createElement('button');
        b.className = 'templateBtn '+(cls||'');
        b.textContent = title; b.title = 'Применить шаблон '+title;
        b.onclick = ()=> applyTemplate(key||title, b);
        return b;
      };
      tplBox.append(
        mkTplBtn('650', '', '650'),
        mkTplBtn('1100', 'Btn1100', '1100'),
        mkTplBtn('PREM', 'premBtn', 'PREM'),
        mkTplBtn('TRAIN', 'BtnTRAIN', 'TRAIN'),
        mkTplBtn('TRAIN2', 'BtnTRAIN2', 'TRAIN2'),
      );
      tabs.appendChild(tplBox);
    }

    /* ===== Settings (ordered) ===== */
    function renderSettings(){
      settings.innerHTML = '';
      if(selectedTab===null) return;

      const step = settingsData[selectedTab];
      const scriptTitle = getScriptTitle(step.ScriptId);

      const hdr = document.createElement('div');
      hdr.className = 'settings-header';
      hdr.innerHTML = selectedAcc ? `@Аккаунт: <b>${selectedAcc.Name}</b> <span class="fn">· Функция: <b>${scriptTitle}</b></span>` : `Выберите аккаунт и функцию`;
      settings.appendChild(hdr);

      const cfg = step.Config || {};
      const orderedKeys = getConfigOrder(step.ScriptId, Object.keys(cfg));

      orderedKeys.forEach((key)=>{
        const conf = cfg[key];
        const lbl = document.createElement('label');

        // boolean
        if(typeof conf === 'boolean'){
          lbl.innerHTML = `<input type="checkbox" id="f_${key}" ${conf?'checked':''}/> <span class="k">${getConfigLabel(key)}</span>`;
          const el = lbl.querySelector('input');
          el.addEventListener('change', e=>{
            autosaveUpdate(selectedTab, { [key]: e.target.checked });
          });
          el.addEventListener('blur', ()=> autosaveFlush(selectedTab));
          settings.appendChild(lbl);
          return;
        }

        // select
        if(conf && typeof conf==='object' && Array.isArray(conf.options)){
          const opts = conf.options.map(o=>{
            const txt = translateOption(key, o);
            return `<option value="${o}" ${o===conf.value?'selected':''}>${txt}</option>`;
          }).join('');
          lbl.innerHTML = `<span class="k">${getConfigLabel(key)}</span>: <select id="f_${key}">${opts}</select>`;
          const el = lbl.querySelector('select');
          el.addEventListener('change', e=>{
            autosaveUpdate(selectedTab, { [key]: e.target.value });
            autosaveFlush(selectedTab); // сразу сохраняем при смене select
          });
          el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') autosaveFlush(selectedTab); });
          settings.appendChild(lbl);
          return;
        }

        // text/number
        const val = conf ?? '';
        lbl.innerHTML = `<span class="k">${getConfigLabel(key)}</span>: <input type="text" id="f_${key}" value="${String(val)}" />`;
        const el = lbl.querySelector('input');

        el.addEventListener('input', e=>{
          const v = coerceValue(conf, e.target.value.trim());
          autosaveUpdate(selectedTab, { [key]: v });
        });
        // мгновенное сохранение
        el.addEventListener('blur', ()=> autosaveFlush(selectedTab));
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); el.blur(); }});
        settings.appendChild(lbl);
      });

      const btn = document.createElement('button');
      btn.textContent = 'Сохранить'; btn.className='btn';
      const sp = document.createElement('div'); sp.className='spinner'; btn.appendChild(sp);
      btn.onclick = ()=> saveSettings(btn);
      settings.appendChild(btn);
    }

    /* ===== Timer editor ===== */
    function showTimerEditor(stepIdx, anchorEl){
      document.querySelectorAll('.timer-popup').forEach(el=>el.remove());
      const step = settingsData[stepIdx]; const rules = step?.ScheduleRules || [];
      const pop = document.createElement('div'); pop.className='timer-popup';
      let html = `<h4>Расписание</h4>`;
      rules.forEach((r,ri)=>{
        const [days,start,end] = String(r.Val1||'mon|8:00 AM|10:00 AM').split('|');
        html += `
          <label>Дни (csv):<input type="text" id="tp_days_${ri}" value="${days||''}"></label>
          <label>С:<input type="time" id="tp_start_${ri}" value="${to24(start||'08:00 AM')}"></label>
          <label>До:<input type="time" id="tp_end_${ri}" value="${to24(end||'10:00 AM')}"></label>
          <hr>
        `;
      });
      html += `<button id="tp_save_btn">Сохранить</button> <button id="tp_cancel_btn">Отмена</button>`;
      pop.innerHTML = html;
      document.body.appendChild(pop);
      const rect = anchorEl.getBoundingClientRect();
      pop.style.position='fixed';
      pop.style.top = (rect.bottom + 6) + 'px';
      pop.style.left = rect.left + 'px';

      pop.querySelector('#tp_cancel_btn').onclick = ()=> pop.remove();
      pop.querySelector('#tp_save_btn').onclick = ()=> saveTimer(stepIdx, pop);
    }

    function to24(hm){ const d = new Date('1970-01-01 '+hm); const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${mm}`; }
    function to12(hm24){ let [h,m]=hm24.split(':').map(Number); const am=h<12; h=((h+11)%12)+1; return `${h}:${String(m).padStart(2,'0')} ${am?'AM':'PM'}`; }

    async function saveTimer(stepIdx, pop){
      const step = settingsData[stepIdx]; const rules = step?.ScheduleRules || [];
      const newRules = rules.map((r,ri)=>{
        const days = document.getElementById(`tp_days_${ri}`).value.trim();
        const start= document.getElementById(`tp_start_${ri}`).value;
        const end  = document.getElementById(`tp_end_${ri}`).value;
        return { ...r, Val1: `${days}|${to12(start)}|${to12(end)}` };
      });

      try{
        const res = await fetch(`/api/manage/account/${selectedAcc.Id}/settings/${stepIdx}`,{
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ScheduleRules:newRules })
        });
        if(!res.ok) throw 0;
        step.ScheduleRules = newRules;
        showToast('Расписание сохранено');
      }catch(_){
        showToast('Ошибка сохранения', true);
      }finally{
        pop?.remove();
      }
    }

    /* ===== Save mechanics ===== */
    function showToast(msg, isError=false){
      const t = document.createElement('div');
      t.className='toast'; t.textContent=msg;
      if(isError) t.style.background = 'var(--error)';
      document.body.appendChild(t);
      setTimeout(()=> t.style.animation='fadeOut .25s forwards', 2000);
      setTimeout(()=> t.remove(), 2300);
    }
    function showSavedHint(text='Сохранено', isError=false){
      const el = document.getElementById('saveHint'); if(!el) return;
      el.textContent = text; el.classList.toggle('error', !!isError);
      el.classList.add('show'); clearTimeout(el._t);
      el._t = setTimeout(()=> el.classList.remove('show'), 1200);
    }

    const autosaveQueue = new Map(); // key = `${accId}:${stepIdx}` -> {data,timer,flushInFlight}
    function autosaveUpdate(stepIdx, patch){
      if(!selectedAcc) return;
      const key = `${selectedAcc.Id}:${stepIdx}`;
      let entry = autosaveQueue.get(key);
      if(!entry) entry = { data:{}, timer:null, flushing:false };
      Object.assign(entry.data, patch);
      clearTimeout(entry.timer);
      entry.timer = setTimeout(()=> autosaveFlush(stepIdx), 500);
      autosaveQueue.set(key, entry);
    }

    async function autosaveFlush(stepIdx){
      if(!selectedAcc) return;
      const key = `${selectedAcc.Id}:${stepIdx}`;
      const entry = autosaveQueue.get(key);
      if(!entry || entry.flushing || Object.keys(entry.data).length===0) return;

      entry.flushing = true;
      const payload = {...entry.data};
      // reset before request; if fails — we’ll mark error but not re-merge
      entry.data = {};
      clearTimeout(entry.timer);

      try{
        const res = await fetch(`/api/manage/account/${selectedAcc.Id}/settings/${stepIdx}`,{
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ Config: payload })
        });
        if(!res.ok) throw 0;

        // optimistic local update
        const cfg = settingsData[stepIdx].Config;
        Object.entries(payload).forEach(([k,v])=>{
          const c = cfg[k];
          if(c && typeof c==='object' && Array.isArray(c.options)) cfg[k].value = v;
          else cfg[k] = v;
        });
        showSavedHint('Сохранено');
      }catch(_){
        showSavedHint('Ошибка', true);
      }finally{
        entry.flushing = false;
        // if user typed again while flushing, schedule next flush quickly
        if(Object.keys(entry.data).length>0){
          clearTimeout(entry.timer);
          entry.timer = setTimeout(()=> autosaveFlush(stepIdx), 150);
        }
      }
    }

    async function saveSettings(btn){
      if(!selectedAcc || selectedTab===null) return;
      btn.classList.add('loading'); btn.disabled = true;

      const cfg = settingsData[selectedTab].Config;
      const updates = {};
      for(const [key,conf] of Object.entries(cfg)){
        const el = document.getElementById(`f_${key}`); if(!el) continue;
        if(el.type==='checkbox'){ updates[key] = el.checked; continue; }
        if(el.tagName==='SELECT'){ updates[key] = el.value; continue; }
        if(typeof conf === 'number'){
          const n = Number(el.value.replace(',','.'));
          updates[key] = Number.isFinite(n) ? n : conf;
        }else{
          updates[key] = el.value.trim();
        }
      }

      try{
        const res = await fetch(`/api/manage/account/${selectedAcc.Id}/settings/${selectedTab}`,{
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ Config: updates })
        });
        if(!res.ok) throw 0;
        showToast('Настройки сохранены');
        await selectAccount(selectedAcc);
      }catch(_){
        showToast('Ошибка сохранения', true);
      }finally{
        btn.classList.remove('loading'); btn.disabled = false;
      }
    }

    function coerceValue(originalConf, raw){
      if(typeof originalConf==='number'){
        const n = Number(String(raw).replace(',','.'));
        return Number.isFinite(n) ? n : originalConf;
      }
      return raw;
    }

    /* ===== Templates / Copy / Reboot ===== */
    async function applyTemplate(name, btn){
      if(!selectedAcc) return;
      btn.disabled = true; const old = btn.textContent; btn.textContent='…';
      showPageLoader(true);
      try{
        const r = await fetch(`/api/manage/account/${selectedAcc.Id}/apply_template`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ template:name })
        });
        if(!r.ok) throw 0;
        showToast(`Шаблон ${name} применён`);
        await selectAccount(selectedAcc);
      }catch(_){
        showToast('Ошибка применения шаблона', true);
      }finally{
        btn.textContent=old; btn.disabled=false; showPageLoader(false);
      }
    }

    const copyOverlay = document.getElementById('copyOverlay');
    const copyModal   = document.getElementById('copyModal');
    const copyTargets = document.getElementById('copyTargets');

    function openCopyModal(){
      if(!selectedAcc){ showToast('Сначала выберите источник'); return; }
      copyTargets.innerHTML = '';
      accounts.filter(a=>a.Id!==selectedAcc.Id).sort((a,b)=>a.Name.localeCompare(b.Name,'ru')).forEach(acc=>{
        const lbl = document.createElement('label'); lbl.style.display='block';
        lbl.innerHTML = `<input type="checkbox" value="${acc.Id}"> ${acc.Name}`;
        copyTargets.appendChild(lbl);
      });
      copyOverlay.style.display = copyModal.style.display = 'block';
    }
    function closeCopyModal(){ copyOverlay.style.display = copyModal.style.display = 'none'; }

    async function doCopySettings(btn){
      const ids = Array.from(copyTargets.querySelectorAll('input:checked')).map(i=>i.value);
      if(!ids.length){ showToast('Не выбраны цели'); return; }
      btn.disabled = true; btn.classList.add('loading');
      showPageLoader(true);
      try{
        const res = await fetch('/api/manage/copy_settings',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ source_id:selectedAcc.Id, dest_ids:ids })
        });
        if(!res.ok) throw 0;
        showToast('Копирование завершено');
        closeCopyModal();
      }catch(_){
        showToast('Ошибка копирования', true);
      }finally{
        btn.classList.remove('loading'); btn.disabled=false; showPageLoader(false);
      }
    }

    function goBack(){ location.href = '/'; }

    async function reboot(btn){
      btn.classList.add('loading'); btn.disabled = true;
      showPageLoader(true);
      try{
        await fetch('/api/reboot',{method:'POST'});
        showToast('Перезапуск выполнен');
      }catch(_){
        showToast('Ошибка перезапуска', true);
      }finally{
        btn.classList.remove('loading'); btn.disabled = false; showPageLoader(false);
      }
    }

    /* ===== Sorting ===== */
    function cycleSortMode(){
      sortMode = (sortMode==='status')?'alphaAsc':(sortMode==='alphaAsc')?'alphaDesc':'status';
      const btn = document.getElementById('sortBtn');
      btn.textContent = sortMode==='status'?'Активные↑':sortMode==='alphaAsc'?'A-Z':'Z-A';
      renderSidebar();
    }
  </script>
</body>
</html>
