<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Редактор шаблонов {{ server_name }}</title>
  <style>
    :root { --blue:#0070C9; --line:#E5E5E9; --bg:#F5F5F7; --text:#1D1D1F; }
    * { box-sizing: border-box; }
    body { margin:0; padding:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; }
    .header { padding:16px; background:#fff; border-bottom:1px solid var(--line);
      text-align:center; font-size:20px; font-weight:600; }
    .toolbar { padding:8px 16px; background:#fff; border-bottom:1px solid var(--line);
      display:flex; gap:8px; flex-wrap:wrap; }
    .btn { position:relative; background:var(--blue); color:#fff; border:none;
      border-radius:6px; padding:6px 12px; cursor:pointer; font-size:14px; }
    .btn.danger { background:#d9363e; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn .spinner { position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:14px; height:14px; border:2px solid rgba(255,255,255,0.3);
      border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite;
      display:none; }
    .btn.loading .spinner { display:block; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .container { display:flex; gap:12px; padding:12px; height:calc(100vh - 112px);
      overflow:hidden; }
    .panel { background:#fff; border:1px solid var(--line); border-radius:10px;
      padding:12px; flex:1; display:flex; flex-direction:column; min-height:0; }
    .panel h3 { margin:0 0 10px; font-size:16px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 10px; text-align:left; border-bottom:1px solid var(--line);
      font-size:14px; }
    tr.hoverable { cursor:pointer; }
    tr.selected { background:#e5f4ff; }
    .steps { border:1px solid var(--line); border-radius:8px; overflow:auto; flex:1; }
    .steps table tr.selected td { background:#e5f4ff; }
    .editor { margin-top:12px; display:flex; flex-direction:column; }
    .editor label { font-size:13px; margin-bottom:6px; color:#444; }
    .editor textarea { width:100%; min-height:220px; resize:vertical;
      padding:10px; font-family:SFMono-Regular,Consolas,Menlo,monospace;
      border:1px solid var(--line); border-radius:8px; font-size:13px; }
    .status { font-size:13px; color:#666; margin-top:6px; }
    .name-editor { margin:8px 0 12px; }
    .name-editor label { font-size:12px; color:#555; display:block; margin-bottom:6px; }
    .name-row { display:flex; gap:8px; }
    .name-row input { flex:1; padding:6px 8px; border:1px solid var(--line); border-radius:6px; font-size:14px; }
    .alias-line { font-size:12px; color:#666; margin-top:6px; }
    .muted { color:#7a7a7a; font-size:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:12px; background:#eef3ff; color:#2053b6; font-size:12px; margin-left:4px; }
    .step-actions { display:flex; gap:8px; align-items:center; margin:10px 0; flex-wrap:wrap; }
    .step-actions input { padding:6px 8px; border:1px solid var(--line); border-radius:6px; font-size:14px; min-width:200px; }
    .config-panel { margin-top:12px; border:1px solid var(--line); border-radius:8px; padding:10px; }
    .config-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .config-head h4 { margin:0; font-size:14px; }
    .config-fields { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .config-row { display:flex; flex-direction:column; gap:4px; padding:8px; border:1px solid #f0f0f0; border-radius:8px; background:#fafbff; }
    .config-row label { font-size:13px; color:#333; }
    .config-row select, .config-row input[type=text], .config-row input[type=number] { padding:6px 8px; border:1px solid var(--line); border-radius:6px; font-size:13px; }
    .config-row input[type=checkbox] { width:16px; height:16px; }
    .config-row.missing { border:1px dashed #d9363e; background:#fff5f5; }
    .config-row .missing-label { color:#d9363e; font-weight:600; }
    .config-row .missing-hint { color:#d9363e; font-size:12px; }
    .empty { color:#888; font-size:14px; padding:6px 0; }
    #toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:10px;
      font-size:14px; opacity:0; pointer-events:none; transition:opacity .2s; }
    #toast.show { opacity:1; }
    @media (max-width: 900px) {
      .container { flex-direction:column; height:auto; }
    }
  </style>
</head>
<body>
  <div class="header">Редактор шаблонов {{ server_name }}</div>
  <div class="toolbar">
    <button class="btn" onclick="goBack()">Назад</button>
    <button class="btn" id="createBtn" onclick="createTemplate()">Создать<div class="spinner"></div></button>
    <button class="btn" id="saveBtn" onclick="saveStep()" disabled>Сохранить<div class="spinner"></div></button>
    <button class="btn danger" id="deleteBtn" onclick="deleteTemplate()" disabled>Удалить<div class="spinner"></div></button>
  </div>
  <div class="container">
    <div class="panel" style="flex:0 0 320px;">
      <h3>Шаблоны</h3>
      <div class="steps" style="flex:1;">
        <table>
          <thead>
            <tr><th>Файл</th><th style="width:80px;">Шаги</th></tr>
          </thead>
          <tbody id="templatesBody"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px;">Включены встроенные схемы 650, 1100, TRAIN и др.</div>
    </div>
    <div class="panel" style="flex:1.5;">
      <div class="name-editor">
        <label for="templateNameInput">Имя файла</label>
        <div class="name-row">
          <input id="templateNameInput" placeholder="example.json" />
          <button class="btn" id="renameBtn" onclick="renameTemplate()" disabled>Переименовать<div class="spinner"></div></button>
        </div>
        <div class="alias-line" id="aliasLine">Алиасы: —</div>
      </div>

      <div class="step-actions">
        <div style="display:flex; flex-direction:column; gap:4px;">
          <label class="muted" for="scriptIdInput">ScriptId из схемы</label>
          <input id="scriptIdInput" list="scriptList" placeholder="vikingbot.base.gathervip" />
        </div>
        <button class="btn" onclick="addStepFromSchema()">Шаг по схеме</button>
        <button class="btn" onclick="addEmptyStep()">Пустой шаг</button>
      </div>
      <datalist id="scriptList"></datalist>

      <div class="steps">
        <table>
          <thead>
            <tr><th style="width:80px;">#</th><th>Описание</th></tr>
          </thead>
          <tbody id="stepsBody"></tbody>
        </table>
      </div>

      <div class="editor">
        <label for="stepEditor">JSON шага</label>
        <textarea id="stepEditor" placeholder="Выберите шаг слева или добавьте новый, вставив JSON"></textarea>
        <div class="status" id="editorStatus">Нет выбранного шаблона</div>
      </div>

      <div class="config-panel">
        <div class="config-head">
          <h4>Поля шага</h4>
          <button class="btn" id="addKeyBtn" onclick="addConfigKey()" disabled>+ Ключ</button>
        </div>
        <div class="config-fields" id="configFields"></div>
      </div>
    </div>
  </div>
  <div id="toast"></div>
  <script>
    const state = {
      templates: [],
      current: null,
      steps: [],
      selectedStep: -1,
      aliases: {},
      schema: {},
      currentAliases: [],
      highlight: null,
    };

    function goBack(){ location.href = '/manage'; }

    function showToast(msg, isError=false){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.background = isError ? 'rgba(217,54,62,0.9)' : 'rgba(0,0,0,0.8)';
      el.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=> el.classList.remove('show'), 2400);
    }

    function setLoading(btnId, loading){
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.classList.toggle('loading', loading);
      btn.disabled = loading;
    }

    function canonicalName(name){
      if (!name) return '';
      return name.toLowerCase().endsWith('.json') ? name : `${name}.json`;
    }

    function aliasesFor(name){
      const aliases = state.aliases || {};
      const canon = canonicalName(name);
      const list = [];
      Object.entries(aliases).forEach(([k, v]) => {
        if (canonicalName(v) === canon) list.push(k);
      });
      return list;
    }

    function updateAliasLine(extra){
      const el = document.getElementById('aliasLine');
      if (!el) return;
      if (extra) state.aliases = extra;
      const list = state.current ? aliasesFor(state.current) : [];
      state.currentAliases = list;
      el.textContent = list.length ? `Алиасы: ${list.join(', ')}` : 'Алиасы: —';
    }

    function updateButtons(){
      const hasTemplate = Boolean(state.current);
      document.getElementById('saveBtn').disabled = !hasTemplate;
      document.getElementById('deleteBtn').disabled = !hasTemplate;
      document.getElementById('renameBtn').disabled = !hasTemplate;
      document.getElementById('addKeyBtn').disabled = state.selectedStep < 0;
    }

    function renderTemplates(){
      const body = document.getElementById('templatesBody');
      body.innerHTML = '';
      if (!state.templates.length){
        body.innerHTML = '<tr><td colspan="2" class="empty">Нет шаблонов</td></tr>';
        return;
      }
      state.templates.forEach(tpl => {
        const tr = document.createElement('tr');
        tr.className = 'hoverable' + (tpl.name === state.current ? ' selected' : '');
        const aliasBadges = (tpl.aliases || []).map(a => `<span class="badge">${a}</span>`).join('');
        const title = tpl.label && tpl.label !== tpl.name ? `${tpl.label} <span class="muted">(${tpl.name})</span>` : tpl.name;
        tr.innerHTML = `<td>${title} ${aliasBadges}</td><td>${tpl.steps_count ?? ''}</td>`;
        tr.onclick = () => openTemplate(tpl.name);
        body.appendChild(tr);
      });
    }

    function syncEditorWithStep(){
      const area = document.getElementById('stepEditor');
      if (state.selectedStep >= 0 && state.selectedStep < state.steps.length){
        const step = state.steps[state.selectedStep];
        area.value = JSON.stringify(step, null, 2);
        document.getElementById('editorStatus').textContent = `Редактирование шага ${state.selectedStep + 1}`;
      } else {
        area.value = '';
        document.getElementById('editorStatus').textContent = 'Выберите шаг для редактирования';
      }
    }

    function renderSteps(){
      const body = document.getElementById('stepsBody');
      body.innerHTML = '';
      if (!state.steps.length){
        body.innerHTML = '<tr><td colspan="2" class="empty">Нет шагов</td></tr>';
        syncEditorWithStep();
        renderConfigFields();
        updateButtons();
        return;
      }

      state.steps.forEach((step, idx) => {
        const title = step?.ScriptId || step?.Name || step?.Script || step?.Action || 'Шаг';
        const desc = step?.Uid ? `${title} — ${step.Uid}` : title;
        const tr = document.createElement('tr');
        const selected = idx === state.selectedStep;
        tr.className = 'hoverable' + (selected ? ' selected' : '');
        tr.innerHTML = `<td>${idx + 1}</td><td>${desc}</td>`;
        tr.onclick = () => selectStep(idx);
        body.appendChild(tr);
      });

      syncEditorWithStep();
      renderConfigFields();
      updateButtons();
    }

    function renderConfigFields(){
      const box = document.getElementById('configFields');
      if (!box) return;
      box.innerHTML = '';
      if (state.selectedStep < 0 || state.selectedStep >= state.steps.length){
        box.innerHTML = '<div class="empty">Выберите шаг, чтобы увидеть ключи</div>';
        return;
      }

      const step = state.steps[state.selectedStep] || {};
      const cfg = (step.Config && typeof step.Config === 'object') ? { ...step.Config } : {};
      const scripts = state.schema || {};
      const script = scripts[step.ScriptId] || {};
      const shape = script.Shape || script.fields || {};
      const defaults = script.Defaults || script.defaults || {};
      const keys = Array.from(new Set([...Object.keys(shape), ...Object.keys(cfg)]));
      const highlight = state.highlight;
      const highlightActive = highlight && (!highlight.scriptId || highlight.scriptId === step.ScriptId);
      const missingKey = highlightActive ? highlight.key : null;

      if (!keys.length){
        box.innerHTML = '<div class="empty">Добавьте ключи в конфиг</div>';
        return;
      }

      keys.forEach(key => {
        const row = document.createElement('div');
        row.className = 'config-row' + (missingKey === key ? ' missing' : '');
        const form = shape[key] || {};
        const current = cfg[key];
        const label = document.createElement('label');
        label.textContent = key;
        row.appendChild(label);

        const type = form.type || (typeof current === 'boolean' ? 'bool' : 'text');
        let control;

        if (type === 'select'){
          control = document.createElement('select');
          const options = form.options || (current && current.options) || defaults[key]?.options || [];
          options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt;
            control.appendChild(o);
          });
          const value = (current && typeof current === 'object' && 'value' in current)
            ? current.value
            : (defaults[key]?.value ?? '');
          control.value = value ?? '';
          control.onchange = (ev) => updateConfigValue(key, { value: ev.target.value, options });
        } else if (type === 'bool'){
          control = document.createElement('input');
          control.type = 'checkbox';
          control.checked = Boolean(current);
          control.onchange = (ev) => updateConfigValue(key, ev.target.checked);
        } else if (type === 'number'){
          control = document.createElement('input');
          control.type = 'number';
          control.value = current ?? defaults[key] ?? 0;
          control.oninput = (ev) => updateConfigValue(key, Number(ev.target.value));
        } else {
          control = document.createElement('input');
          control.type = 'text';
          const value = (current && typeof current === 'object' && 'value' in current)
            ? current.value
            : (current ?? defaults[key] ?? '');
          control.value = value;
          control.oninput = (ev) => updateConfigValue(key, ev.target.value);
        }

        row.appendChild(control);
        box.appendChild(row);
      });

      if (missingKey && !(missingKey in cfg)) {
        const row = document.createElement('div');
        row.className = 'config-row missing';

        const label = document.createElement('label');
        label.className = 'missing-label';
        label.textContent = missingKey;
        row.appendChild(label);

        const hint = document.createElement('div');
        hint.className = 'missing-hint';
        hint.textContent = 'Ключ отсутствует в шаблоне, добавьте его по схеме';
        row.appendChild(hint);

        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'Добавить ключ';
        btn.onclick = () => {
          step.Config = step.Config || {};
          step.Config[missingKey] = '';
          renderConfigFields();
          syncEditorWithStep();
        };
        row.appendChild(btn);

        box.appendChild(row);
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function updateConfigValue(key, value){
      if (state.selectedStep < 0 || state.selectedStep >= state.steps.length) return;
      const step = state.steps[state.selectedStep];
      if (!step.Config || typeof step.Config !== 'object') step.Config = {};
      step.Config[key] = value;
      syncEditorWithStep();
    }

    function selectStep(idx){
      state.selectedStep = idx;
      renderSteps();
    }

    async function loadTemplates(){
      const res = await fetch('/api/templates/list');
      const data = await res.json();
      state.aliases = data.aliases || {};
      const templates = (data.templates || []).map(item => ({
        name: item.name,
        label: item.label || item.name,
        steps_count: item.steps_count ?? null,
        aliases: item.aliases && item.aliases.length ? item.aliases : aliasesFor(item.name),
      }));
      state.templates = templates;
      renderTemplates();
    }

    async function loadSchema(){
      try {
        const res = await fetch('/api/schema/get');
        const data = await res.json();
        const scripts = data?.schema?.Scripts || data.Scripts || data;
        if (scripts && typeof scripts === 'object'){
          state.schema = scripts;
          renderScriptOptions();
        }
      } catch (e){
        console.error(e);
      }
    }

    function renderScriptOptions(){
      const list = document.getElementById('scriptList');
      if (!list) return;
      list.innerHTML = '';
      Object.keys(state.schema || {}).sort().forEach(sid => {
        const opt = document.createElement('option');
        opt.value = sid;
        list.appendChild(opt);
      });
    }

    async function openTemplate(name){
      setLoading('saveBtn', true);
      try {
        const res = await fetch(`/api/templates/${encodeURIComponent(name)}`);
        if (!res.ok){
          showToast('Не удалось загрузить шаблон', true);
          return;
        }
        const data = await res.json();
        state.current = data.name;
        state.steps = Array.isArray(data.steps) ? data.steps : [];
        state.selectedStep = state.steps.length ? 0 : -1;
        state.currentAliases = data.aliases || aliasesFor(data.name);
        state.highlight = null;
        state.templates = state.templates.map(tpl =>
          tpl.name === data.name ? { ...tpl, steps_count: data.steps_count, aliases: tpl.aliases?.length ? tpl.aliases : data.aliases } : tpl
        );
        document.getElementById('templateNameInput').value = data.name;
        updateAliasLine();
        renderTemplates();
        renderSteps();
        updateButtons();
      } catch (e){
        console.error(e);
        showToast('Ошибка загрузки шаблона', true);
      } finally {
        setLoading('saveBtn', false);
      }
    }

    async function createTemplate(){
      const name = (prompt('Введите имя файла (без .json):') || '').trim();
      if (!name) return;
      setLoading('createBtn', true);
      try {
        const res = await fetch(`/api/templates/${encodeURIComponent(name)}`, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ steps: [] })
        });
        if (!res.ok){
          showToast('Не удалось создать шаблон', true);
          return;
        }
        await loadTemplates();
        const safeName = name.endsWith('.json') ? name : `${name}.json`;
        await openTemplate(safeName);
        showToast('Шаблон создан');
      } catch (e){
        console.error(e);
        showToast('Ошибка создания', true);
      } finally {
        setLoading('createBtn', false);
      }
    }

    async function renameTemplate(){
      if (!state.current){
        showToast('Сначала выберите шаблон', true);
        return;
      }
      const input = document.getElementById('templateNameInput');
      const newName = (input.value || '').trim();
      if (!newName || newName === state.current){
        showToast('Укажите новое имя файла', true);
        return;
      }
      setLoading('renameBtn', true);
      try {
        const res = await fetch(`/api/templates/${encodeURIComponent(state.current)}/rename`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ new_name: newName })
        });
        if (!res.ok){
          showToast('Не удалось переименовать', true);
          return;
        }
        const data = await res.json();
        state.aliases = data.aliases || state.aliases;
        await loadTemplates();
        state.current = data.name;
        input.value = data.name;
        updateAliasLine(data.aliases);
        await openTemplate(data.name);
        showToast('Имя обновлено');
      } catch (e){
        console.error(e);
        showToast('Ошибка при переименовании', true);
      } finally {
        setLoading('renameBtn', false);
      }
    }

    async function saveTemplate(name, steps){
      const res = await fetch(`/api/templates/${encodeURIComponent(name)}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ steps })
      });
      if (!res.ok) throw new Error('save failed');
      const data = await res.json();
      state.templates = state.templates.map(tpl =>
        tpl.name === data.name ? { ...tpl, steps_count: data.steps_count } : tpl
      );
    }

    async function saveStep(){
      if (!state.current){
        showToast('Сначала выберите шаблон', true);
        return;
      }
      const raw = document.getElementById('stepEditor').value.trim();
      if (!raw){
        showToast('Вставьте JSON шага', true);
        return;
      }
      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e){
        showToast('Некорректный JSON', true);
        return;
      }
      if (typeof parsed !== 'object' || parsed === null){
        showToast('JSON шага должен быть объектом или массивом', true);
        return;
      }
      const steps = [...state.steps];
      const idx = state.selectedStep;
      if (idx >= 0 && idx < steps.length){
        steps[idx] = parsed;
      } else {
        steps.push(parsed);
        state.selectedStep = steps.length - 1;
      }
      setLoading('saveBtn', true);
      try {
        await saveTemplate(state.current, steps);
        state.steps = steps;
        renderTemplates();
        renderSteps();
        showToast('Сохранено');
      } catch (e){
        console.error(e);
        showToast('Не удалось сохранить', true);
      } finally {
        setLoading('saveBtn', false);
      }
    }

    function addEmptyStep(){
      if (!state.current){
        showToast('Выберите шаблон', true);
        return;
      }
      const baseId = state.steps.length;
      const fresh = {
        ScriptId: '',
        Uid: `custom_${Date.now()}`,
        OrderId: baseId,
        Config: {},
        Id: baseId,
        IsActive: true,
        IsCopy: true,
        ScheduleData: { Active: false, Last: '0001-01-01T00:00:00', Daily: false, Hourly: false, Weekly: false },
        ScheduleRules: [],
      };
      state.steps = [...state.steps, fresh];
      state.selectedStep = state.steps.length - 1;
      renderSteps();
      showToast('Добавлен пустой шаг');
    }

    function buildStepFromSchema(scriptId){
      const scripts = state.schema || {};
      const spec = scripts[scriptId] || {};
      const shape = spec.Shape || spec.fields || {};
      const defaults = spec.Defaults || spec.defaults || {};
      const config = {};

      Object.keys(shape).forEach(key => {
        const form = shape[key] || {};
        const def = defaults[key];
        if (form.type === 'select'){
          const opts = form.options || (def && def.options) || [];
          const val = def && typeof def === 'object' && 'value' in def ? def.value : (opts[0] ?? '');
          config[key] = { value: val, options: opts };
        } else if (form.type === 'bool'){
          config[key] = Boolean(def);
        } else if (form.type === 'number'){
          config[key] = typeof def === 'number' ? def : 0;
        } else {
          config[key] = def ?? '';
        }
      });

      Object.entries(defaults).forEach(([k, v]) => {
        if (!(k in config)) config[k] = v;
      });

      const baseId = state.steps.length;
      return {
        ScriptId: scriptId,
        Uid: `${scriptId}_${Date.now()}`,
        OrderId: baseId,
        Config: config,
        Id: baseId,
        IsActive: true,
        IsCopy: true,
        ScheduleData: { Active: false, Last: '0001-01-01T00:00:00', Daily: false, Hourly: false, Weekly: false },
        ScheduleRules: [],
      };
    }

    function addStepFromSchema(){
      if (!state.current){
        showToast('Выберите шаблон', true);
        return;
      }
      const sid = (document.getElementById('scriptIdInput').value || '').trim();
      if (!sid){
        showToast('Укажите ScriptId', true);
        return;
      }
      const step = buildStepFromSchema(sid);
      state.steps = [...state.steps, step];
      state.selectedStep = state.steps.length - 1;
      renderSteps();
      showToast('Шаг добавлен по схеме');
    }

    function addConfigKey(){
      if (state.selectedStep < 0 || state.selectedStep >= state.steps.length){
        showToast('Выберите шаг', true);
        return;
      }
      const key = (prompt('Имя нового ключа:') || '').trim();
      if (!key) return;
      const step = state.steps[state.selectedStep];
      if (!step.Config || typeof step.Config !== 'object') step.Config = {};
      if (key in step.Config){
        showToast('Такой ключ уже есть', true);
        return;
      }
      step.Config[key] = '';
      renderConfigFields();
      syncEditorWithStep();
    }

    async function deleteTemplate(){
      if (!state.current) return;
      if (!confirm(`Удалить шаблон ${state.current}?`)) return;
      setLoading('deleteBtn', true);
      try {
        const res = await fetch(`/api/templates/${encodeURIComponent(state.current)}`, { method:'DELETE' });
        if (!res.ok){
          showToast('Не удалось удалить', true);
          return;
        }
        state.current = null;
        state.steps = [];
        state.selectedStep = -1;
        document.getElementById('templateNameInput').value = '';
        document.getElementById('stepEditor').value = '';
        document.getElementById('editorStatus').textContent = 'Нет выбранного шаблона';
        await loadTemplates();
        renderSteps();
        updateAliasLine();
        updateButtons();
        showToast('Шаблон удалён');
      } catch (e){
        console.error(e);
        showToast('Ошибка удаления', true);
      } finally {
        setLoading('deleteBtn', false);
      }
    }

    async function handleDeepLink(){
      const params = new URLSearchParams(location.search);
      const tpl = params.get('template');
      if (!tpl) return;

      const scriptId = params.get('scriptId') || '';
      const missingKey = params.get('missingKey') || '';
      const canonical = canonicalName(tpl);

      await openTemplate(canonical);

      if (scriptId){
        const idx = state.steps.findIndex(s => s.ScriptId === scriptId);
        if (idx >= 0) selectStep(idx);
      }

      if (missingKey){
        state.highlight = { scriptId, key: missingKey };
        renderConfigFields();
        showToast(`Добавьте ключ ${missingKey} в шаблон`, true);
      }
    }

    async function initPage(){
      await Promise.all([loadSchema(), loadTemplates()]);
      await handleDeepLink();
    }

    initPage();
  </script>
</body>
</html>
