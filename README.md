# UsersDash

Веб-приложение на Flask для администраторов и клиентов фермерских аккаунтов. Проект включает
интерфейс администратора и личный кабинет клиента, интегрируется с внешними серверами через REST API,
умет создавать ежедневные бэкапы и выполняет базовые health-check'и при запуске. В репозитории также
живут Windows-утилиты RSSv7 и RSS4SALE для мониторинга LDPlayer и подсчёта ресурсов с лёгким
веб-интерфейсом.

## Описание

- Поддержка многопользовательских ролей: администратор и клиент с разными маршрутами входа.
- Управление фермами и серверами, сбор статуса ресурсов и показ актуальных тарифов.
- Простые миграции для SQLite через вспомогательные скрипты `migrate_*.py`.
- Автоматическое создание дефолтного администратора и ежедневных бэкапов БД.
- Журналирование настроек в разделе «Лог настроек» с фильтрами, экспортом и diff'ом значений (см.
  `UsersDash/ADMIN_LOG.md`).

## Структура проекта

- `UsersDash/app.py` — фабрика приложения и точка входа (`python -m UsersDash.app`).
- `UsersDash/models.py` — модели SQLAlchemy: пользователи, серверы, аккаунты, логи и данные фермы.
- `UsersDash/services/` — вспомогательные сервисы (бэкапы, проверки здоровья, аудиторский лог,
  нотификации и расчёт тарифов).
- `UsersDash/templates/` и `UsersDash/static/` — Jinja2-шаблоны и статические файлы интерфейса.
- `UsersDash/tests/` — автотесты на `unittest` для аудита настроек и проверок логов.
- Скрипты `migrate_*.py` и `reset_admin_password.py` — локальные миграции и сброс пароля
  администратора.
- `UsersDash/scripts/sync_menu_data.py` — синхронизация MenuData из таблицы FarmData в локальные
  `bot_farm_configs` или на серверы через API.
- `UsersDash/bot_farm_configs/` — дефолтные конфигурации для ботов и учебных профилей.
- `RSSv7/` — Windows-сборка RssCounter с мониторингом LDPlayer, Telegram-оповещениями и
  веб-интерфейсом на Flask (порт 5001).
- `RSS4SALE/` — облегчённая сборка RssCounter (порт 5001) с конфигом под продажи RSS и опцией
  выгружать события в UsersDash.

## Быстрый старт

1. Установите Python 3.10+ и создайте виртуальное окружение: `python -m venv .venv && source .venv/bin/activate`.
2. Установите зависимости: `pip install -r requirements.txt`.
3. Установите секретный ключ (необязательно для локального запуска):
   `export MULTIDASH_SECRET_KEY='your-secret-key'`.
4. Запустите приложение:
   - для разработки: `python -m UsersDash.app`;
   - через Flask CLI: `flask --app UsersDash.app run --debug`.
5. При первом старте создаётся база `UsersDash/data/app.db` и пользователь admin/admin
   (смените пароль в админке или через `reset_admin_password.py`).

### Настройка Telegram-уведомлений

- Создайте файл `UsersDash/telegram_settings.json` по образцу
  `UsersDash/telegram_settings.example.json` и укажите токен бота и список `chat_ids`.
- Файл игнорируется Git и загружается автоматически через конфиг приложения.
- Вместо файла можно использовать переменные окружения `TELEGRAM_BOT_TOKEN` и
  `TELEGRAM_CHAT_IDS` (список через запятую).

### Telegram-бот для клиентов

Бот обслуживает базу клиентов, рассылает напоминания об оплате и информационные сообщения. Он работает
через long polling и использует ту же SQLite-базу, что и веб-приложение.

#### Запуск

1. Укажите токен бота: `TELEGRAM_BOT_TOKEN` (или через `telegram_settings.json`).
2. Для админ-команд задайте список чатов: `TELEGRAM_ADMIN_CHAT_IDS=123,456`.
3. При необходимости включите код привязки: `TELEGRAM_BIND_CODE=секрет`.
4. Запустите бота: `python -m UsersDash.scripts.telegram_client_bot`.

#### Основные команды

- `/bind <логин> <код>` — привязка чата к клиенту (код нужен, если задан `TELEGRAM_BIND_CODE`).
- `/my` — список ферм клиента и ближайших оплат.
- `/info` — последнее информационное сообщение.
- `/unsubscribe` и `/subscribe` — управление информационными рассылками.
- `/settimezone <таймзона>` — сохранение часового пояса клиента.

#### Админ-команды

- `/payments [дней]` — список оплат за период (по умолчанию `TELEGRAM_REMINDER_DAYS`, 3 дня).
- `/remind` — отправить напоминания об оплате вручную.
- `/broadcast <текст>` — информационная рассылка всем клиентам.
- `/client <логин>` — карточка клиента с фермами и оплатами.

#### Планировщик напоминаний

- Напоминания уходят раз в сутки после часа, заданного `TELEGRAM_REMINDER_HOUR` (по умолчанию 10:00 UTC).
- Окно ближайших оплат задаётся через `TELEGRAM_REMINDER_DAYS` (по умолчанию 3 дня).

### Отдельные утилиты RssCounter

- Все конфигурации для RSSv7 и RSS4SALE лежат в соответствующих `config.json` и читаются из каталога,
  где запускается скрипт `RssCounterWebV7.py`.
- Перед запуском обновите пути к LDPlayer, профилям GnBots, shortcut и API-токенам UsersDash.
- Запуск на Windows: из нужной папки `python RssCounterWebV7.py` (по умолчанию `0.0.0.0:5001`).
- Локальные данные (бэкапы LD, кеши логов, состояние крашей) сохраняются рядом с исполняемым скриптом.

### Мониторинг доступности серверов

- В админ-панели показывается self_status активных серверов и при первой ошибке сразу уходит уведомление
  в Telegram.
- Повторные напоминания об ошибке отправляются каждые 20 минут, пока сервер не восстановится.
- После восстановления оповещения сбрасываются, чтобы следующие сбои снова уведомлялись мгновенно.

## Синхронизация MenuData

Скрипт `UsersDash/scripts/sync_menu_data.py` обновляет `MenuData.Config` из данных `FarmData` для
аккаунтов `Account`. Поддерживаются режимы:

- `--mode local` — обновляет локальные JSON в `UsersDash/bot_farm_configs` по имени фермы.
- `--mode server` — отправляет обновления через API (`update_account_menu_data`).
- `--mode both` — сначала локальные файлы, затем серверы.

Примеры запуска из корня репозитория:

- Локальные файлы: `python UsersDash/scripts/sync_menu_data.py --mode local`
- Отправка на серверы: `python UsersDash/scripts/sync_menu_data.py --mode server`
- Собственный каталог с конфигами: `python UsersDash/scripts/sync_menu_data.py --configs-dir путь`
- Альтернатива через модуль: `python -m UsersDash.scripts.sync_menu_data --mode local`

Для серверного режима нужны настроенные API-адреса серверов и доступ к ним. В Windows можно
запускать скрипт из каталога репозитория либо через `-m`, чтобы корректно резолвить пакет.

## Тестирование

- Запустите быстрые проверки кода: `python -m unittest discover UsersDash/tests`.
- Скрипт `run_integrity_checks.py` выполняет статические проверки шаблонов и сборку модулей.

## Работа с данными и миграциями

- Все данные по умолчанию находятся в каталоге `UsersDash/data`; при переносе окружения скопируйте его
  вместе с бэкапами из `UsersDash/data/backups`.
- Миграционные скрипты `migrate_*.py` запускаются вручную: `python UsersDash/migrate_add_account_columns.py` и т.д.
- Скрипт `UsersDash/migrate_add_unique_constraints.py` очищает дубликаты и добавляет уникальные индексы для
  Account/FarmData перед включением ограничений.
- Для резервных копий используется сервис `UsersDash/services/db_backup.py`, бэкапы создаются ежедневно
  фоновым потоком.

## Полезные ссылки по коду

- Аутентификация и вход: `UsersDash/auth.py` и блюпринт `auth_bp`.
- Админские маршруты: `UsersDash/admin_views.py` (управление аккаунтами, тарифами, экспорт логов).
- Клиентские маршруты: `UsersDash/client_views.py` (дашборд, формы с данными фермы).
- API для внешних сервисов: `UsersDash/api_views.py` и клиент `UsersDash/services/remote_api.py`.
