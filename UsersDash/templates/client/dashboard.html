{% extends "base.html" %}

{% block title %}Мои фермы{% endblock %}

{% block content %}
<h1>Мои фермы</h1>

<div class="kpi-row">
    <div class="kpi-card">
        <div class="kpi-label">Ферм всего</div>
        <div class="kpi-value">{{ total_accounts }}</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">Ближайшие оплаты</div>

        {% if upcoming_payments and upcoming_payments|length %}
            <ul class="kpi-list">
                {% for p in upcoming_payments %}
                    <li>
                        <strong>{{ p.account_name }}</strong>
                        — {{ p.date_str }}
                        {% if p.amount %}
                            — {{ p.amount }} ₽
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            {% if upcoming_more > 0 %}
                <div class="kpi-note">и ещё {{ upcoming_more }}</div>
            {% endif %}
        {% else %}
            <div class="kpi-empty">Нет запланированных оплат</div>
        {% endif %}
    </div>

    <div class="kpi-card">
        {% set tariffs_title = 'Тарифы' if tariffs_total != 1 else 'Тариф' %}
        <div class="kpi-label">{{ tariffs_title }}</div>

        {% if tariffs_summary %}
            <ul class="kpi-list tariff-list">
                {% for tariff in tariffs_summary %}
                    <li class="tariff-item">
                        <span class="tariff-name {% if tariff.name == 'Премиум' %}tariff-name--premium{% endif %}">
                            {{ tariff.name }}
                        </span>
                        <span class="tariff-count">×{{ tariff.count }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="kpi-empty">Тарифы не заданы</div>
        {% endif %}
    </div>

    <div class="kpi-card kpi-status-card">
        <div class="kpi-label">Статус</div>
        {% set status = farmdata_status %}

        {% if status and status.has_issues %}
            <div class="status-chip status-chip--warning">Требуется внимание</div>
            <div class="status-list">
                {% if status.missing_details %}
                    {% for item in status.missing_details %}
                        <a class="status-item status-item--warn status-item--link" href="{{ url_for('client.farm_data') }}">
                            <div class="status-item-title">{{ item.farm_name }}</div>
                            <div class="status-item-text">Не заполнено: {{ item.missing_fields|join(', ') }}</div>
                        </a>
                    {% endfor %}
                {% elif status.missing_accounts %}
                    <a class="status-item status-item--warn status-item--link" href="{{ url_for('client.farm_data') }}">
                        Заполните данные ферм: {{ status.missing_accounts|join(', ') }}
                    </a>
                {% endif %}
            </div>
            <div class="status-note">Проблемы по логам будут отображаться здесь позже.</div>
        {% else %}
            <div class="status-chip status-chip--ok">Все Отлично</div>
            <div class="status-note status-note--ok">Новых проблем не обнаружено.</div>
        {% endif %}
    </div>

    <div class="kpi-card kpi-info-card">
        <div class="kpi-label">Инфо</div>
        {% if info_message %}
            <div class="info-block-text">{{ info_message|replace('\n', '<br>')|safe }}</div>
        {% else %}
            <div class="kpi-empty">Нет сообщений</div>
        {% endif %}
    </div>
</div>


{% if accounts_data %}
    <div class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>Имя фермы</th>
                <th>Сервер</th>
                <th>Активна</th>
                <th>Ресурсы (Food / Wood / Stone / Gold)</th>
                <th>Прирост за сегодня</th>
                <th>Обновлено</th>
                <th>Действия</th>
            </tr>
            </thead>
            <tbody>
            {% for item in accounts_data %}
                {% set acc = item.account %}
                <tr data-account-id="{{ acc.id }}">
                    <td>{{ acc.name }}</td>
                    <td>{{ acc.server.name if acc.server else "N/A" }}</td>
                    <td>{{ "Да" if acc.is_active else "Нет" }}</td>
                    <td data-role="resources">
                        {% if item.has_data %}
                            {{ item.resources_brief|safe }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td data-role="today-gain">
                        {% if item.today_gain %}
                            {{ item.today_gain }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td data-role="last-updated">
                        {% if item.last_updated %}
                            {{ item.last_updated }}
                        {% else %}
                            —
                        {% endif %}
                    </td>

                    <td class="actions-cell">
                        <a href="{{ url_for('client.manage_page', account_id=acc.id) }}" class="action-pill">
                            <span class="btn-icon-symbol">⚙</span>
                            <span class="btn-text">Настройки</span>
                        </a>

                        <button class="action-pill action-pill--ghost"
                                data-action="refresh-account"
                                data-account-id="{{ acc.id }}">
                            <span class="btn-text">Обновить</span>
                            <span class="btn-spinner" hidden></span>
                        </button>
                    </td>

                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p>У вас пока нет привязанных ферм. Обратитесь к администратору.</p>
{% endif %}
{% endblock %}
