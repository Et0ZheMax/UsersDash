{% extends "base.html" %}

{% block title %}–ú–æ–∏ —Ñ–µ—Ä–º—ã{% endblock %}

{% block content %}
<h1>–ú–æ–∏ —Ñ–µ—Ä–º—ã</h1>

<div class="kpi-row">
    <div class="kpi-card">
        <div class="kpi-label">–§–µ—Ä–º –≤—Å–µ–≥–æ</div>
        <div class="kpi-value">{{ total_accounts }}</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">–ë–ª–∏–∂–∞–π—à–∏–µ –æ–ø–ª–∞—Ç—ã</div>

        {% if upcoming_payments and upcoming_payments|length %}
            <ul class="kpi-list kpi-list--payments">
                {% for p in upcoming_payments %}
                    <li>
                        <strong>{{ p.account_name }}</strong>
                        ‚Äî {{ p.date_str }}
                        {% if p.amount %}
                            ‚Äî {{ p.amount }} ‚ÇΩ
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="kpi-empty">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø–ª–∞—Ç</div>
        {% endif %}
    </div>

    <div class="kpi-card">
        {% set tariffs_title = '–¢–∞—Ä–∏—Ñ—ã' if tariffs_total != 1 else '–¢–∞—Ä–∏—Ñ' %}
        <div class="kpi-label">{{ tariffs_title }}</div>

        {% if tariffs_summary %}
            <ul class="kpi-list tariff-list">
                {% for tariff in tariffs_summary %}
                    <li class="tariff-item">
                        <span class="tariff-name {% if tariff.name == '–ü—Ä–µ–º–∏—É–º' %}tariff-name--premium{% endif %}">
                            {{ tariff.name }}
                        </span>
                        <span class="tariff-count">√ó{{ tariff.count }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="kpi-empty">–¢–∞—Ä–∏—Ñ—ã –Ω–µ –∑–∞–¥–∞–Ω—ã</div>
        {% endif %}
    </div>

    <div class="kpi-card kpi-status-card">
        <div class="kpi-label">–°—Ç–∞—Ç—É—Å</div>
        {% set status = farmdata_status %}
        {% set has_log_alerts = log_alerts and log_alerts|length > 0 %}

        {% if (status and status.has_issues) or has_log_alerts %}
            <div class="status-chip status-chip--warning">–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ</div>
            {% if status and status.has_issues %}
                <div class="status-list">
                    {% if status.missing_details %}
                        {% for item in status.missing_details %}
                            <a class="status-item status-item--warn status-item--link" href="{{ url_for('client.farm_data') }}">
                                <div class="status-item-title">{{ item.farm_name }}</div>
                                <div class="status-item-text">–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ: {{ item.missing_fields|join(', ') }}</div>
                            </a>
                        {% endfor %}
                    {% elif status.missing_accounts %}
                        <a class="status-item status-item--warn status-item--link" href="{{ url_for('client.farm_data') }}">
                            –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ñ–µ—Ä–º: {{ status.missing_accounts|join(', ') }}
                        </a>
                    {% endif %}
                </div>
            {% endif %}

            {% if has_log_alerts %}
                <div class="status-subtitle">–ü—Ä–æ–±–ª–µ–º—ã –ø–æ –ª–æ–≥–∞–º</div>
                <div class="status-list">
                    {% for alert in log_alerts %}
                        <div class="status-item status-item--warn">
                            <div class="status-item-title">{{ alert.account_name }}</div>
                            <div class="status-item-text">
                                {{ alert.summary }}{% if alert.server_name %} ¬∑ {{ alert.server_name }}{% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% else %}
            <div class="status-chip status-chip--ok">–í—Å–µ –û—Ç–ª–∏—á–Ω–æ</div>
            <div class="status-note status-note--ok">–ù–æ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.</div>
        {% endif %}
    </div>

    <div class="kpi-card kpi-info-card">
        <div class="kpi-label">–ò–Ω—Ñ–æ</div>
        {% if info_message %}
            <div class="info-block-text">{{ info_message|replace('\n', '<br>')|safe }}</div>
        {% else %}
            <div class="kpi-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>
        {% endif %}
    </div>
</div>

{% if blocked_accounts %}
    <div class="payment-warning-card">
        <div class="payment-warning-title">–§–µ—Ä–º–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–æ –æ–ø–ª–∞—Ç—ã</div>
        <div class="payment-warning-text">
            –ú—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–µ—Ä–º –∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–ø–ª–∞—Ç—ã.
            –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram ‚Äî <a href="https://t.me/tvoinetakoi" target="_blank" rel="noopener">@tvoinetakoi</a>,
            —á—Ç–æ–±—ã –ø—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É –∏ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É.
        </div>
        <ul class="payment-warning-list">
            {% for acc in blocked_accounts %}
                <li class="payment-warning-item">
                    <div class="payment-warning-line">
                        <span class="payment-warning-name">{{ acc.name }}</span>
                        <span class="payment-warning-meta">
                            {{ acc.server.name if acc.server else 'N/A' }}
                        </span>
                        {% if acc.next_payment_at %}
                            <span class="payment-warning-date">–û–ø–ª–∞—Ç–∞ –¥–æ {{ acc.next_payment_at.strftime('%d.%m.%Y') }}</span>
                        {% endif %}
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
{% endif %}


{% if accounts_data %}
    <div class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>–ò–º—è —Ñ–µ—Ä–º—ã</th>
                <th>–°–µ—Ä–≤–µ—Ä</th>
                <th>–ê–∫—Ç–∏–≤–Ω–∞</th>
                <th>–†–µ—Å—É—Ä—Å—ã (Food üçó / Wood üå≤ / Stone üß± / Gold üìÄ)</th>
                <th>–ü—Ä–∏—Ä–æ—Å—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è</th>
                <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            {% for item in accounts_data %}
                {% set acc = item.account %}
                <tr data-account-id="{{ acc.id }}">
                    <td>{{ acc.name }}</td>
                    <td>{{ acc.server.name if acc.server else "N/A" }}</td>
                    <td>{{ "–î–∞" if acc.is_active else "–ù–µ—Ç" }}</td>
                    <td data-role="resources">
                        {% if item.has_data %}
                            {{ item.resources_brief|safe }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td data-role="today-gain">
                        {% if item.today_gain %}
                            {{ item.today_gain }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td data-role="last-updated">
                        {% if item.last_updated %}
                            {{ item.last_updated }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>

                    <td class="actions-cell">
                        <a href="{{ url_for('client.manage_page', account_id=acc.id) }}" class="action-pill" data-role="account-settings-link">
                            <span class="btn-icon-symbol">‚öô</span>
                            <span class="btn-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </a>

                        <button class="action-pill action-pill--ghost"
                                data-action="refresh-account"
                                data-account-id="{{ acc.id }}">
                            <span class="btn-text">–û–±–Ω–æ–≤–∏—Ç—å</span>
                            <span class="btn-spinner" hidden></span>
                        </button>
                    </td>

                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
{% endif %}

<script>
    (function () {
        const links = document.querySelectorAll('[data-role="account-settings-link"]');

        if (!links || links.length === 0) return;

        links.forEach((link) => {
            link.addEventListener('click', (evt) => {
                if (evt.metaKey || evt.ctrlKey || evt.shiftKey || evt.altKey || evt.button !== 0) {
                    return;
                }
                const loader = window.EZFLoader;
                if (loader && typeof loader.show === 'function') {
                    loader.show();
                }
            });
        });
    })();
</script>
{% endblock %}
