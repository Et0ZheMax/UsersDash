{% extends "base.html" %}

{% block title %}Матрица видимости настроек{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div class="page-kicker">Админ-панель</div>
        <h1 class="page-title">Матрица видимости конфигов</h1>
        <div class="page-subtitle">Список шагов и ключей из manage.js, API и studyFULL с текущими настройками</div>
    </div>
    <div class="page-actions">
        <a href="{{ url_for('admin.manage') }}" class="btn btn-outline">← Назад к manage</a>
        <form method="post" class="d-inline-block ml-2">
            <input type="hidden" name="action" value="refresh">
            <button type="submit" class="btn btn-outline">Обновить источники</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <p class="text-muted">
            Источник manage.js: {{ manage_meta.order_map|length }} шагов. Данные API: {{ server_meta.steps_count }} шагов{% if server_meta.sample_account %} (пример: {{ server_meta.sample_account.name }}).{% endif %}. Конфигурации studyFULL: {{ study_meta.steps_count }} шагов из {{ study_meta.items_count }} записей.
        </p>
        <form method="post">
            <input type="hidden" name="action" value="save">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Скрипт</th>
                        <th>Ключ</th>
                        <th>Метка для клиента</th>
                        <th>Порядок</th>
                        <th>Видно</th>
                        <th>Источник</th>
                    </tr>
                </thead>
                <tbody>
                {% for script_id, rows_list in grouped_rows.items() %}
                    <tr class="table-secondary">
                        <th colspan="7">
                            <div class="d-flex flex-column flex-md-row align-items-md-center">
                                <div class="text-monospace mr-md-3">{{ script_id }}</div>
                                <div class="flex-grow-1">
                                    <label class="small text-muted mb-1" for="script-label-{{ script_id|replace('.', '-') }}">Название скрипта</label>
                                    {% set script_placeholder = (not rows_list[0].script_label_from_db and rows_list[0].script_label_from_js and rows_list[0].script_label) or 'Название из manage.js' %}
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="script-label-{{ script_id|replace('.', '-') }}"
                                        name="script_label::{{ script_id }}"
                                        value="{{ rows_list[0].script_label }}"
                                        placeholder="{{ script_placeholder }}">
                                    {% if script_errors.get(script_id) %}
                                        <div class="text-danger small mt-1">{{ script_errors.get(script_id) }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </th>
                        </tr>
                    {% for row in rows_list %}
                        <tr>
                            <td class="text-monospace">{{ row.script_id }}</td>
                            <td class="text-monospace">{{ row.config_key }}</td>
                            <td>
                                <input type="text" class="form-control" name="label::{{ row.form_key }}" value="{{ row.client_label or row.default_label }}" placeholder="{{ row.default_label }}">
                            </td>
                            <td style="width: 90px;">
                                <input type="number" class="form-control" name="order::{{ row.form_key }}" value="{{ row.order_index }}" min="0">
                            </td>
                            <td class="text-center" style="width: 80px;">
                                <input type="checkbox" name="visible::{{ row.form_key }}" {% if row.client_visible %}checked{% endif %}>
                            </td>
                            <td class="text-muted">
                                {% set parts = [] %}
                                {% if row.from_js %}{% set _ = parts.append('manage.js') %}{% endif %}
                                {% if row.from_server %}{% set _ = parts.append('API') %}{% endif %}
                                {% if row.from_studyfull %}{% set _ = parts.append('studyFULL') %}{% endif %}
                                {% if row.has_db %}{% set _ = parts.append('DB') %}{% endif %}
                                {% if row.script_label_from_db %}
                                    {% set _ = parts.append('Метка: DB') %}
                                {% elif row.script_label_from_js %}
                                    {% set _ = parts.append('Метка: manage.js') %}
                                {% endif %}
                                {{ parts|join(', ') if parts else '—' }}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Сохранить</button>
                <a href="{{ url_for('admin.manage') }}" class="btn btn-outline">Отмена</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
