{% extends "base.html" %}

{% block title %}Админ — Данные ферм{% endblock %}

{% block content %}

<style>
    /* Общие стили — такие же, как на клиентской farm_data, чтобы был единый стиль */

    .farmdata-page-title {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .farmdata-subtitle {
        font-size: 0.95rem;
        color: #9ca3af;
        margin-bottom: 1.25rem;
    }

    .farmdata-wrapper {
        margin-top: 1rem;
    }

    .farmdata-card {
        background: #141620;
        border-radius: 16px;
        padding: 1.5rem 1.75rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .farmdata-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        gap: 0.75rem;
    }

    .farmdata-card-title {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .farmdata-card-caption {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    .farmdata-card-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .farmdata-card-meta span {
        opacity: 0.9;
    }

    .farmdata-badge-admin {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
        background: rgba(56, 189, 248, 0.12);
        color: #7dd3fc;
    }

    .farmdata-badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #7dd3fc;
    }

    .farmdata-search-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }

    .farmdata-search-label {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    .farmdata-search-input {
        min-width: 220px;
        flex: 1 1 240px;
        max-width: 360px;
        border-radius: 999px;
        border: 1px solid rgba(75, 85, 99, 0.9);
        padding: 0.35rem 0.9rem;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.85rem;
        outline: none;
    }

    .farmdata-search-input::placeholder {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .farmdata-search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
    }

    .farmdata-table-wrapper {
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    table.farmdata-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    table.farmdata-table thead tr {
        background: #111827;
    }

    table.farmdata-table thead th {
        padding: 0.6rem 0.5rem;
        text-align: left;
        font-weight: 500;
        white-space: nowrap;
        border-bottom: 1px solid rgba(75, 85, 99, 0.7);
    }

    table.farmdata-table tbody tr {
        border-bottom: 1px solid rgba(31, 41, 55, 0.8);
    }

    table.farmdata-table tbody tr:last-child {
        border-bottom: none;
    }

    table.farmdata-table tbody td {
        padding: 0.45rem 0.5rem;
        vertical-align: middle;
    }

    .farmdata-name-cell {
        min-width: 150px;
    }

    .farmdata-name-main {
        font-weight: 500;
    }

    .farmdata-name-sub {
        font-size: 0.78rem;
        color: #9ca3af;
        margin-top: 0.1rem;
    }

    .farmdata-input {
        width: 100%;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid rgba(75, 85, 99, 0.9);
        padding: 0.3rem 0.5rem;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.85rem;
        outline: none;
    }

    .farmdata-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
    }

    .farmdata-input::placeholder {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .farmdata-input--short {
        max-width: 120px;
    }

    .farmdata-input--price {
        max-width: 100px;
        text-align: right;
    }

    .farmdata-no-accounts {
        padding: 1rem 0;
        text-align: center;
        color: #9ca3af;
    }

    .farmdata-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.75rem;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn.btn-primary {
        background: #2563eb;
        border-radius: 999px;
        border: none;
        padding: 0.45rem 1.2rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: #fff;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .btn.btn-primary:hover {
        background: #1d4ed8;
    }

    .btn.btn-primary:disabled {
        opacity: 0.5;
        cursor: default;
    }

    .btn-spinner {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        animation: farmdata-spin 0.8s linear infinite;
    }

    @keyframes farmdata-spin {
        to { transform: rotate(360deg); }
    }
</style>

<h1 class="farmdata-page-title">Аккаунты / Данные (админ)</h1>
<p class="farmdata-subtitle">
    Единое хранилище данных по всем фермам клиентов: доступы, королевства, оплаты и тарифы.
</p>

<div class="farmdata-wrapper">
    <form id="admin-farmdata-form">
        <div class="farmdata-card">
            <div class="farmdata-card-header">
                <div>
                    <div class="farmdata-card-title">Все фермы</div>
                    <div class="farmdata-card-caption">
                        Вносите изменения здесь — они будут источником истины для RssV7 и клиентских кабинетов.
                    </div>
                </div>
                <div class="farmdata-card-meta">
                    <div class="farmdata-badge-admin">
                        <span class="farmdata-badge-dot"></span>
                        Админская таблица
                    </div>
                    <span>Всего строк: {{ items|length }}</span>
                </div>
            </div>

            <div class="farmdata-search-row">
                <div class="farmdata-search-label">
                    Поиск по клиенту, ферме, серверу, IGG, email…
                </div>
                <input type="text"
                       class="farmdata-search-input"
                       placeholder="Начните вводить имя фермы, клиента или IGG..."
                       data-role="admin-farmdata-search">
            </div>

            <div class="farmdata-table-wrapper">
                <table class="farmdata-table" data-role="admin-farmdata-table">
                    <thead>
                    <tr>
                        <th>Клиент</th>
                        <th>Ферма</th>
                        <th>E-mail</th>
                        <th>Пароль</th>
                        <th>IGG ID</th>
                        <th>Королевство</th>
                        <th>Telegram</th>
                        <th>След. оплата</th>
                        <th>Тариф, ₽</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if items and items|length %}
                        {% for item in items %}
                            {% set acc = item.account %}
                            {% set owner = item.owner %}
                            {% set fd = item.farmdata %}
                            <tr data-account-id="{{ acc.id }}"
                                data-owner-name="{{ owner.username }}"
                                data-farm-name="{{ acc.name }}">
                                <td>
                                    <div class="farmdata-name-main">
                                        {{ owner.username }}
                                    </div>
                                </td>
                                <td class="farmdata-name-cell">
                                    <div class="farmdata-name-main">
                                        {{ acc.name }}
                                    </div>
                                    <div class="farmdata-name-sub">
                                        Сервер бота: {{ acc.server.name if acc.server else "—" }}
                                    </div>
                                </td>
                                <td>
                                    <input class="farmdata-input"
                                           type="email"
                                           name="email"
                                           placeholder="email@example.com"
                                           value="{{ fd.email if fd and fd.email else '' }}">
                                </td>
                                <td>
                                    <input class="farmdata-input"
                                           type="text"
                                           name="password"
                                           placeholder="Пароль"
                                           value="{{ fd.password if fd and fd.password else '' }}">
                                </td>
                                <td>
                                    <input class="farmdata-input farmdata-input--short"
                                           type="text"
                                           name="igg_id"
                                           placeholder="Только цифры"
                                           inputmode="numeric"
                                           pattern="\\d*"
                                           value="{{ fd.igg_id if fd and fd.igg_id else '' }}">
                                </td>
                                <td>
                                    <input class="farmdata-input"
                                           type="text"
                                           name="server"
                                           placeholder="Королевство аккаунта (игровой сервер)"
                                           value="{{ fd.server if fd and fd.server else '' }}">
                                </td>
                                <td>
                                    <div class="farmdata-telegram-cell">
                                        <input class="farmdata-input"
                                            type="text"
                                            name="telegram_tag"
                                            placeholder="@telegram или ник"
                                            value="{{ fd.telegram_tag if fd and fd.telegram_tag else '' }}">
                                        <button type="button"
                                                class="btn btn-ghost btn-telegram"
                                                data-role="open-telegram-from-row"
                                                title="Открыть в Telegram">
                                            TG
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <input class="farmdata-input farmdata-input--short"
                                           type="date"
                                           name="next_payment_date"
                                           value="{{ acc.next_payment_at.strftime('%Y-%m-%d') if acc.next_payment_at else '' }}">
                                </td>
                                <td>
                                    <input class="farmdata-input farmdata-input--price"
                                           type="number"
                                           min="0"
                                           step="50"
                                           name="tariff"
                                           placeholder="₽"
                                           value="{{ acc.next_payment_amount if acc.next_payment_amount is not none else '' }}">
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="farmdata-no-accounts">
                                Аккаунты пока не найдены.
                            </td>
                        </tr>
                    {% endif %}


                    <div class="modal" data-role="sync-modal" hidden>
                        <div class="modal-backdrop" data-role="sync-modal-close"></div>
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h3>Синхронизация с RSSv7</h3>
                                <button type="button"
                                        class="modal-close-btn"
                                        data-role="sync-modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p class="sync-errors" data-role="sync-errors" style="display:none;"></p>

                                <div class="sync-table-wrapper">
                                    <table class="sync-table" data-role="sync-table">
                                        <thead>
                                        <tr>
                                            <th><input type="checkbox" data-role="sync-check-all" checked></th>
                                            <th>Сервер</th>
                                            <th>Ферма</th>
                                            <th>Поле</th>
                                            <th>UsersDash</th>
                                            <th>RssV7</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <!-- строки diff будут подставляться JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                        class="btn"
                                        data-role="sync-modal-close">
                                    Отмена
                                </button>
                                <button type="button"
                                        class="btn btn-primary"
                                        data-role="sync-apply">
                                    Применить выбранные
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="modal" data-role="pull-modal" hidden>
                        <div class="modal-backdrop" data-role="pull-modal-close"></div>
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h3>Запрос данных с серверов</h3>
                                <button type="button"
                                        class="modal-close-btn"
                                        data-role="pull-modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p class="sync-errors" data-role="pull-errors" style="display:none;"></p>

                                <div class="sync-table-wrapper">
                                    <table class="sync-table" data-role="pull-table">
                                        <thead>
                                        <tr>
                                            <th><input type="checkbox" data-role="pull-check-all" checked></th>
                                            <th>Статус</th>
                                            <th>Сервер</th>
                                            <th>Клиент</th>
                                            <th>Ферма</th>
                                            <th>Email</th>
                                            <th>Пароль</th>
                                            <th>IGG ID</th>
                                            <th>След. оплата</th>
                                            <th>Тариф, ₽</th>
                                        </tr>
                                        </thead>
                                        <tbody data-role="pull-table-body">
                                        <!-- строки будут подставляться JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                        class="btn"
                                        data-role="pull-modal-close">
                                    Отмена
                                </button>
                                <button type="button"
                                        class="btn btn-primary"
                                        data-role="pull-apply">
                                    Добавить выбранные
                                </button>
                            </div>
                        </div>
                    </div>



                    </tbody>
                </table>
            </div>
            <div class="farmdata-actions">
                <button type="button"
                        class="btn btn-secondary"
                        data-role="farmdata-pull">
                    Запрос данных
                    <span class="btn-spinner" data-role="farmdata-pull-spinner" hidden></span>
                </button>

                <button type="button"
                        class="btn btn-secondary"
                        data-role="farmdata-sync">
                    Синхронизировать с RSSv7
                    <span class="btn-spinner" data-role="farmdata-sync-spinner" hidden></span>
                </button>

                <button type="button"
                        class="btn btn-primary"
                        data-role="farmdata-save">
                    Сохранить
                </button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    function setBtnLoading(btn, isLoading, spinnerEl) {
        if (!btn) return;
        if (!spinnerEl) spinnerEl = btn.querySelector(".btn-spinner");
        if (isLoading) {
            btn.disabled = true;
            if (spinnerEl) spinnerEl.hidden = false;
        } else {
            btn.disabled = false;
            if (spinnerEl) spinnerEl.hidden = true;
        }
    }

    if (typeof window.showToast !== "function") {
        window.showToast = function (message, type) {
            alert((type ? "[" + type + "] " : "") + message);
        };
    }

    function formatFarmLabel(tr) {
        if (!tr) return "ферма";
        const owner = tr.dataset.ownerName || "";
        const farm = tr.dataset.farmName || "";
        if (owner && farm) {
            return owner + " / " + farm;
        }
        return farm || owner || "ферма";
    }

    function normalizeDateInput(rawValue) {
        const trimmed = (rawValue || "").trim();
        if (!trimmed) {
            return { normalized: "", isValid: true };
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
            return { normalized: trimmed, isValid: true };
        }
        const match = trimmed.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
        if (match) {
            let [, day, month, year] = match;
            day = day.padStart(2, "0");
            month = month.padStart(2, "0");
            if (year.length === 2) {
                const yearNum = parseInt(year, 10);
                year = (yearNum >= 70 ? 1900 + yearNum : 2000 + yearNum).toString();
            } else if (year.length === 3) {
                year = year.padStart(4, "0");
            }
            return { normalized: `${year}-${month}-${day}`, isValid: true };
        }
        return { normalized: "", isValid: false };
    }

    function normalizeTariffInput(rawValue) {
        if (rawValue === null || rawValue === undefined) {
            return { normalized: "", isValid: true };
        }
        const trimmed = rawValue.toString().trim();
        if (!trimmed) {
            return { normalized: "", isValid: true };
        }
        const noSpaces = trimmed.replace(/\s+/g, "");
        let cleaned = noSpaces;
        if (/[.,]/.test(noSpaces)) {
            if (!/^\d{1,3}([.,]\d{3})+$/.test(noSpaces)) {
                return { normalized: "", isValid: false };
            }
            cleaned = noSpaces.replace(/[.,]/g, "");
        }
        if (/^\d+$/.test(cleaned)) {
            const normalized = cleaned.replace(/^0+(?=\d)/, "") || "0";
            return { normalized, isValid: true };
        }
        return { normalized: "", isValid: false };
    }

    document.addEventListener("input", function (e) {
        const target = e.target;
        if (target.matches('input[name="igg_id"]')) {
            const digits = target.value.replace(/\\D+/g, "");
            if (target.value !== digits) {
                target.value = digits;
            }
        }
    });

    document.addEventListener("input", function (e) {
        const searchInput = e.target.closest('[data-role="admin-farmdata-search"]');
        if (!searchInput) return;

        const query = searchInput.value.trim().toLowerCase();
        const table = document.querySelector('[data-role="admin-farmdata-table"]');
        if (!table) return;

        const rows = table.querySelectorAll("tbody tr[data-account-id]");
        rows.forEach(function (tr) {
            const text = tr.textContent.toLowerCase();
            tr.style.display = text.includes(query) ? "" : "none";
        });
    });

    document.addEventListener("click", async function (e) {
        const btn = e.target.closest('[data-role="farmdata-save"]');
        if (!btn) return;

        const table = document.querySelector('[data-role="admin-farmdata-table"]');
        if (!table) {
            showToast("Таблица не найдена.", "error");
            return;
        }

        const rows = table.querySelectorAll("tbody tr[data-account-id]");
        const items = [];
        const formatWarnings = [];

        rows.forEach(function (tr) {
            const accountId = tr.dataset.accountId;
            if (!accountId) return;
            const farmLabel = formatFarmLabel(tr);

            function val(selector) {
                const el = tr.querySelector(selector);
                return el && el.value ? el.value.trim() : "";
            }

            const nextPaymentInput = val('input[name="next_payment_date"]');
            const nextPaymentResult = normalizeDateInput(nextPaymentInput);
            if (!nextPaymentResult.isValid && nextPaymentInput) {
                formatWarnings.push(`«След. оплата» — ${farmLabel}`);
            }

            const tariffInput = val('input[name="tariff"]');
            const tariffResult = normalizeTariffInput(tariffInput);
            if (!tariffResult.isValid && tariffInput) {
                formatWarnings.push(`«Тариф» — ${farmLabel}`);
            }

            items.push({
                account_id: accountId,
                email: val('input[name="email"]'),
                password: val('input[name="password"]'),
                igg_id: val('input[name="igg_id"]'),
                server: val('input[name="server"]'),
                telegram_tag: val('input[name="telegram_tag"]'),
                next_payment_date: nextPaymentResult.isValid
                    ? nextPaymentResult.normalized
                    : nextPaymentInput,
                tariff: tariffResult.isValid
                    ? tariffResult.normalized
                    : tariffInput
            });
        });

        if (!items.length) {
            showToast("Нет данных для сохранения.", "info");
            return;
        }

        let pendingFormatMessage = null;
        if (formatWarnings.length) {
            const summary = formatWarnings.slice(0, 3).join("; ");
            pendingFormatMessage =
                "Сохраняем в том виде, как введено: " + summary +
                (formatWarnings.length > 3 ? " ..." : "");
        }

        setBtnLoading(btn, true);
        try {
            const resp = await fetch("/admin/farm-data/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ items })
            });
            const data = await resp.json().catch(() => ({}));

            if (!resp.ok || !data.ok) {
                throw new Error(data.error || "Ошибка при сохранении данных.");
            }

            showToast("Данные ферм сохранены.", "success");
            if (pendingFormatMessage) {
                showToast(pendingFormatMessage, "info");
            }
            if (Array.isArray(data.warnings) && data.warnings.length) {
                showToast(data.warnings.join(" | "), "info");
            }
        } catch (err) {
            console.error(err);
            showToast(err.message || "Ошибка при сохранении данных.", "error");
        } finally {
            setBtnLoading(btn, false);
        }
    });

    document.addEventListener("click", function (e) {
        const btn = e.target.closest('[data-role="open-telegram-from-row"]');
        if (!btn) return;

        const row = btn.closest("tr");
        if (!row) return;

        const input = row.querySelector('input[name="telegram_tag"]');
        if (!input) return;

        const raw = (input.value || "").trim();
        if (!raw) {
            showToast("Telegram-тег пустой.", "info");
            return;
        }

        const tag = raw.replace(/^@+/, "");
        const url = "https://t.me/" + encodeURIComponent(tag);
        window.open(url, "_blank");
    });

    const syncModal = document.querySelector('[data-role="sync-modal"]');
    const syncTableBody = document.querySelector('[data-role="sync-table"] tbody');
    const syncErrors = document.querySelector('[data-role="sync-errors"]');
    const checkAll = document.querySelector('[data-role="sync-check-all"]');

    const pullModal = document.querySelector('[data-role="pull-modal"]');
    const pullTableBody = document.querySelector('[data-role="pull-table-body"]');
    const pullErrors = document.querySelector('[data-role="pull-errors"]');
    const pullCheckAll = document.querySelector('[data-role="pull-check-all"]');

    function openSyncModal() {
        if (!syncModal) return;
        syncModal.hidden = false;
    }

    function closeSyncModal() {
        if (!syncModal) return;
        syncModal.hidden = true;
    }

    document.querySelectorAll('[data-role="sync-modal-close"]').forEach(function (el) {
        el.addEventListener("click", closeSyncModal);
    });

    function openPullModal() {
        if (!pullModal) return;
        pullModal.hidden = false;
    }

    function closePullModal() {
        if (!pullModal) return;
        pullModal.hidden = true;
    }

    document.querySelectorAll('[data-role="pull-modal-close"]').forEach(function (el) {
        el.addEventListener("click", closePullModal);
    });

    if (checkAll) {
        checkAll.addEventListener("change", function () {
            const checked = this.checked;
            syncTableBody.querySelectorAll('input[type="checkbox"][data-role="sync-row-check"]').forEach(function (cb) {
                cb.checked = checked;
            });
        });
    }

    if (pullCheckAll) {
        pullCheckAll.addEventListener("change", function () {
            const checked = this.checked;
            pullTableBody.querySelectorAll('input[type="checkbox"][data-role="pull-row-check"]').forEach(function (cb) {
                if (cb.disabled) return;
                cb.checked = checked;
            });
        });
    }

    const syncBtn = document.querySelector('[data-role="farmdata-sync"]');
    const syncSpinner = document.querySelector('[data-role="farmdata-sync-spinner"]');

    const pullBtn = document.querySelector('[data-role="farmdata-pull"]');
    const pullSpinner = document.querySelector('[data-role="farmdata-pull-spinner"]');
    const pullApplyBtn = document.querySelector('[data-role="pull-apply"]');

    if (syncBtn) {
        syncBtn.addEventListener("click", async function () {
            setBtnLoading(syncBtn, true, syncSpinner);
            syncTableBody.innerHTML = "";
            if (syncErrors) {
                syncErrors.style.display = "none";
                syncErrors.textContent = "";
            }

            try {
                const resp = await fetch("/admin/farm-data/sync-preview", {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!resp.ok) {
                    showToast("Ошибка запроса синхронизации.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка при получении diff.", "error");
                    return;
                }

                const changes = data.changes || [];
                const errors = data.errors || [];

                if (errors.length && syncErrors) {
                    syncErrors.textContent = errors.join(" | ");
                    syncErrors.style.display = "block";
                }

                if (errors.length && !changes.length) {
                    showToast("RssV7 вернул ошибки (см. ниже).", "error");
                    return;
                }

                if (!changes.length) {
                    showToast("Различий с RssV7 не найдено.", "success");
                    return;
                }

                changes.forEach(function (ch, idx) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>
                          <input type="checkbox"
                                 data-role="sync-row-check"
                                 data-index="${idx}"
                                 checked>
                        </td>
                        <td>${ch.server_name || ""}</td>
                        <td>${ch.farm_name || ""}</td>
                        <td>${formatFieldName(ch.field)}</td>
                        <td>${escapeHtml(ch.local || "")}</td>
                        <td>${escapeHtml(ch.remote || "")}</td>
                    `;
                    tr.dataset.change = JSON.stringify(ch);
                    syncTableBody.appendChild(tr);
                });

                openSyncModal();
            } catch (e) {
                console.error("sync-preview error:", e);
                showToast("Ошибка синхронизации (см. консоль).", "error");
            } finally {
                setBtnLoading(syncBtn, false, syncSpinner);
            }
        });
    }

    if (pullBtn) {
        pullBtn.addEventListener("click", async function () {
            setBtnLoading(pullBtn, true, pullSpinner);

            if (pullErrors) {
                pullErrors.style.display = "none";
                pullErrors.textContent = "";
            }
            if (pullTableBody) {
                pullTableBody.innerHTML = "";
            }

            try {
                const resp = await fetch("/admin/farm-data/pull-preview", {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!resp.ok) {
                    showToast("Ошибка запроса данных.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка при получении данных.", "error");
                    return;
                }

                const errors = data.errors || [];
                const items = data.items || [];

                if (errors.length && pullErrors) {
                    pullErrors.textContent = errors.join(" | ");
                    pullErrors.style.display = "block";
                }

                if (!items.length) {
                    showToast("Удалённых данных не найдено.", "info");
                    return;
                }

                items.forEach(function (item, idx) {
                    const tr = document.createElement("tr");
                    tr.dataset.item = JSON.stringify(item);

                    const remote = item.remote || {};
                    const local = item.local || {};
                    const canApply = !!item.can_apply && !!item.account_id;
                    const statusText = canApply ? "Найден в UsersDash" : "Аккаунт не найден";

                    const localSummary = [
                        local.email ? `Email: ${local.email}` : "",
                        local.password ? `Пароль: ${local.password}` : "",
                        local.igg_id ? `IGG: ${local.igg_id}` : "",
                        local.next_payment_at ? `Оплата: ${local.next_payment_at}` : "",
                        local.tariff !== undefined && local.tariff !== null && local.tariff !== ""
                            ? `Тариф: ${local.tariff}`
                            : ""
                    ].filter(Boolean).join(" | ");

                    if (localSummary) {
                        tr.title = "UsersDash: " + localSummary;
                    }

                    tr.innerHTML = `
                        <td>
                          <input type="checkbox"
                                 data-role="pull-row-check"
                                 data-index="${idx}"
                                 ${canApply ? "checked" : "disabled"}>
                        </td>
                        <td>${statusText}</td>
                        <td>${escapeHtml(item.server_name || "")}</td>
                        <td>${escapeHtml(item.owner_name || "")}</td>
                        <td>${escapeHtml(item.farm_name || "")}</td>
                        <td>${escapeHtml(remote.email || "")}</td>
                        <td>${escapeHtml(remote.password || "")}</td>
                        <td>${escapeHtml(remote.igg_id || "")}</td>
                        <td>${escapeHtml(remote.next_payment_at || "")}</td>
                        <td>${escapeHtml(
                            remote.tariff === 0 || remote.tariff
                                ? remote.tariff
                                : ""
                        )}</td>
                    `;

                    pullTableBody.appendChild(tr);
                });

                openPullModal();
            } catch (err) {
                console.error("pull-preview error:", err);
                showToast("Ошибка запроса данных (см. консоль).", "error");
            } finally {
                setBtnLoading(pullBtn, false, pullSpinner);
            }
        });
    }

    function formatFieldName(field) {
        switch (field) {
            case "email": return "E-mail";
            case "password": return "Пароль";
            case "igg_id": return "IGG ID";
            case "server": return "Сервер аккаунта";
            case "telegram": return "Telegram";
            case "next_payment_at": return "След. оплата";
            case "tariff": return "Тариф, ₽";
            default: return field;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.innerText = text;
        return div.innerHTML;
    }

    const applyBtn = document.querySelector('[data-role="sync-apply"]');
    if (applyBtn) {
        applyBtn.addEventListener("click", async function () {
            const rows = Array.from(syncTableBody.querySelectorAll("tr"));

            const changesToApply = [];

            rows.forEach(function (tr) {
                const cb = tr.querySelector('input[type="checkbox"][data-role="sync-row-check"]');
                if (!cb || !cb.checked) return;

                const raw = tr.dataset.change;
                if (!raw) return;

                try {
                    const ch = JSON.parse(raw);
                    changesToApply.push({
                        account_id: ch.account_id,
                        field: ch.field,
                        remote: ch.remote
                    });
                } catch (e) {
                    console.warn("Bad change data:", e);
                }
            });

            if (!changesToApply.length) {
                showToast("Не выбрано ни одного изменения.", "info");
                return;
            }

            applyBtn.disabled = true;
            try {
                const resp = await fetch("/admin/farm-data/sync-apply", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({ changes: changesToApply })
                });

                if (!resp.ok) {
                    showToast("Ошибка применения изменений.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка применения.", "error");
                    return;
                }

                showToast("Изменения успешно применены.", "success");
                closeSyncModal();
                window.location.reload();
            } catch (e) {
                console.error("sync-apply error:", e);
                showToast("Ошибка применения (см. консоль).", "error");
            } finally {
                applyBtn.disabled = false;
            }
        });
    }

    if (pullApplyBtn) {
        pullApplyBtn.addEventListener("click", async function () {
            if (!pullTableBody) {
                showToast("Нет данных для применения.", "info");
                return;
            }

            const rows = Array.from(pullTableBody.querySelectorAll("tr"));
            const itemsToApply = [];

            rows.forEach(function (tr) {
                const cb = tr.querySelector('input[type="checkbox"][data-role="pull-row-check"]');
                if (!cb || cb.disabled || !cb.checked) return;

                const raw = tr.dataset.item;
                if (!raw) return;

                try {
                    const item = JSON.parse(raw);
                    const remote = item.remote || {};

                    itemsToApply.push({
                        account_id: item.account_id,
                        email: remote.email || "",
                        password: remote.password || "",
                        igg_id: remote.igg_id || "",
                        server: remote.server || "",
                        telegram: remote.telegram || "",
                        next_payment_at: remote.next_payment_at || "",
                        tariff: remote.tariff,
                    });
                } catch (e) {
                    console.warn("Bad pull item:", e);
                }
            });

            if (!itemsToApply.length) {
                showToast("Не выбрано ни одной строки для обновления.", "info");
                return;
            }

            pullApplyBtn.disabled = true;
            try {
                const resp = await fetch("/admin/farm-data/pull-apply", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({ items: itemsToApply })
                });

                if (!resp.ok) {
                    showToast("Ошибка применения данных.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка применения данных.", "error");
                    return;
                }

                showToast("Данные добавлены/обновлены.", "success");
                if (Array.isArray(data.warnings) && data.warnings.length) {
                    showToast(data.warnings.join(" | "), "info");
                }
                closePullModal();
                window.location.reload();
            } catch (err) {
                console.error("pull-apply error:", err);
                showToast("Ошибка применения (см. консоль).", "error");
            } finally {
                pullApplyBtn.disabled = false;
            }
        });
    }
});
</script>

{% endblock %}
