{% extends "base.html" %}

{% block title %}Админ — Данные ферм{% endblock %}

{% block content %}

<style>
    /* Общие стили — такие же, как на клиентской farm_data, чтобы был единый стиль */

    .farmdata-page-title {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .farmdata-subtitle {
        font-size: 0.95rem;
        color: #9ca3af;
        margin-bottom: 1.25rem;
    }

    .farmdata-wrapper {
        margin-top: 1rem;
    }

    .farmdata-card {
        background: #141620;
        border-radius: 16px;
        padding: 1.5rem 1.75rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .farmdata-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        gap: 0.75rem;
    }

    .farmdata-card-title {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .farmdata-card-caption {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    .farmdata-card-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .farmdata-card-meta span {
        opacity: 0.9;
    }

    .farmdata-badge-admin {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
        background: rgba(56, 189, 248, 0.12);
        color: #7dd3fc;
    }

    .farmdata-badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #7dd3fc;
    }

    .farmdata-toolbar {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }

    .farmdata-search-block {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        flex: 1 1 320px;
        min-width: 260px;
    }

    .farmdata-search-label {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    .farmdata-search-input {
        border-radius: 999px;
        border: 1px solid rgba(75, 85, 99, 0.9);
        padding: 0.35rem 0.9rem;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.85rem;
        outline: none;
        width: 100%;
        box-sizing: border-box;
    }

    .farmdata-search-input::placeholder {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .farmdata-search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
    }

    .farmdata-table-wrapper {
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    table.farmdata-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    table.farmdata-table thead tr {
        background: #111827;
    }

    table.farmdata-table thead th {
        padding: 0.6rem 0.5rem;
        text-align: left;
        font-weight: 500;
        white-space: nowrap;
        border-bottom: 1px solid rgba(75, 85, 99, 0.7);
    }

    table.farmdata-table tbody tr {
        border-bottom: 1px solid rgba(31, 41, 55, 0.8);
    }

    .farmdata-row--blocked {
        background: rgba(208, 107, 107, 0.08);
    }

    table.farmdata-table tbody tr:last-child {
        border-bottom: none;
    }

    table.farmdata-table tbody td {
        padding: 0.45rem 0.5rem;
        vertical-align: middle;
    }

    .farmdata-name-cell {
        min-width: 150px;
    }

    .farmdata-name-main {
        font-weight: 500;
    }

    .farmdata-name-sub {
        font-size: 0.78rem;
        color: #9ca3af;
        margin-top: 0.1rem;
    }

    .farmdata-input {
        width: 100%;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid rgba(75, 85, 99, 0.9);
        padding: 0.3rem 0.5rem;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.85rem;
        outline: none;
    }

    .farmdata-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
    }

    .farmdata-input::placeholder {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .farmdata-input--short {
        max-width: 120px;
    }

    .farmdata-input--price {
        max-width: 100px;
        text-align: right;
    }

    .farmdata-no-accounts {
        padding: 1rem 0;
        text-align: center;
        color: #9ca3af;
    }

    .farmdata-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.75rem;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .farmdata-actions--toolbar {
        margin-top: 0;
        flex: 1 1 auto;
        justify-content: flex-end;
    }

    .btn.btn-primary {
        background: #2563eb;
        border-radius: 999px;
        border: none;
        padding: 0.45rem 1.2rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: #fff;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .btn.btn-primary:hover {
        background: #1d4ed8;
    }

    .btn.btn-primary:disabled {
        opacity: 0.5;
        cursor: default;
    }

    .farmdata-loader {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        padding: 0.65rem 0.85rem;
        border-radius: 12px;
        background: rgba(59, 130, 246, 0.08);
        color: #cbd5f5;
        font-size: 0.9rem;
    }

    .farmdata-loader__spinner {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 3px solid rgba(125, 211, 252, 0.25);
        border-top-color: #7dd3fc;
        animation: farmdata-spin 0.9s linear infinite;
    }

    .farmdata-loader__progress {
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .btn-spinner {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        animation: farmdata-spin 0.8s linear infinite;
    }

    @keyframes farmdata-spin {
        to { transform: rotate(360deg); }
    }
</style>

<h1 class="farmdata-page-title">Аккаунты / Данные (админ)</h1>
<p class="farmdata-subtitle">
    Единое хранилище данных по всем фермам клиентов: доступы, королевства, оплаты и тарифы.
</p>

<div class="farmdata-wrapper">
    <form id="admin-farmdata-form">
        <div class="farmdata-card">
            <div class="farmdata-card-header">
                <div>
                    <div class="farmdata-card-title">Все фермы</div>
                    <div class="farmdata-card-caption">
                        Вносите изменения здесь — они будут источником истины для RssV7 и клиентских кабинетов.
                    </div>
                </div>
                <div class="farmdata-card-meta">
                    <div class="farmdata-badge-admin">
                        <span class="farmdata-badge-dot"></span>
                        Админская таблица
                    </div>
                    <span>Всего строк: <span data-role="farmdata-total">{{ total_accounts }}</span></span>
                </div>
            </div>

            <div class="farmdata-toolbar">
                <div class="farmdata-search-block">
                    <div class="farmdata-search-label">
                        Поиск по клиенту, ферме, серверу, IGG, email…
                    </div>
                    <input type="text"
                           class="farmdata-search-input"
                           placeholder="Начните вводить имя фермы, клиента или IGG..."
                           data-role="admin-farmdata-search">
                </div>
                <div class="farmdata-card-meta" style="align-items: flex-start; min-width: 240px; gap: 0.35rem;">
                    <div class="farmdata-loader" data-role="farmdata-loader">
                        <div class="farmdata-loader__spinner"></div>
                        <div>
                            <div>Подгружаем строки таблицы...</div>
                            <div class="farmdata-loader__progress" data-role="farmdata-progress">0 / {{ total_accounts }}</div>
                        </div>
                    </div>
                </div>
                <div class="farmdata-actions farmdata-actions--toolbar">
                    <button type="button"
                            class="btn btn-primary"
                            data-role="farmdata-save">
                        Сохранить
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            data-role="farmdata-sync">
                        Синхронизировать с RSSv7
                        <span class="btn-spinner" data-role="farmdata-sync-spinner" hidden></span>
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            data-role="farmdata-pull">
                        Запрос данных
                        <span class="btn-spinner" data-role="farmdata-pull-spinner" hidden></span>
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            data-role="auto-create-clients">
                        Создать клиентов по именам
                        <span class="btn-spinner" data-role="auto-create-spinner" hidden></span>
                    </button>
                </div>
            </div>

            <div class="farmdata-table-wrapper">
                <div data-role="farmdata-meta"
                     data-total-rows="{{ total_accounts }}"
                     data-chunk-size="200"
                     hidden></div>
                <table class="farmdata-table" data-role="admin-farmdata-table">
                    <thead>
                    <tr>
                        <th>Клиент</th>
                        <th>Ферма</th>
                        <th>E-mail</th>
                        <th>Пароль</th>
                        <th>IGG ID</th>
                        <th>Королевство</th>
                        <th>Telegram</th>
                        <th>След. оплата</th>
                        <th>Тариф, ₽</th>
                    </tr>
                    </thead>
                    <tbody data-role="farmdata-body">
                        <tr data-role="farmdata-placeholder">
                            <td colspan="9" class="farmdata-no-accounts">
                                Готовим таблицу к отображению...
                            </td>
                        </tr>
                    </tbody>


                    <div class="modal" data-role="sync-modal" hidden>
                        <div class="modal-backdrop" data-role="sync-modal-close"></div>
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h3>Синхронизация с RSSv7</h3>
                                <button type="button"
                                        class="modal-close-btn"
                                        data-role="sync-modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p class="sync-errors" data-role="sync-errors" style="display:none;"></p>

                                <div class="sync-table-wrapper">
                                    <table class="sync-table" data-role="sync-table">
                                        <thead>
                                        <tr>
                                            <th><input type="checkbox" data-role="sync-check-all" checked></th>
                                            <th>Сервер</th>
                                            <th>Ферма</th>
                                            <th>Поле</th>
                                            <th>UsersDash</th>
                                            <th>RssV7</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <!-- строки diff будут подставляться JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                        class="btn"
                                        data-role="sync-modal-close">
                                    Отмена
                                </button>
                                <button type="button"
                                        class="btn btn-primary"
                                        data-role="sync-apply">
                                    Применить выбранные
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="modal" data-role="pull-modal" hidden>
                        <div class="modal-backdrop" data-role="pull-modal-close"></div>
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h3>Запрос данных с серверов</h3>
                                <button type="button"
                                        class="modal-close-btn"
                                        data-role="pull-modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p class="sync-errors" data-role="pull-errors" style="display:none;"></p>

                                <div class="sync-table-wrapper">
                                    <table class="sync-table" data-role="pull-table">
                                        <thead>
                                        <tr>
                                            <th><input type="checkbox" data-role="pull-check-all" checked></th>
                                            <th>Статус</th>
                                            <th>Сервер</th>
                                            <th>Клиент</th>
                                            <th>Ферма</th>
                                            <th>Email</th>
                                            <th>Пароль</th>
                                            <th>IGG ID</th>
                                            <th>След. оплата</th>
                                            <th>Тариф, ₽</th>
                                        </tr>
                                        </thead>
                                        <tbody data-role="pull-table-body">
                                        <!-- строки будут подставляться JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                        class="btn"
                                        data-role="pull-modal-close">
                                    Отмена
                                </button>
                                <button type="button"
                                        class="btn btn-primary"
                                        data-role="pull-apply">
                                    Добавить выбранные
                                </button>
                            </div>
                        </div>
                    </div>



                    </tbody>
                </table>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    function setBtnLoading(btn, isLoading, spinnerEl) {
        if (!btn) return;
        if (!spinnerEl) spinnerEl = btn.querySelector(".btn-spinner");
        if (isLoading) {
            btn.disabled = true;
            if (spinnerEl) spinnerEl.hidden = false;
        } else {
            btn.disabled = false;
            if (spinnerEl) spinnerEl.hidden = true;
        }
    }

    if (typeof window.showToast !== "function") {
        window.showToast = function (message, type) {
            alert((type ? "[" + type + "] " : "") + message);
        };
    }

    function showMiniToast(message, type = "info") {
        let container = document.querySelector(".mini-toast-container--top");
        if (!container) {
            container = document.createElement("div");
            container.className = "mini-toast-container mini-toast-container--top";
            document.body.appendChild(container);
        }

        const toast = document.createElement("div");
        toast.className = `mini-toast mini-toast--${type}`;
        toast.textContent = message;

        container.innerHTML = "";
        container.appendChild(toast);

        requestAnimationFrame(() => toast.classList.add("is-visible"));
        setTimeout(() => toast.classList.remove("is-visible"), 1600);
        setTimeout(() => toast.remove(), 2000);
    }

    function setFarmdataLoaderState({ loaded = 0, total = 0, isDone = false } = {}) {
        const loader = document.querySelector('[data-role="farmdata-loader"]');
        const progress = document.querySelector('[data-role="farmdata-progress"]');

        if (!loader || !progress) return;

        progress.textContent = `${loaded} / ${total}`;
        loader.style.opacity = isDone ? "0.65" : "1";
        loader.querySelector(".farmdata-loader__spinner").style.visibility = isDone ? "hidden" : "visible";
    }

    function formatFarmLabel(tr) {
        if (!tr) return "ферма";
        const owner = tr.dataset.ownerName || "";
        const farm = tr.dataset.farmName || "";
        if (owner && farm) {
            return owner + " / " + farm;
        }
        return farm || owner || "ферма";
    }

    function normalizeDateInput(rawValue) {
        const trimmed = (rawValue || "").trim();
        if (!trimmed) {
            return { normalized: "", isValid: true };
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
            return { normalized: trimmed, isValid: true };
        }
        const match = trimmed.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
        if (match) {
            let [, day, month, year] = match;
            day = day.padStart(2, "0");
            month = month.padStart(2, "0");
            if (year.length === 2) {
                const yearNum = parseInt(year, 10);
                year = (yearNum >= 70 ? 1900 + yearNum : 2000 + yearNum).toString();
            } else if (year.length === 3) {
                year = year.padStart(4, "0");
            }
            return { normalized: `${year}-${month}-${day}`, isValid: true };
        }
        return { normalized: "", isValid: false };
    }

    function normalizeTariffInput(rawValue) {
        if (rawValue === null || rawValue === undefined) {
            return { normalized: "", isValid: true };
        }
        const trimmed = rawValue.toString().trim();
        if (!trimmed) {
            return { normalized: "", isValid: true };
        }
        const noSpaces = trimmed.replace(/\s+/g, "");
        let cleaned = noSpaces;
        if (/[.,]/.test(noSpaces)) {
            if (!/^\d{1,3}([.,]\d{3})+$/.test(noSpaces)) {
                return { normalized: "", isValid: false };
            }
            cleaned = noSpaces.replace(/[.,]/g, "");
        }
        if (/^\d+$/.test(cleaned)) {
            const normalized = cleaned.replace(/^0+(?=\d)/, "") || "0";
            return { normalized, isValid: true };
        }
        return { normalized: "", isValid: false };
    }

    const TARIFF_PRICE_MAP = {{ tariff_price_map|tojson }};
    const PREMIUM_TARIFF_NAME = TARIFF_PRICE_MAP["1400"] || TARIFF_PRICE_MAP[1400] || "Премиум";
    const TARIFF_OPTIONS = [
        {
            price: 0,
            name: TARIFF_PRICE_MAP["0"] || TARIFF_PRICE_MAP[0] || "Своя ферма",
            hidePrice: true
        },
        {
            price: 50,
            name: TARIFF_PRICE_MAP["50"] || TARIFF_PRICE_MAP[50] || "На продажу RSS",
            hidePrice: true
        },
        { price: 500, name: TARIFF_PRICE_MAP["500"] || TARIFF_PRICE_MAP[500] || "Только Фарм" },
        { price: 1000, name: TARIFF_PRICE_MAP["1000"] || TARIFF_PRICE_MAP[1000] || "Расширенный" },
        { price: 1400, name: PREMIUM_TARIFF_NAME }
    ].filter(function (opt) { return !!opt.name; });
    const HIDE_PRICE_TARIFFS = new Set(
        TARIFF_OPTIONS
            .filter(function (opt) { return opt.hidePrice; })
            .map(function (opt) { return String(opt.price); })
    );

    const PAYMENT_URL_PAID = {{ url_for('admin.mark_account_paid', account_id=0)|tojson }};
    const PAYMENT_URL_UNPAID = {{ url_for('admin.mark_account_unpaid', account_id=0)|tojson }};

    function applyPaymentStateToRow(row, blocked, isActive) {
        if (!row) return;
        row.dataset.paymentBlocked = blocked ? "1" : "0";
        row.dataset.isActive = isActive ? "1" : "0";
        row.classList.toggle("farmdata-row--blocked", blocked);

        const unpaidBtn = row.querySelector('[data-role="farmdata-mark-unpaid"]');
        if (unpaidBtn) {
            unpaidBtn.title = blocked ? "Ферма уже отключена за неоплату" : "Отключить за неоплату";
        }

        const paidBtn = row.querySelector('[data-role="farmdata-mark-paid"]');
        if (paidBtn) {
            paidBtn.title = blocked ? "Включить после оплаты" : "Отметить оплату";
        }
    }

    function initPaymentRowStates() {
        document.querySelectorAll('[data-role="admin-farmdata-table"] tbody tr[data-account-id]').forEach(function (row) {
            const blocked = row.dataset.paymentBlocked === "1";
            const active = row.dataset.isActive === "1";
            applyPaymentStateToRow(row, blocked, active);
        });
    }

    function initFarmdataRow(row) {
        if (!row) return;
        const blocked = row.dataset.paymentBlocked === "1";
        const active = row.dataset.isActive === "1";
        applyPaymentStateToRow(row, blocked, active);

        const tariffInput = row.querySelector('input[name="tariff"]');
        if (tariffInput) {
            updateTariffLabel(tariffInput);
            renderTariffDropdown(tariffInput.closest('[data-role="tariff-cell"]'));
        }
    }

    function buildFarmdataRow(item) {
        const tr = document.createElement("tr");
        tr.dataset.accountId = item.account_id;
        tr.dataset.ownerName = item.owner_name || "";
        tr.dataset.farmName = item.farm_name || "";
        tr.dataset.isActive = item.is_active ? "1" : "0";
        tr.dataset.paymentBlocked = item.blocked_for_payment ? "1" : "0";

        const nextPayment = item.next_payment_at || "";
        const tariffVal = item.tariff !== null && item.tariff !== undefined ? item.tariff : "";
        const tariffStr = tariffVal !== null && tariffVal !== undefined && tariffVal !== ""
            ? String(tariffVal)
            : "";
        const hideTariffPrice = tariffStr && HIDE_PRICE_TARIFFS.has(tariffStr);
        const tariffInputValue = hideTariffPrice ? "" : tariffVal;
        const tariffCellAttrs = tariffStr ? ` data-selected-tariff-price="${escapeHtml(tariffStr)}"` : "";

        tr.innerHTML = `
            <td>
                <div class="farmdata-name-main">${escapeHtml(item.owner_name || "—")}</div>
            </td>
            <td class="farmdata-name-cell">
                <div class="farmdata-name-main">${escapeHtml(item.farm_name || "")}</div>
                <div class="farmdata-name-sub">Сервер бота: ${escapeHtml(item.server_bot || "—")}</div>
            </td>
            <td>
                <input class="farmdata-input" type="email" name="email" placeholder="email@example.com" value="${escapeHtml(item.email || "")}">
            </td>
            <td>
                <input class="farmdata-input" type="text" name="password" placeholder="Пароль" value="${escapeHtml(item.password || "")}">
            </td>
            <td>
                <input class="farmdata-input farmdata-input--short" type="text" name="igg_id" placeholder="Только цифры" inputmode="numeric" pattern="\\d*" value="${escapeHtml(item.igg_id || "")}">
            </td>
            <td>
                <input class="farmdata-input" type="text" name="server" placeholder="Королевство аккаунта (игровой сервер)" value="${escapeHtml(item.server || "")}">
            </td>
            <td>
                <div class="farmdata-telegram-cell">
                    <input class="farmdata-input" type="text" name="telegram_tag" placeholder="@telegram или ник" value="${escapeHtml(item.telegram_tag || "")}">
                    <button type="button" class="btn btn-ghost btn-telegram" data-role="open-telegram-from-row" title="Открыть в Telegram">TG</button>
                </div>
            </td>
            <td>
                <input class="farmdata-input farmdata-input--short" type="date" name="next_payment_date" value="${escapeHtml(nextPayment)}">
            </td>
            <td>
                <div class="tariff-cell" data-role="tariff-cell"${tariffCellAttrs}>
                    <div class="tariff-inline">
                        <input class="farmdata-input farmdata-input--price" type="number" min="0" step="50" name="tariff" placeholder="₽" value="${escapeHtml(String(tariffInputValue))}">
                        <div class="tariff-actions">
                            <a class="icon-btn icon-btn--compact" href="${escapeHtml(item.manage_url || '#')}" title="Настройки фермы" target="_blank" rel="noopener">⚙</a>
                            <button type="button" class="icon-btn icon-btn--compact icon-btn--danger" data-role="farmdata-mark-unpaid" data-account-id="${item.account_id}" title="Отключить за неоплату">✖</button>
                            <button type="button" class="icon-btn icon-btn--compact" data-role="farmdata-mark-paid" data-account-id="${item.account_id}" title="Включить после оплаты">✔</button>
                        </div>
                    </div>
                    <div class="tariff-label tariff-label--interactive" data-role="tariff-label"></div>
                    <div class="tariff-dropdown" data-role="tariff-dropdown" hidden></div>
                </div>
            </td>`;

        initFarmdataRow(tr);
        return tr;
    }

    async function fetchFarmdataChunk(offset, limit) {
        const resp = await fetch(`/admin/farm-data/chunk?offset=${offset}&limit=${limit}`, {
            headers: { "Accept": "application/json", "x-skip-loader": "1" }
        });

        if (!resp.ok) {
            throw new Error("Не удалось загрузить данные (HTTP).");
        }

        const data = await resp.json();
        if (!data.ok) {
            throw new Error(data.error || "Ошибка загрузки данных.");
        }

        return data;
    }

    async function loadFarmdataLazy() {
        const meta = document.querySelector('[data-role="farmdata-meta"]');
        const body = document.querySelector('[data-role="farmdata-body"]');
        const totalSpan = document.querySelector('[data-role="farmdata-total"]');
        const placeholder = body ? body.querySelector('[data-role="farmdata-placeholder"]') : null;

        if (!meta || !body) return;

        const totalRows = parseInt(meta.dataset.totalRows || "0", 10) || 0;
        const chunkSize = parseInt(meta.dataset.chunkSize || "200", 10) || 200;

        if (placeholder) {
            placeholder.remove();
        }

        if (!totalRows) {
            const emptyRow = document.createElement("tr");
            emptyRow.innerHTML = '<td colspan="9" class="farmdata-no-accounts">Аккаунты пока не найдены.</td>';
            body.appendChild(emptyRow);
            setFarmdataLoaderState({ loaded: 0, total: 0, isDone: true });
            return;
        }

        let offset = 0;
        let loaded = 0;
        let total = totalRows;
        setFarmdataLoaderState({ loaded, total });

        while (loaded < total) {
            let data;
            try {
                data = await fetchFarmdataChunk(offset, chunkSize);
            } catch (err) {
                console.error(err);
                showToast(err.message || "Не удалось загрузить данные ферм.", "error");
                break;
            }

            const items = data.items || [];
            total = typeof data.total === "number" ? data.total : total;
            if (totalSpan) {
                totalSpan.textContent = total;
            }

            if (items.length) {
                const fragment = document.createDocumentFragment();
                items.forEach(function (item) {
                    const row = buildFarmdataRow(item);
                    fragment.appendChild(row);
                });
                body.appendChild(fragment);
            }

            loaded += items.length;
            offset += items.length;
            setFarmdataLoaderState({ loaded, total, isDone: loaded >= total });
            updateFarmdataVisibleTotal();

            if (!items.length || loaded >= total) {
                break;
            }
        }

        if (loaded === 0) {
            const emptyRow = document.createElement("tr");
            emptyRow.innerHTML = '<td colspan="9" class="farmdata-no-accounts">Не удалось загрузить данные.</td>';
            body.appendChild(emptyRow);
        }

        setFarmdataLoaderState({ loaded, total, isDone: true });
    }


    function setIconBtnLoading(btn, isLoading) {
        if (!btn) return;
        if (isLoading) {
            btn.disabled = true;
            btn.classList.add("is-loading");
        } else {
            btn.disabled = false;
            btn.classList.remove("is-loading");
        }
    }

    async function handlePaymentToggle(btn, kind) {
        const row = btn.closest('tr[data-account-id]');
        const accountId = btn.dataset.accountId || (row ? row.dataset.accountId : null);
        if (!row || !accountId) {
            showToast("Не удалось определить ферму.", "error");
            return;
        }

        const endpoint = kind === "paid" ? PAYMENT_URL_PAID : PAYMENT_URL_UNPAID;
        const url = (endpoint || "").replace("0", accountId);

        setIconBtnLoading(btn, true);
        try {
            const resp = await fetch(url, { method: "POST", headers: { "x-skip-loader": "1" } });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
                throw new Error(data.error || "Не удалось обновить оплату.");
            }

            applyPaymentStateToRow(row, Boolean(data.blocked_for_payment), Boolean(data.is_active));
            if (data.next_payment_at) {
                const nextPaymentInput = row.querySelector('input[name="next_payment_date"]');
                if (nextPaymentInput) {
                    nextPaymentInput.value = data.next_payment_at;
                    nextPaymentInput.dispatchEvent(new Event("change", { bubbles: true }));
                }
            }
            showToast(
                kind === "paid" ? "Ферма включена после оплаты." : "Ферма отключена за неоплату.",
                "success"
            );
        } catch (err) {
            console.error(err);
            showToast(err.message || "Не удалось обновить оплату.", "error");
        } finally {
            setIconBtnLoading(btn, false);
        }
    }

    function closeTariffDropdowns(exceptEl) {
        document.querySelectorAll('[data-role="tariff-dropdown"]').forEach(function (dropdown) {
            if (exceptEl && dropdown === exceptEl) return;
            dropdown.hidden = true;
        });
    }

    function setTariffSelection(cell, priceValue) {
        if (!cell) return;
        if (priceValue === undefined || priceValue === null || priceValue === "") {
            delete cell.dataset.selectedTariffPrice;
        } else {
            cell.dataset.selectedTariffPrice = String(priceValue);
        }
    }

    function getTariffSelection(cell) {
        if (!cell) return "";
        return cell.dataset.selectedTariffPrice || "";
    }

    function updateTariffDropdownState(cell, selectedPrice) {
        const dropdown = cell ? cell.querySelector('[data-role="tariff-dropdown"]') : null;
        if (!dropdown) return;
        dropdown.querySelectorAll('[data-role="tariff-option"]').forEach(function (btn) {
            btn.classList.toggle("is-active", btn.dataset.price === String(selectedPrice));
        });
    }

    function renderTariffDropdown(cell) {
        if (!cell) return;
        const dropdown = cell.querySelector('[data-role="tariff-dropdown"]');
        if (!dropdown || dropdown.dataset.ready === "true") return;

        dropdown.innerHTML = "";
        TARIFF_OPTIONS.forEach(function (opt) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "tariff-dropdown__option";
            btn.dataset.role = "tariff-option";
            btn.dataset.price = String(opt.price);
            if (opt.hidePrice) {
                btn.dataset.hidePrice = "1";
            }

            const priceSpan = document.createElement("span");
            priceSpan.className = "tariff-dropdown__option-price";
            priceSpan.textContent = opt.hidePrice ? "—" : `${opt.price} ₽`;

            const nameSpan = document.createElement("span");
            nameSpan.className = "tariff-dropdown__option-name";
            nameSpan.textContent = opt.name;

            btn.appendChild(priceSpan);
            btn.appendChild(nameSpan);
            dropdown.appendChild(btn);
        });

        dropdown.dataset.ready = "true";
    }

    function toggleTariffDropdown(cell) {
        if (!cell) return;
        renderTariffDropdown(cell);
        const dropdown = cell.querySelector('[data-role="tariff-dropdown"]');
        if (!dropdown) return;

        const shouldOpen = dropdown.hidden;
        closeTariffDropdowns(shouldOpen ? dropdown : null);

        if (shouldOpen) {
            const input = cell.querySelector('input[name="tariff"]');
            const { normalized } = normalizeTariffInput(input ? input.value : "");
            const selectedPrice = getTariffSelection(cell);
            updateTariffDropdownState(
                cell,
                selectedPrice || normalized || (input ? input.value : "")
            );
        }

        dropdown.hidden = !shouldOpen;
    }

    function updateTariffLabel(input) {
        if (!input) return;
        const cell = input.closest('[data-role="tariff-cell"]');
        const label = cell ? cell.querySelector('[data-role="tariff-label"]') : null;
        if (!label) return;

        const { normalized, isValid } = normalizeTariffInput(input.value);
        const selectedPrice = getTariffSelection(cell);
        label.classList.remove("tariff-label--premium");

        if (!normalized && !input.value) {
            label.textContent = "Тариф не назначен";
            setTariffSelection(cell, "");
            updateTariffDropdownState(cell, "");
            return;
        }

        if (selectedPrice) {
            const tariffName = TARIFF_PRICE_MAP[selectedPrice] || TARIFF_PRICE_MAP[String(selectedPrice)];
            if (tariffName) {
                label.textContent = tariffName;
                if (tariffName === PREMIUM_TARIFF_NAME) {
                    label.classList.add("tariff-label--premium");
                }
            } else {
                label.textContent = `Тариф: ${selectedPrice} ₽`;
            }
            updateTariffDropdownState(cell, selectedPrice);
            return;
        }

        if (!isValid) {
            label.textContent = "Тариф не распознан";
            updateTariffDropdownState(cell, "");
            return;
        }

        const numericValue = parseInt(normalized, 10);
        const tariffName = TARIFF_PRICE_MAP[numericValue] || TARIFF_PRICE_MAP[String(numericValue)];

        if (tariffName) {
            label.textContent = tariffName;
            setTariffSelection(cell, normalized);
            if (tariffName === PREMIUM_TARIFF_NAME) {
                label.classList.add("tariff-label--premium");
            }
        } else {
            label.textContent = `Тариф не распознан (${numericValue} ₽)`;
        }

        updateTariffDropdownState(cell, selectedPrice || normalized);
    }

    const adminFarmDataWatchedFields = new Set([
        "email",
        "password",
        "igg_id",
        "server",
        "telegram_tag",
        "next_payment_date",
        "tariff"
    ]);

    loadFarmdataLazy();

    let adminFarmDataAutoSaveTimer = null;
    let adminFarmDataSaveInProgress = false;
    let adminFarmDataAutoSaveQueued = false;
    let lastAdminAutoSaveToastAt = 0;

    function setAdminFarmSaveState(isSaving, isAuto) {
        const btn = document.querySelector('[data-role="farmdata-save"]');
        const spinnerEl = btn ? btn.querySelector(".btn-spinner") : null;
        const textEl = btn ? btn.querySelector(".btn-text") : null;

        if (!btn) return;

        btn.disabled = isSaving;
        if (spinnerEl) spinnerEl.hidden = !isSaving;
        if (textEl) {
            if (isSaving) {
                textEl.textContent = isAuto ? "Автосохранение..." : "Сохраняем...";
            } else {
                textEl.textContent = "Сохранить";
            }
        }
    }

    function collectAdminFarmDataItems() {
        const table = document.querySelector('[data-role="admin-farmdata-table"]');
        if (!table) {
            return { items: [], formatWarnings: [], missingTable: true, hasRows: false };
        }

        const rows = table.querySelectorAll("tbody tr[data-account-id]");
        const items = [];
        const formatWarnings = [];

        rows.forEach(function (tr) {
            const accountId = tr.dataset.accountId;
            if (!accountId) return;
            const farmLabel = formatFarmLabel(tr);

            function val(selector) {
                const el = tr.querySelector(selector);
                return el && el.value ? el.value.trim() : "";
            }

            const tariffCell = tr.querySelector('[data-role="tariff-cell"]');
            const selectedTariff = getTariffSelection(tariffCell);

            const nextPaymentInput = val('input[name="next_payment_date"]');
            const nextPaymentResult = normalizeDateInput(nextPaymentInput);
            if (!nextPaymentResult.isValid && nextPaymentInput) {
                formatWarnings.push(`«След. оплата» — ${farmLabel}`);
            }

            const tariffInput = val('input[name="tariff"]') || selectedTariff;
            const tariffResult = normalizeTariffInput(tariffInput || selectedTariff);
            if (!tariffResult.isValid && tariffInput) {
                formatWarnings.push(`«Тариф» — ${farmLabel}`);
            }

            items.push({
                account_id: accountId,
                email: val('input[name="email"]'),
                password: val('input[name="password"]'),
                igg_id: val('input[name="igg_id"]'),
                server: val('input[name="server"]'),
                telegram_tag: val('input[name="telegram_tag"]'),
                next_payment_date: nextPaymentResult.isValid
                    ? nextPaymentResult.normalized
                    : nextPaymentInput,
                tariff: tariffResult.isValid
                    ? tariffResult.normalized
                    : tariffInput
            });
        });

        return {
            items,
            formatWarnings,
            missingTable: false,
            hasRows: rows.length > 0
        };
    }

    async function saveAdminFarmData(options = {}) {
        const { isAuto = false, triggerBtn = null } = options;
        if (adminFarmDataAutoSaveTimer) {
            clearTimeout(adminFarmDataAutoSaveTimer);
            adminFarmDataAutoSaveTimer = null;
        }
        const { items, formatWarnings, missingTable, hasRows } = collectAdminFarmDataItems();

        if (missingTable) {
            if (!isAuto) {
                showToast("Таблица не найдена.", "error");
            }
            return;
        }

        if (!hasRows || !items.length) {
            if (!isAuto) {
                showToast("Нет данных для сохранения.", "info");
            }
            return;
        }

        let pendingFormatMessage = null;
        if (formatWarnings.length) {
            const summary = formatWarnings.slice(0, 3).join("; ");
            pendingFormatMessage =
                "Сохраняем в том виде, как введено: " + summary +
                (formatWarnings.length > 3 ? " ..." : "");
        }

        if (isAuto) {
            if (adminFarmDataSaveInProgress) {
                adminFarmDataAutoSaveQueued = true;
                return;
            }
            adminFarmDataSaveInProgress = true;
            setAdminFarmSaveState(true, true);
        } else {
            setBtnLoading(triggerBtn, true);
            const textEl = triggerBtn ? triggerBtn.querySelector(".btn-text") : null;
            if (textEl) {
                textEl.textContent = "Сохраняем...";
            }
        }

        try {
            const resp = await fetch("/admin/farm-data/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ items })
            });
            const data = await resp.json().catch(() => ({}));

            if (!resp.ok || !data.ok) {
                throw new Error(data.error || "Ошибка при сохранении данных.");
            }

            const now = Date.now();
            const toastFn = isAuto ? showMiniToast : showToast;
            if (!isAuto || now - lastAdminAutoSaveToastAt > 8000) {
                toastFn(
                    isAuto
                        ? "Изменения сохранены автоматически."
                        : "Данные ферм сохранены.",
                    "success"
                );
                if (isAuto) {
                    lastAdminAutoSaveToastAt = now;
                }
            }
            if (pendingFormatMessage) {
                showToast(pendingFormatMessage, "info");
            }
            if (Array.isArray(data.warnings) && data.warnings.length) {
                showToast(data.warnings.join(" | "), "info");
            }
            if (Array.isArray(data.defaults_results) && data.defaults_results.length) {
                const failed = data.defaults_results.filter(function (row) { return row && row.ok === false; });
                const applied = data.defaults_results.filter(function (row) { return row && row.ok === true; });
                if (failed.length) {
                    const messages = failed.map(function (row) {
                        return `${row.account}: ${row.message || "ошибка применения шаблона"}`;
                    });
                    showToast(`Не удалось применить шаблон настроек: ${messages.join(" | ")}`, "error");
                }
                if (applied.length) {
                    const appliedNames = applied.map(function (row) {
                        return `${row.account} → ${row.tariff || "тариф"}`;
                    });
                    showToast(`Шаблон настроек применён (${appliedNames.join(", ")})`, "success");
                }
            }
        } catch (err) {
            console.error(err);
            showToast(err.message || "Ошибка при сохранении данных.", "error");
        } finally {
            if (isAuto) {
                adminFarmDataSaveInProgress = false;
                setAdminFarmSaveState(false);
                if (adminFarmDataAutoSaveQueued) {
                    adminFarmDataAutoSaveQueued = false;
                    scheduleAdminFarmDataAutoSave();
                }
            } else {
                setBtnLoading(triggerBtn, false);
                const textEl = triggerBtn ? triggerBtn.querySelector(".btn-text") : null;
                if (textEl) {
                    textEl.textContent = "Сохранить";
                }
            }
        }
    }

    function scheduleAdminFarmDataAutoSave() {
        if (adminFarmDataSaveInProgress) {
            adminFarmDataAutoSaveQueued = true;
            return;
        }

        if (adminFarmDataAutoSaveTimer) {
            clearTimeout(adminFarmDataAutoSaveTimer);
        }

        adminFarmDataAutoSaveTimer = setTimeout(function () {
            adminFarmDataAutoSaveTimer = null;
            saveAdminFarmData({ isAuto: true });
        }, 900);
    }

    document.addEventListener("input", function (e) {
        const target = e.target;
        if (target.matches('input[name="igg_id"]')) {
            const digits = target.value.replace(/\\D+/g, "");
            if (target.value !== digits) {
                target.value = digits;
            }
        }
    });

    document.addEventListener("input", function (e) {
        const searchInput = e.target.closest('[data-role="admin-farmdata-search"]');
        if (!searchInput) return;

        const query = searchInput.value.trim().toLowerCase();
        const table = document.querySelector('[data-role="admin-farmdata-table"]');
        if (!table) return;

        const rows = table.querySelectorAll("tbody tr[data-account-id]");
        rows.forEach(function (tr) {
            const text = tr.textContent.toLowerCase();
            tr.style.display = text.includes(query) ? "" : "none";
        });

        updateFarmdataVisibleTotal();
    });

    function updateFarmdataVisibleTotal() {
        const totalSpan = document.querySelector('[data-role="farmdata-total"]');
        const rows = document.querySelectorAll('[data-role="admin-farmdata-table"] tbody tr[data-account-id]');

        if (!totalSpan) {
            return;
        }

        const visibleCount = Array.from(rows).filter(function (row) {
            return row.style.display !== "none";
        }).length;

        totalSpan.textContent = visibleCount;
    }

    function updateFarmdataVisibleTotal() {
        const totalSpan = document.querySelector('[data-role="farmdata-total"]');
        const rows = document.querySelectorAll('[data-role="admin-farmdata-table"] tbody tr[data-account-id]');

        if (!totalSpan) {
            return;
        }

        const visibleCount = Array.from(rows).filter(function (row) {
            return row.style.display !== "none";
        }).length;

        totalSpan.textContent = visibleCount;
    }

    function handleAdminFarmDataFieldChange(e) {
        const target = e.target;
        if (!target || target.tagName !== "INPUT") return;
        if (!adminFarmDataWatchedFields.has(target.name)) return;
        if (!target.closest('[data-role="admin-farmdata-table"]')) return;

        if (target.name === "tariff") {
            updateTariffLabel(target);
        }

        scheduleAdminFarmDataAutoSave();
    }

    document.addEventListener("input", handleAdminFarmDataFieldChange);
    document.addEventListener("change", handleAdminFarmDataFieldChange);

    document.querySelectorAll('[data-role="tariff-cell"] input[name="tariff"]').forEach(function (input) {
        updateTariffLabel(input);
        renderTariffDropdown(input.closest('[data-role="tariff-cell"]'));
    });

    document.addEventListener("click", function (e) {
        const label = e.target.closest('[data-role="tariff-label"]');
        if (label) {
            const cell = label.closest('[data-role="tariff-cell"]');
            toggleTariffDropdown(cell);
            return;
        }

        const optionBtn = e.target.closest('[data-role="tariff-option"]');
        if (optionBtn) {
            const cell = optionBtn.closest('[data-role="tariff-cell"]');
            const input = cell ? cell.querySelector('input[name="tariff"]') : null;
            if (input) {
                setTariffSelection(cell, optionBtn.dataset.price || "");
                input.value = optionBtn.dataset.hidePrice === "1" ? "" : optionBtn.dataset.price || "";
                input.dispatchEvent(new Event("input", { bubbles: true }));
                updateTariffLabel(input);
                closeTariffDropdowns();
                saveAdminFarmData({ isAuto: true });
                return;
            }

            closeTariffDropdowns();
            return;
        }

        if (!e.target.closest('[data-role="tariff-dropdown"]')) {
            closeTariffDropdowns();
        }
    });

    document.addEventListener("click", async function (e) {
        const btn = e.target.closest('[data-role="farmdata-save"]');
        if (!btn) return;
        await saveAdminFarmData({ triggerBtn: btn });
    });

    document.addEventListener("click", function (e) {
        const btn = e.target.closest('[data-role="open-telegram-from-row"]');
        if (!btn) return;

        const row = btn.closest("tr");
        if (!row) return;

        const input = row.querySelector('input[name="telegram_tag"]');
        if (!input) return;

        const raw = (input.value || "").trim();
        if (!raw) {
            showToast("Telegram-тег пустой.", "info");
            return;
        }

        const tag = raw.replace(/^@+/, "");
        const url = "https://t.me/" + encodeURIComponent(tag);
        window.open(url, "_blank");
    });

    const syncModal = document.querySelector('[data-role="sync-modal"]');
    const syncTableBody = document.querySelector('[data-role="sync-table"] tbody');
    const syncErrors = document.querySelector('[data-role="sync-errors"]');
    const checkAll = document.querySelector('[data-role="sync-check-all"]');

    const pullModal = document.querySelector('[data-role="pull-modal"]');
    const pullTableBody = document.querySelector('[data-role="pull-table-body"]');
    const pullErrors = document.querySelector('[data-role="pull-errors"]');
    const pullCheckAll = document.querySelector('[data-role="pull-check-all"]');

    function openSyncModal() {
        if (!syncModal) return;
        syncModal.hidden = false;
    }

    function closeSyncModal() {
        if (!syncModal) return;
        syncModal.hidden = true;
    }

    document.querySelectorAll('[data-role="sync-modal-close"]').forEach(function (el) {
        el.addEventListener("click", closeSyncModal);
    });

    function openPullModal() {
        if (!pullModal) return;
        pullModal.hidden = false;
    }

    function closePullModal() {
        if (!pullModal) return;
        pullModal.hidden = true;
    }

    document.querySelectorAll('[data-role="pull-modal-close"]').forEach(function (el) {
        el.addEventListener("click", closePullModal);
    });

    if (checkAll) {
        checkAll.addEventListener("change", function () {
            const checked = this.checked;
            syncTableBody.querySelectorAll('input[type="checkbox"][data-role="sync-row-check"]').forEach(function (cb) {
                cb.checked = checked;
            });
        });
    }

    if (pullCheckAll) {
        pullCheckAll.addEventListener("change", function () {
            const checked = this.checked;
            pullTableBody.querySelectorAll('input[type="checkbox"][data-role="pull-row-check"]').forEach(function (cb) {
                if (cb.disabled) return;
                cb.checked = checked;
            });
        });
    }

    const syncBtn = document.querySelector('[data-role="farmdata-sync"]');
    const syncSpinner = document.querySelector('[data-role="farmdata-sync-spinner"]');

    const pullBtn = document.querySelector('[data-role="farmdata-pull"]');
    const pullSpinner = document.querySelector('[data-role="farmdata-pull-spinner"]');
    const pullApplyBtn = document.querySelector('[data-role="pull-apply"]');
    const autoCreateBtn = document.querySelector('[data-role="auto-create-clients"]');
    const autoCreateSpinner = document.querySelector('[data-role="auto-create-spinner"]');

    if (syncBtn) {
        syncBtn.addEventListener("click", async function () {
            setBtnLoading(syncBtn, true, syncSpinner);
            syncTableBody.innerHTML = "";
            if (syncErrors) {
                syncErrors.style.display = "none";
                syncErrors.textContent = "";
            }

            try {
                const resp = await fetch("/admin/farm-data/sync-preview", {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!resp.ok) {
                    showToast("Ошибка запроса синхронизации.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка при получении diff.", "error");
                    return;
                }

                const changes = data.changes || [];
                const errors = data.errors || [];

                if (errors.length && syncErrors) {
                    syncErrors.textContent = errors.join(" | ");
                    syncErrors.style.display = "block";
                }

                if (errors.length && !changes.length) {
                    showToast("RssV7 вернул ошибки (см. ниже).", "error");
                    return;
                }

                if (!changes.length) {
                    showToast("Различий с RssV7 не найдено.", "success");
                    return;
                }

                changes.forEach(function (ch, idx) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>
                          <input type="checkbox"
                                 data-role="sync-row-check"
                                 data-index="${idx}"
                                 checked>
                        </td>
                        <td>${ch.server_name || ""}</td>
                        <td>${ch.farm_name || ""}</td>
                        <td>${formatFieldName(ch.field)}</td>
                        <td>${escapeHtml(ch.local || "")}</td>
                        <td>${escapeHtml(ch.remote || "")}</td>
                    `;
                    tr.dataset.change = JSON.stringify(ch);
                    syncTableBody.appendChild(tr);
                });

                openSyncModal();
            } catch (e) {
                console.error("sync-preview error:", e);
                showToast("Ошибка синхронизации (см. консоль).", "error");
            } finally {
                setBtnLoading(syncBtn, false, syncSpinner);
            }
        });
    }

    if (autoCreateBtn) {
        autoCreateBtn.addEventListener("click", async function () {
            if (!confirm("Создать/переназначить клиентов по именам всех ферм?")) {
                return;
            }

            setBtnLoading(autoCreateBtn, true, autoCreateSpinner);

            try {
                const resp = await fetch("/admin/farm-data/autocreate-clients", {
                    method: "POST",
                    headers: { "Accept": "application/json" }
                });

                if (!resp.ok) {
                    showToast("Ошибка автосоздания клиентов.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка автосоздания клиентов.", "error");
                    return;
                }

                const parts = [];
                parts.push(`Создано клиентов: ${data.created_clients || 0}`);
                parts.push(`Переназначено ферм: ${data.reassigned_accounts || 0}`);
                parts.push(`Всего ферм: ${data.total_accounts || 0}`);
                showToast(parts.join(" | "), "success");

                if (Array.isArray(data.warnings) && data.warnings.length) {
                    showToast(data.warnings.join(" | "), "info");
                }

                window.location.reload();
            } catch (e) {
                console.error("autocreate-clients error:", e);
                showToast("Ошибка автосоздания (см. консоль).", "error");
            } finally {
                setBtnLoading(autoCreateBtn, false, autoCreateSpinner);
            }
        });
    }

    if (pullBtn) {
        pullBtn.addEventListener("click", async function () {
            setBtnLoading(pullBtn, true, pullSpinner);

            if (pullErrors) {
                pullErrors.style.display = "none";
                pullErrors.textContent = "";
            }
            if (pullTableBody) {
                pullTableBody.innerHTML = "";
            }

            try {
                const resp = await fetch("/admin/farm-data/pull-preview", {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!resp.ok) {
                    showToast("Ошибка запроса данных.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка при получении данных.", "error");
                    return;
                }

                const errors = data.errors || [];
                const items = data.items || [];

                if (errors.length && pullErrors) {
                    pullErrors.textContent = errors.join(" | ");
                    pullErrors.style.display = "block";
                }

                if (!items.length) {
                    showToast("Удалённых данных не найдено.", "info");
                    return;
                }

                items.forEach(function (item, idx) {
                    const tr = document.createElement("tr");
                    tr.dataset.item = JSON.stringify(item);

                    const remote = item.remote || {};
                    const local = item.local || {};
                    const isNew = !!item.is_new;
                    const canApply = !!item.can_apply;
                    const statusText = isNew
                        ? "Будет создан"
                        : item.account_id
                            ? "Найден в UsersDash"
                            : "Аккаунт не найден";

                    const localSummary = [
                        local.email ? `Email: ${local.email}` : "",
                        local.password ? `Пароль: ${local.password}` : "",
                        local.igg_id ? `IGG: ${local.igg_id}` : "",
                        local.next_payment_at ? `Оплата: ${local.next_payment_at}` : "",
                        local.tariff !== undefined && local.tariff !== null && local.tariff !== ""
                            ? `Тариф: ${local.tariff}`
                            : ""
                    ].filter(Boolean).join(" | ");

                    if (localSummary) {
                        tr.title = "UsersDash: " + localSummary;
                    }

                    tr.innerHTML = `
                        <td>
                          <input type="checkbox"
                                 data-role="pull-row-check"
                                 data-index="${idx}"
                                 ${canApply ? (isNew ? "checked" : "") : "disabled"}>
                        </td>
                        <td>${statusText}</td>
                        <td>${escapeHtml(item.server_name || "")}</td>
                        <td>${escapeHtml(item.owner_name || "")}</td>
                        <td>${escapeHtml(item.farm_name || "")}</td>
                        <td>${escapeHtml(remote.email || "")}</td>
                        <td>${escapeHtml(remote.password || "")}</td>
                        <td>${escapeHtml(remote.igg_id || "")}</td>
                        <td>${escapeHtml(remote.next_payment_at || "")}</td>
                        <td>${escapeHtml(
                            remote.tariff === 0 || remote.tariff
                                ? remote.tariff
                                : ""
                        )}</td>
                    `;

                    pullTableBody.appendChild(tr);
                });

                openPullModal();
            } catch (err) {
                console.error("pull-preview error:", err);
                showToast("Ошибка запроса данных (см. консоль).", "error");
            } finally {
                setBtnLoading(pullBtn, false, pullSpinner);
            }
        });
    }

    function formatFieldName(field) {
        switch (field) {
            case "email": return "E-mail";
            case "password": return "Пароль";
            case "igg_id": return "IGG ID";
            case "server": return "Сервер аккаунта";
            case "telegram": return "Telegram";
            case "next_payment_at": return "След. оплата";
            case "tariff": return "Тариф, ₽";
            default: return field;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.innerText = text;
        return div.innerHTML;
    }

    const applyBtn = document.querySelector('[data-role="sync-apply"]');
    if (applyBtn) {
        applyBtn.addEventListener("click", async function () {
            const rows = Array.from(syncTableBody.querySelectorAll("tr"));

            const changesToApply = [];

            rows.forEach(function (tr) {
                const cb = tr.querySelector('input[type="checkbox"][data-role="sync-row-check"]');
                if (!cb || !cb.checked) return;

                const raw = tr.dataset.change;
                if (!raw) return;

                try {
                    const ch = JSON.parse(raw);
                    changesToApply.push({
                        account_id: ch.account_id,
                        field: ch.field,
                        remote: ch.remote
                    });
                } catch (e) {
                    console.warn("Bad change data:", e);
                }
            });

            if (!changesToApply.length) {
                showToast("Не выбрано ни одного изменения.", "info");
                return;
            }

            applyBtn.disabled = true;
            try {
                const resp = await fetch("/admin/farm-data/sync-apply", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({ changes: changesToApply })
                });

                if (!resp.ok) {
                    showToast("Ошибка применения изменений.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка применения.", "error");
                    return;
                }

                showToast("Изменения успешно применены.", "success");
                closeSyncModal();
                window.location.reload();
            } catch (e) {
                console.error("sync-apply error:", e);
                showToast("Ошибка применения (см. консоль).", "error");
            } finally {
                applyBtn.disabled = false;
            }
        });
    }

    if (pullApplyBtn) {
        pullApplyBtn.addEventListener("click", async function () {
            if (!pullTableBody) {
                showToast("Нет данных для применения.", "info");
                return;
            }

            const rows = Array.from(pullTableBody.querySelectorAll("tr"));
            const itemsToApply = [];

            rows.forEach(function (tr) {
                const cb = tr.querySelector('input[type="checkbox"][data-role="pull-row-check"]');
                if (!cb || cb.disabled || !cb.checked) return;

                const raw = tr.dataset.item;
                if (!raw) return;

                try {
                    const item = JSON.parse(raw);
                    const remote = item.remote || {};

                    itemsToApply.push({
                        account_id: item.account_id,
                        server_id: item.server_id,
                        farm_name: item.farm_name,
                        internal_id: item.internal_id,
                        is_new: item.is_new,
                        email: remote.email || "",
                        password: remote.password || "",
                        igg_id: remote.igg_id || "",
                        server: remote.server || "",
                        telegram: remote.telegram || "",
                        next_payment_at: remote.next_payment_at || "",
                        tariff: remote.tariff,
                    });
                } catch (e) {
                    console.warn("Bad pull item:", e);
                }
            });

            if (!itemsToApply.length) {
                showToast("Не выбрано ни одной строки для обновления.", "info");
                return;
            }

            pullApplyBtn.disabled = true;
            try {
                const resp = await fetch("/admin/farm-data/pull-apply", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({ items: itemsToApply })
                });

                if (!resp.ok) {
                    showToast("Ошибка применения данных.", "error");
                    return;
                }

                const data = await resp.json();
                if (!data.ok) {
                    showToast(data.error || "Ошибка применения данных.", "error");
                    return;
                }

                showToast("Данные добавлены/обновлены.", "success");
                if (Array.isArray(data.warnings) && data.warnings.length) {
                    showToast(data.warnings.join(" | "), "info");
                }
                closePullModal();
                window.location.reload();
            } catch (err) {
                console.error("pull-apply error:", err);
                showToast("Ошибка применения (см. консоль).", "error");
            } finally {
                pullApplyBtn.disabled = false;
            }
        });
    }

    document.addEventListener("click", function (event) {
        const paidBtn = event.target.closest('[data-role="farmdata-mark-paid"]');
        if (paidBtn) {
            event.preventDefault();
            handlePaymentToggle(paidBtn, "paid");
            return;
        }

        const unpaidBtn = event.target.closest('[data-role="farmdata-mark-unpaid"]');
        if (unpaidBtn) {
            event.preventDefault();
            handlePaymentToggle(unpaidBtn, "unpaid");
        }
    });

    initPaymentRowStates();
});
</script>

{% endblock %}
