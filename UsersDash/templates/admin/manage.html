{% extends "base.html" %}

{% block title %}Настройки бота{% endblock %}

{% block content %}
<div class="manage-modern">
    <div class="manage-modern__header">
        <div>
            <div class="page-kicker">Админ-панель</div>
            <h1 class="page-title">Настройки бота</h1>
            <div class="page-subtitle">Просматривайте и меняйте manage для любых активных ферм</div>
        </div>
        <div class="manage-summary">
            <div class="summary-label">Активных ферм</div>
            <div class="summary-value">{{ active_accounts_count }}</div>
        </div>
    </div>

    <div class="manage-modern__toolbar">
        <button class="btn btn-primary" onclick="goBack()">← В дашборд</button>
        <a class="btn btn-outline" href="{{ url_for('admin.config_visibility_matrix') }}">Матрица видимости</a>
        <button class="btn btn-outline" onclick="window.location.reload()">Обновить</button>
        <label class="manage-modern__search">
            <span class="manage-modern__search-icon" aria-hidden="true">
                <svg viewBox="0 0 20 20" focusable="false">
                    <path d="M13.78 12.72a6 6 0 10-1.06 1.06l2.75 2.75a.75.75 0 101.06-1.06zM12 9a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" fill="currentColor" />
                </svg>
            </span>
            <input type="search" class="manage-modern__search-input" data-role="account-search" placeholder="Поиск ферм" aria-label="Поиск фермы">
        </label>
        <div class="manage-modern__templates" data-role="template-controls" hidden>
            <select class="manage-modern__template-select" data-role="template-select" disabled>
                <option>Загружаем шаблоны…</option>
            </select>
            <button class="btn btn-outline" type="button" data-role="template-apply" disabled>Применить</button>
        </div>
        <button class="btn btn-outline" type="button" data-role="copy-settings-open">Копировать настройки</button>
    </div>

    <div class="manage-modern__mobile-nav" data-role="mobile-nav">
        <button class="manage-modern__mobile-back" type="button" data-role="mobile-back" aria-label="Назад">←</button>
        <div class="manage-modern__mobile-titles">
            <div class="manage-modern__mobile-title" data-role="mobile-title">Фермы</div>
            <div class="manage-modern__mobile-subtitle" data-role="mobile-subtitle"></div>
        </div>
        <div class="manage-modern__mobile-placeholder" aria-hidden="true"></div>
    </div>

    <div class="manage-modern__layout" data-role="manage-layout">
        <div class="manage-modern__column manage-modern__column--accounts manage-accounts" data-role="manage-accounts">
            {% if accounts %}
                {% for acc in accounts %}
                    <button class="manage-modern__account {% if selected_account and acc.id == selected_account.id %}is-active{% endif %} {% if not acc.is_active %}is-disabled{% endif %} {% if acc.blocked_for_payment %}is-payment-blocked{% endif %}"
                            data-account-id="{{ acc.id }}"
                            data-account-name="{{ acc.name }}"
                            data-server-name="{{ acc.server.name if acc.server else 'N/A' }}"
                            data-owner-name="{{ acc.owner.username if acc.owner else '' }}"
                            data-account-active="{{ 1 if acc.is_active else 0 }}"
                            data-payment-blocked="{{ 1 if acc.blocked_for_payment else 0 }}"
                            type="button">
                        <div class="manage-modern__account-body">
                            <div class="manage-modern__account-name">{{ acc.name }}</div>
                            <div class="manage-modern__account-meta">
                                {{ acc.server.name if acc.server else 'N/A' }} — {{ acc.owner.username if acc.owner else '—' }}
                            </div>
                            {% if acc.blocked_for_payment %}
                                <div class="manage-modern__account-note">Отключено до оплаты</div>
                            {% endif %}
                        </div>
                        <label class="ios-switch manage-modern__account-toggle">
                            <input class="ios-switch__input"
                                   type="checkbox"
                                   data-role="account-toggle"
                                   data-account-id="{{ acc.id }}"
                                   data-payment-blocked="{{ 1 if acc.blocked_for_payment else 0 }}"
                                   data-active-state="{{ 1 if acc.is_active else 0 }}"
                                   {% if acc.is_active %}checked{% endif %}>
                            <span class="ios-switch__slider" aria-hidden="true"></span>
                        </label>
                    </button>
                {% endfor %}
                <div class="manage-modern__search-empty" data-role="accounts-search-empty" hidden>
                    Фермы не найдены по вашему запросу.
                </div>
            {% else %}
                <div class="manage-empty">Активных ферм нет.</div>
            {% endif %}
        </div>

        <div class="manage-modern__column manage-modern__column--steps">
            <div class="manage-modern__tabs manage-steps" data-role="manage-steps"></div>
        </div>

        <div class="manage-modern__column manage-modern__column--config">
            <div class="manage-modern__config manage-config" data-role="manage-config"></div>
        </div>
    </div>
</div>

<div class="modal copy-settings-modal" data-role="copy-settings-modal" hidden>
    <div class="modal-backdrop" data-role="copy-settings-close"></div>
    <div class="modal-dialog copy-settings-modal__dialog">
        <div class="modal-header">
            <div>
                <div class="copy-settings-modal__title">Копирование настроек</div>
                <div class="copy-settings-modal__subtitle">Перенесите manage-настройки из другой фермы.</div>
            </div>
            <button class="modal-close-btn" type="button" data-role="copy-settings-close" aria-label="Закрыть">×</button>
        </div>
        <div class="modal-body">
            <div class="copy-settings-modal__grid">
                <div class="copy-settings-modal__section">
                    <div class="copy-settings-modal__label">Целевая ферма</div>
                    <div class="copy-settings-modal__target" data-role="copy-target">—</div>
                </div>
                <div class="copy-settings-modal__section">
                    <label class="copy-settings-modal__label" for="copy-source-select">Источник настроек</label>
                    <select class="form-input copy-settings-modal__select" id="copy-source-select" data-role="copy-source-select">
                        <option value="">Выберите ферму</option>
                    </select>
                    <div class="copy-settings-modal__meta" data-role="copy-source-meta"></div>
                </div>
            </div>
            <div class="copy-settings-modal__divider"></div>
            <div class="copy-settings-modal__note">
                <div class="copy-settings-modal__note-title">Что будет скопировано</div>
                <ul class="copy-settings-modal__list">
                    <li>Состояния шагов (включён/выключен).</li>
                    <li>Настройки Config и расписание ScheduleRules.</li>
                    <li>Шаги, которых нет в целевой ферме, будут пропущены.</li>
                </ul>
            </div>
            <label class="config-checkbox copy-settings-modal__confirm">
                <input class="config-checkbox__input" type="checkbox" data-role="copy-confirm">
                <span class="config-checkbox__box"></span>
                <span class="config-checkbox__label">Подтверждаю, что текущие настройки фермы будут перезаписаны.</span>
            </label>
            <div class="copy-settings-modal__status" data-role="copy-status"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" type="button" data-role="copy-settings-close">Отмена</button>
            <button class="btn btn-primary" type="button" data-role="copy-settings-confirm" disabled>Копировать</button>
        </div>
    </div>
</div>

{% if steps_error %}
    <div class="manage-error">{{ steps_error }}</div>
{% endif %}

<script>
    {% set details_url = url_for('client.manage_account_details', account_id=0) %}
    {% set toggle_url = url_for('client.account_toggle_step', account_id=0, step_idx=0) %}
    {% set update_url = url_for('client.manage_update_step', account_id=0, step_idx=0) %}
    {% set account_toggle_url = url_for('client.manage_toggle_account_active', account_id=0) %}
    {% set apply_defaults_url = url_for('client.manage_apply_defaults', account_id=0) %}
    {% set copy_settings_url = url_for('admin.copy_account_settings', account_id=0) %}

    window.manageIsAdmin = true;
    window.manageInitialState = {
        selectedAccountId: {{ selected_account.id if selected_account else 'null' }},
        selectedAccountName: {{ (selected_account.name if selected_account else '')|tojson }},
        selectedServerName: {{ (selected_account.server.name if selected_account and selected_account.server else '')|tojson }},
        selectedAccountTariffPrice: {{ selected_tariff_price if selected_tariff_price is not none else 'null' }},
        selectedAccountTariffName: {{ (selected_tariff_name or '')|tojson }},
        selectedAccountHasDefaults: {{ selected_has_defaults|tojson }},
        steps: {{ view_steps|tojson }},
        rawSteps: {{ raw_steps|tojson }},
        raw_steps: {{ raw_steps|tojson }},
        visibilityMap: {{ visibility_map|tojson }},
        scriptLabels: {{ script_labels_map|tojson }},
        menu: {{ menu_data|tojson }},
        debugInfo: {{ debug_info|tojson }},
        detailsUrlTemplate: {{ details_url.replace('0', '__ACCOUNT__', 1)|tojson }},
        toggleUrlTemplate: {{ toggle_url.replace('0', '__ACCOUNT__', 1).replace('0', '__STEP__', 1)|tojson }},
        updateUrlTemplate: {{ update_url.replace('0', '__ACCOUNT__', 1).replace('0', '__STEP__', 1)|tojson }},
        accountToggleUrlTemplate: {{ account_toggle_url.replace('0', '__ACCOUNT__', 1)|tojson }},
        applyDefaultsUrlTemplate: {{ apply_defaults_url.replace('0', '__ACCOUNT__', 1)|tojson }},
        copySettingsUrlTemplate: {{ copy_settings_url.replace('0', '__ACCOUNT__', 1)|tojson }},
    };

    function goBack() {
        window.location.href = {{ url_for('admin.admin_dashboard')|tojson }};
    }

    window.manageAdminAccounts = [
        {% for acc in accounts %}
        {
            id: {{ acc.id }},
            name: {{ acc.name|tojson }},
            server: {{ (acc.server.name if acc.server else 'N/A')|tojson }},
            owner: {{ (acc.owner.username if acc.owner else '—')|tojson }},
            is_active: {{ 1 if acc.is_active else 0 }},
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>
<script src="{{ url_for('static', filename='js/manage.js') }}"></script>
{% endblock %}
