{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω-–¥—ç—à–±–æ—Ä–¥{% endblock %}

{% block content %}
<style>
    /* –ü—Ä—è—á–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –∞–¥–º–∏–Ω–∫–µ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ. */
    #globalLoader,
    #globalLoader.show {
        display: none !important;
    }
</style>
<h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>

<div class="admin-top-grid">
    {% if payment_cards %}
        <div class="admin-top-grid__left" data-role="payments-panel">
            <div class="admin-payment-panel">
                <div class="admin-payment-panel__header">
                    <div>
                        <h2 class="admin-payment-panel__title">–ë–ª–∏–∂–∞–π—à–∏–µ –æ–ø–ª–∞—Ç—ã</h2>
                        <div class="admin-payment-panel__subtitle">
                            –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∏ –±–ª–∏–∂–∞–π—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π. –ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫.
                        </div>
                    </div>
                    <button class="admin-payment-panel__expand" type="button" data-role="open-payment-modal">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                </div>
                <div class="admin-payment-panel__list" data-role="payments-list">
                    {% for item in payment_cards %}
                        {% set acc = item.account %}
                        {% set owner_name = acc.owner.username if acc.owner else '‚Äî' %}
                        {% set server_name = acc.server.name if acc.server else 'N/A' %}
                        {% set message_text = '–ü—Ä–∏–≤–µ—Ç! ‚õè \n–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É.\n–ü—Ä–æ–¥–ª–µ–≤–∞–µ–º?' %}
                        <div class="admin-payment-card admin-payment-card--{{ item.status }} {% if item.blocked_for_payment %}is-blocked{% endif %}"
                             data-payment-card
                             data-account-id="{{ acc.id }}"
                             data-account-name="{{ acc.name }}"
                             data-owner="{{ owner_name }}"
                             data-server="{{ server_name }}"
                             data-pay-date="{{ item.pay_date.strftime('%d.%m.%Y') }}"
                             data-amount="{{ item.amount if item.amount is not none else '' }}"
                             data-status="{{ item.status }}"
                             data-telegram-link="{{ item.telegram_link or '' }}"
                             data-blocked="{{ 1 if item.blocked_for_payment else 0 }}">
                            <div class="admin-payment-card__main">
                                <div class="admin-payment-card__title">{{ acc.name }}</div>
                                <div class="admin-payment-card__meta">{{ owner_name }} ‚Äî {{ server_name }}</div>
                                <div class="admin-payment-card__date">–û–ø–ª–∞—Ç–∞ –¥–æ {{ item.pay_date.strftime('%d.%m.%Y') }}</div>
                                {% if item.amount is not none %}
                                    <div class="admin-payment-card__amount">{{ item.amount }} ‚ÇΩ</div>
                                {% endif %}
                                {% if item.blocked_for_payment %}
                                    <div class="admin-payment-card__badge">–û—Ç–∫–ª—é—á–µ–Ω–∞ –∑–∞ –Ω–µ–æ–ø–ª–∞—Ç—É</div>
                                {% endif %}
                            </div>
                            <div class="admin-payment-card__actions">
                                <button type="button" class="icon-btn" data-role="payment-paid" title="–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞">‚úî</button>
                                <button type="button" class="icon-btn icon-btn--danger" data-role="payment-unpaid" title="–û—Ç–∫–ª—é—á–∏—Ç—å –∑–∞ –Ω–µ–æ–ø–ª–∞—Ç—É">‚úñ</button>
                                {% if item.telegram_link %}
                                    <a class="icon-btn" target="_blank" rel="noopener"
                                       href="{{ item.telegram_link }}?text={{ message_text|urlencode }}"
                                       title="–ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É">‚úé</a>
                                {% else %}
                                    <span class="icon-btn icon-btn--disabled" title="–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞">‚úé</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="admin-top-grid__right">
        <div class="kpi-row kpi-row--stacked">
            <button class="kpi-card kpi-card--clickable cash-card" type="button" data-role="cash-card"
                    data-cash-monthly="{{ cash_totals.monthly_total }}"
                    data-cash-remaining="{{ cash_totals.remaining_total }}">
                <div class="kpi-label">Ca$h</div>
                <div class="cash-card__value" data-role="cash-card-total">{{ cash_totals.monthly_total }} ‚ÇΩ</div>
                <div class="cash-card__meta" data-role="cash-card-remaining">–î–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞: {{ cash_totals.remaining_total }} ‚ÇΩ</div>
                <div class="cash-card__list" data-role="cash-card-servers"></div>
            </button>
            <button class="kpi-card kpi-card--clickable kpi-card--incomplete" type="button" data-role="incomplete-data-card"
                    data-incomplete-count="{{ incomplete_accounts_total }}">
                <div class="kpi-label">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
                <div class="kpi-value" data-role="incomplete-data-count">{{ incomplete_accounts_total }}</div>
                <div class="kpi-hint">–§–µ—Ä–º—ã –±–µ–∑ –ø–æ—á—Ç—ã, –ø–∞—Ä–æ–ª—è, –æ–ø–ª–∞—Ç—ã –∏–ª–∏ —Ç–∞—Ä–∏—Ñ–∞</div>
            </button>
            <div class="kpi-card">
                <div class="kpi-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—Å–µ–≥–æ</div>
                <div class="kpi-value">{{ total_users }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">–ê–¥–º–∏–Ω–æ–≤</div>
                <div class="kpi-value">{{ total_admins }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div>
                <div class="kpi-value">{{ total_clients }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">–§–µ—Ä–º/–∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
                <div class="kpi-value">{{ total_accounts }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">–°–µ—Ä–≤–µ—Ä–æ–≤</div>
                <div class="kpi-value">{{ total_servers }}</div>
            </div>
        </div>
    </div>
</div>

<div class="admin-watch-panel" data-role="server-states-panel"
     data-endpoint="{{ url_for('admin.api_server_states') }}">
    <div class="admin-watch-panel__header">
        <div>
            <h2 class="admin-watch-panel__title">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤</h2>
            <div class="admin-watch-panel__subtitle">Self‚Äëstatus –±–µ–∑ SSH, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É.</div>
        </div>
        <div class="admin-watch-panel__meta" data-role="server-states-updated"></div>
    </div>

    <div class="admin-watch-grid" data-role="server-states-grid">
        <div class="admin-watch-card admin-watch-card--placeholder">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶</div>
    </div>
</div>

<div class="admin-watch-panel" data-role="watch-cards-panel"
     data-endpoint="{{ url_for('admin.api_watch_cards') }}">
    <div class="admin-watch-panel__header">
        <div>
            <h2 class="admin-watch-panel__title">–ù–∞–±–ª—é–¥–µ–Ω–∏–µ</h2>
            <div class="admin-watch-panel__subtitle">–ö–æ—Ä–æ—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ RSSv7.</div>
        </div>
        <div class="admin-watch-panel__meta" data-role="watch-cards-updated"></div>
    </div>

    <div class="admin-watch-grid" data-role="watch-cards-grid">
        <div class="admin-watch-card admin-watch-card--placeholder">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶</div>
    </div>
</div>

<div class="cash-modal" data-role="cash-modal" hidden>
    <div class="cash-modal__dialog">
        <div class="cash-modal__header">
            <div>
                <div class="cash-modal__title">Ca$h</div>
                <div class="cash-modal__subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏ —É–∫–∞–∂–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É—á–µ—Å—Ç—å –≤ –ø—Ä–∏–±—ã–ª–∏.</div>
            </div>
            <button class="cash-modal__close" type="button" data-role="cash-modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        </div>

        <div class="cash-modal__content" data-role="cash-modal-content"></div>

        <div class="cash-modal__footer">
            <div class="cash-modal__summary" data-role="cash-modal-summary"></div>
            <button class="btn" type="button" data-role="cash-modal-close">–ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<div class="incomplete-data-modal" data-role="incomplete-data-modal" hidden>
    <div class="incomplete-data-modal__dialog">
        <button class="incomplete-data-modal__close" type="button" data-role="incomplete-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        <div class="incomplete-data-modal__header">
            <div class="incomplete-data-modal__title">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
            <div class="incomplete-data-modal__subtitle">
                –î–æ–±–∞–≤—å—Ç–µ –ø–æ—á—Ç—É, –ø–∞—Ä–æ–ª—å, –¥–∞—Ç—É –æ–ø–ª–∞—Ç—ã –∏ —Ç–∞—Ä–∏—Ñ –¥–ª—è –≤—Å–µ—Ö —Ñ–µ—Ä–º –±–µ–∑ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
            </div>
        </div>

        <div class="incomplete-data-modal__body">
            <div class="incomplete-data-modal__loader" data-role="incomplete-loader">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–µ—Ä–º‚Ä¶</div>
            <div class="incomplete-data-modal__empty" data-role="incomplete-empty" hidden>–í—Å–µ —Ñ–µ—Ä–º—ã —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.</div>
            <div class="incomplete-data-modal__table-wrapper" data-role="incomplete-table" hidden>
                <table class="incomplete-data-modal__table">
                    <thead>
                    <tr>
                        <th>–§–µ—Ä–º–∞</th>
                        <th>–ü–æ—á—Ç–∞</th>
                        <th>–ü–∞—Ä–æ–ª—å</th>
                        <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                        <th>–¢–∞—Ä–∏—Ñ, ‚ÇΩ</th>
                    </tr>
                    </thead>
                    <tbody data-role="incomplete-rows"></tbody>
                </table>
            </div>
        </div>

        <div class="incomplete-data-modal__footer">
            <div class="incomplete-data-modal__status" data-role="incomplete-status"></div>
            <div class="incomplete-data-modal__actions">
                <button class="btn btn-ghost" type="button" data-role="incomplete-close">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn" type="button" data-role="incomplete-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script id="cash-data" type="application/json">{{ {
    "servers": server_profits,
    "monthly_total": cash_totals.monthly_total,
    "remaining_total": cash_totals.remaining_total,
    "days_in_month": cash_totals.days_in_month,
    "days_left": cash_totals.days_left,
} | tojson }}</script>

<script>
    (function () {
        const cashCard = document.querySelector('[data-role="cash-card"]');
        const modal = document.querySelector('[data-role="cash-modal"]');
        const modalContent = document.querySelector('[data-role="cash-modal-content"]');
        const modalSummary = document.querySelector('[data-role="cash-modal-summary"]');
        const cashDataEl = document.getElementById('cash-data');
        const serversList = document.querySelector('[data-role="cash-card-servers"]');
        const totalLabel = document.querySelector('[data-role="cash-card-total"]');
        const remainingLabel = document.querySelector('[data-role="cash-card-remaining"]');
        const LOCAL_STORAGE_KEY = 'usersdash-cash-settings';

        if (!cashCard || !cashDataEl) {
            return;
        }

        const cashData = JSON.parse(cashDataEl.textContent || '{}');
        const servers = Array.isArray(cashData.servers) ? cashData.servers : [];
        const daysInMonth = cashData.days_in_month || 30;
        const daysLeft = cashData.days_left || daysInMonth;

        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.max(0, Math.round(amount))) + ' ‚ÇΩ';
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (!saved) return null;
                return JSON.parse(saved);
            } catch (err) {
                return null;
            }
        }

        function saveSettings(settings) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(settings));
        }

        function getInitialSettings() {
            const saved = loadSettings();
            if (saved && typeof saved === 'object') {
                return saved;
            }
            return {
                selected: servers.map((srv) => srv.server_id),
                expenses: {},
            };
        }

        let settings = getInitialSettings();

        function calcTotals(currentSettings) {
            let monthlyTotal = 0;
            let remainingTotal = 0;
            const selectedServers = new Set(currentSettings.selected || []);
            const expenses = currentSettings.expenses || {};

            servers.forEach((srv) => {
                if (!selectedServers.has(srv.server_id)) return;
                const expense = Number(expenses[srv.server_id] || 0);
                const monthly = Math.max(0, (srv.monthly_total || 0) - Math.max(0, expense));
                const remaining = monthly * daysLeft / daysInMonth;
                monthlyTotal += monthly;
                remainingTotal += remaining;
            });

            return {
                monthlyTotal,
                remainingTotal,
                selectedCount: selectedServers.size,
            };
        }

        function renderModalContent() {
            const selectedServers = new Set(settings.selected || []);
            const expenses = settings.expenses || {};
            modalContent.innerHTML = servers.map((srv) => {
                const expense = expenses[srv.server_id] || '';
                const srvRemaining = Math.floor((srv.monthly_total || 0) * daysLeft / daysInMonth);
                const activeAccounts = srv.active_accounts || 0;
                const serverLabel = `${srv.server_name} (${activeAccounts})`;
                return `
                    <label class="cash-modal__row">
                        <div class="cash-modal__row-main">
                            <input type="checkbox" class="cash-modal__checkbox" data-server-id="${srv.server_id}" ${selectedServers.has(srv.server_id) ? 'checked' : ''}>
                            <div>
                                <div class="cash-modal__server">${serverLabel}</div>
                                <div class="cash-modal__server-meta">${formatMoney(srv.monthly_total || 0)} ¬∑ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞ ${formatMoney(srvRemaining)}</div>
                            </div>
                        </div>
                        <div class="cash-modal__expenses">
                            <div class="cash-modal__expenses-label">–†–∞—Å—Ö–æ–¥</div>
                            <div class="cash-modal__expenses-input">
                                <input type="number" min="0" step="100" value="${expense}" data-expense-input data-server-id="${srv.server_id}" aria-label="–†–∞—Å—Ö–æ–¥ –¥–ª—è ${srv.server_name}">
                                <span>‚ÇΩ</span>
                            </div>
                        </div>
                    </label>
                `;
            }).join('');
        }

        function renderCardServers() {
            if (!serversList) return;

            const selectedServers = new Set(settings.selected || []);
            const expenses = settings.expenses || {};

            const rows = servers
                .filter((srv) => selectedServers.has(srv.server_id))
                .map((srv) => {
                    const expense = Number(expenses[srv.server_id] || 0);
                    const monthly = Math.max(0, (srv.monthly_total || 0) - Math.max(0, expense));
                    const remaining = Math.max(0, Math.round(monthly * daysLeft / daysInMonth));
                    const activeAccounts = srv.active_accounts || 0;
                    const serverLabel = `${srv.server_name} (${activeAccounts})`;
                    return `
                        <div class="cash-card__server-row">
                            <span class="cash-card__server-name">${serverLabel}</span>
                            <span class="cash-card__server-amount">${formatMoney(monthly)} ¬∑ ${formatMoney(remaining)}</span>
                        </div>
                    `;
                });

            serversList.innerHTML = rows.join('') || '<div class="cash-card__server-empty">–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
        }

        function updateCard() {
            const totals = calcTotals(settings);
            totalLabel.textContent = formatMoney(totals.monthlyTotal);
            remainingLabel.textContent = `–î–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞: ${formatMoney(totals.remainingTotal)}`;
            renderCardServers();
            if (modalSummary) {
                modalSummary.textContent = `${formatMoney(totals.monthlyTotal)} ¬∑ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞ ${formatMoney(totals.remainingTotal)}`;
            }
        }

        function persistExpense(event) {
            const expenseInput = event.target.closest('[data-expense-input]');
            if (!expenseInput) return;

            const srvId = Number(expenseInput.dataset.serverId);
            const value = Number(expenseInput.value || 0);
            settings.expenses = {
                ...settings.expenses,
                [srvId]: Math.max(0, value),
            };
            saveSettings(settings);
            updateCard();
        }

        function attachModalHandlers() {
            modalContent.addEventListener('input', persistExpense);
            modalContent.addEventListener('change', (event) => {
                const checkbox = event.target.closest('.cash-modal__checkbox');
                if (checkbox) {
                    const srvId = Number(checkbox.dataset.serverId);
                    const nextSelected = new Set(settings.selected || []);
                    if (checkbox.checked) {
                        nextSelected.add(srvId);
                    } else {
                        nextSelected.delete(srvId);
                    }
                    settings.selected = Array.from(nextSelected);
                    saveSettings(settings);
                    updateCard();
                    return;
                }

                persistExpense(event);
            });
        }

        function openModal() {
            modal.hidden = false;
            modal.classList.add('is-open');
        }

        function closeModal() {
            modal.classList.remove('is-open');
            modal.hidden = true;
        }

        cashCard.addEventListener('click', openModal);
        document.querySelectorAll('[data-role="cash-modal-close"]').forEach((btn) => {
            btn.addEventListener('click', closeModal);
        });

        renderModalContent();
        attachModalHandlers();
        updateCard();
    })();
</script>

<script>
    (() => {
        const card = document.querySelector('[data-role="incomplete-data-card"]');
        const modal = document.querySelector('[data-role="incomplete-data-modal"]');
        const loader = modal?.querySelector('[data-role="incomplete-loader"]');
        const empty = modal?.querySelector('[data-role="incomplete-empty"]');
        const tableWrap = modal?.querySelector('[data-role="incomplete-table"]');
        const rowsBody = modal?.querySelector('[data-role="incomplete-rows"]');
        const statusEl = modal?.querySelector('[data-role="incomplete-status"]');
        const saveBtn = modal?.querySelector('[data-role="incomplete-save"]');
        const countEl = card?.querySelector('[data-role="incomplete-data-count"]');
        const fetchUrl = "{{ url_for('admin.api_incomplete_farm_data') }}";
        const saveUrl = "{{ url_for('admin.admin_farm_data_save') }}";

        if (!card || !modal || !fetchUrl || !saveUrl) {
            return;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : String(text);
            return div.innerHTML;
        }

        function setStatus(text, tone) {
            if (!statusEl) return;
            statusEl.textContent = text || '';
            statusEl.classList.remove('is-success', 'is-error', 'is-warning');
            if (tone) {
                statusEl.classList.add(`is-${tone}`);
            }
        }

        function buildRow(item) {
            const row = document.createElement('tr');
            row.dataset.accountId = item.account_id;
            const missing = item.missing || {};
            const missingLabels = [];
            if (missing.email) missingLabels.push('–ø–æ—á—Ç–∞');
            if (missing.password) missingLabels.push('–ø–∞—Ä–æ–ª—å');
            if (missing.next_payment_date) missingLabels.push('–¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã');
            if (missing.tariff) missingLabels.push('—Ç–∞—Ä–∏—Ñ');

            row.innerHTML = `
                <td>
                    <div class="incomplete-data-modal__name">${escapeHtml(item.farm_name || '')}</div>
                    <div class="incomplete-data-modal__meta">${escapeHtml(item.owner_name || '‚Äî')} ¬∑ ${escapeHtml(item.server_bot || '‚Äî')}</div>
                    <div class="incomplete-data-modal__missing">–ó–∞–ø–æ–ª–Ω–∏—Ç—å: ${missingLabels.join(', ') || '‚Äî'}</div>
                </td>
                <td><input class="incomplete-data-modal__input" type="email" name="email" value="${escapeHtml(item.email || '')}" placeholder="email@example.com"></td>
                <td><input class="incomplete-data-modal__input" type="text" name="password" value="${escapeHtml(item.password || '')}" placeholder="–ü–∞—Ä–æ–ª—å"></td>
                <td><input class="incomplete-data-modal__input" type="date" name="next_payment_date" value="${escapeHtml(item.next_payment_at || '')}"></td>
                <td><input class="incomplete-data-modal__input" type="number" min="0" step="50" name="tariff" value="${escapeHtml(item.tariff ?? '')}" placeholder="‚ÇΩ"></td>
            `;

            return row;
        }

        function collectRows() {
            if (!rowsBody) return [];
            return Array.from(rowsBody.querySelectorAll('tr')).map((row) => {
                const getVal = (name) => {
                    const input = row.querySelector(`[name="${name}"]`);
                    return input ? input.value : '';
                };
                return {
                    account_id: Number(row.dataset.accountId),
                    email: getVal('email'),
                    password: getVal('password'),
                    next_payment_date: getVal('next_payment_date'),
                    tariff: getVal('tariff'),
                };
            });
        }

        async function loadData() {
            if (!loader || !empty || !tableWrap || !rowsBody) return;
            loader.hidden = false;
            empty.hidden = true;
            tableWrap.hidden = true;
            rowsBody.innerHTML = '';
            setStatus('');

            try {
                const resp = await fetch(fetchUrl, { headers: { Accept: 'application/json', 'x-skip-loader': '1' } });
                if (!resp.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ (HTTP).');
                }
                const data = await resp.json();
                const items = Array.isArray(data.items) ? data.items : [];
                const total = Number(data.total || 0);
                if (countEl) {
                    countEl.textContent = total;
                }
                card.dataset.incompleteCount = total;
                if (!items.length) {
                    empty.hidden = false;
                    return;
                }
                items.forEach((item) => rowsBody.appendChild(buildRow(item)));
                tableWrap.hidden = false;
            } catch (err) {
                console.error(err);
                setStatus(err.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.', 'error');
            } finally {
                loader.hidden = true;
            }
        }

        async function saveData() {
            const items = collectRows();
            if (!items.length) {
                setStatus('–ù–µ—Ç —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.', 'warning');
                return;
            }

            setStatus('–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è‚Ä¶');
            if (saveBtn) saveBtn.disabled = true;
            try {
                const resp = await fetch(saveUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'x-skip-loader': '1',
                    },
                    body: JSON.stringify({ items }),
                });
                const data = await resp.json();
                if (!resp.ok || !data.ok) {
                    throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.');
                }

                if (Array.isArray(data.warnings) && data.warnings.length) {
                    setStatus(data.warnings.join('\n'), 'warning');
                } else {
                    setStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.', 'success');
                }

                await loadData();
            } catch (err) {
                console.error(err);
                setStatus(err.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.', 'error');
            } finally {
                if (saveBtn) saveBtn.disabled = false;
            }
        }

        function openModal() {
            modal.hidden = false;
            modal.classList.add('is-open');
            loadData();
        }

        function closeModal() {
            modal.classList.remove('is-open');
            modal.hidden = true;
        }

        card.addEventListener('click', openModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });
        modal.querySelectorAll('[data-role="incomplete-close"]').forEach((btn) => {
            btn.addEventListener('click', closeModal);
        });
        if (saveBtn) {
            saveBtn.addEventListener('click', saveData);
        }
    })();
</script>

<p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Å–µ—Ä–≤–µ—Ä–∞–º–∏ –∏ —Ñ–µ—Ä–º–∞–º–∏.</p>

{% if payment_cards %}
    <div class="admin-payment-modal" data-role="payment-modal" hidden>
        <div class="admin-payment-modal__dialog">
            <button class="admin-payment-modal__close" type="button" data-role="payment-modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            <div class="admin-payment-modal__body">
                <div class="admin-payment-modal__title">–í—Å–µ –æ–ø–ª–∞—Ç—ã</div>
                <div class="admin-payment-modal__subtitle">–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏.</div>
                <div class="admin-payment-modal__list" data-role="payment-modal-list"></div>
            </div>
        </div>
    </div>
{% endif %}

{% if accounts_data %}
    <h2 style="margin-top: 32px;">–†–µ—Å—É—Ä—Å—ã —Ñ–µ—Ä–º</h2>
    <div class="dashboard-filters">
        <div class="filter-block">
            <div class="filter-label">–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫</div>
            <input
                type="search"
                class="form-input filter-input"
                placeholder="–ò–º—è —Ñ–µ—Ä–º—ã, —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü"
                aria-label="–ü–æ–∏—Å–∫ —Ñ–µ—Ä–º"
                data-role="account-search"
            />
            <div class="filter-hint">–§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ä–∞–∑—É –ø–æ –º–µ—Ä–µ –≤–≤–æ–¥–∞</div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table" data-role="accounts-table"
               data-resources-endpoint="{{ url_for('admin.api_account_resources') }}">
            <thead>
            <tr>
                <th>–ò–º—è —Ñ–µ—Ä–º—ã</th>
                <th>–°–µ—Ä–≤–µ—Ä</th>
                <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                <th>–†–µ—Å—É—Ä—Å—ã (Food üçó / Wood üå≤ / Stone üß± / Gold üìÄ)</th>
                <th>–ü—Ä–∏—Ä–æ—Å—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è</th>
                <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            {% for item in accounts_data %}
                {% set acc = item.account %}
                <tr
                    data-account-id="{{ acc.id }}"
                    data-account-row
                    data-search-text="{{ (acc.name ~ ' ' ~ (acc.server.name if acc.server else '') ~ ' ' ~ (acc.owner.username if acc.owner else ''))|trim }}"
                >
                    <td>{{ acc.name }}</td>
                    <td>{{ acc.server.name if acc.server else "N/A" }}</td>
                    <td>{{ acc.owner.username if acc.owner else "‚Äî" }}</td>
                    <td data-role="resources" data-state="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                    <td data-role="today-gain" data-state="loading">‚Äî</td>
                    <td data-role="last-updated" data-state="loading">‚Äî</td>
                    <td class="actions-cell">
                        <a href="{{ url_for('admin.manage', account_id=acc.id) }}" class="action-pill">
                            <span class="btn-icon-symbol">‚öô</span>
                            <span class="btn-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </a>

                        <button class="action-pill action-pill--ghost"
                                data-action="refresh-account"
                                data-account-id="{{ acc.id }}">
                            <span class="btn-text">–û–±–Ω–æ–≤–∏—Ç—å</span>
                            <span class="btn-spinner" hidden></span>
                        </button>
                    </td>
                </tr>
            {% endfor %}
            <tr data-role="account-search-empty" hidden>
                <td colspan="7" class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É.</td>
            </tr>
            </tbody>
        </table>
    </div>
{% else %}
    <p>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–µ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
{% endif %}

{% if payment_cards %}
<script>
    (() => {
        const panel = document.querySelector('[data-role="payments-panel"]');
        const listEl = document.querySelector('[data-role="payments-list"]');
        const modal = document.querySelector('[data-role="payment-modal"]');
        const modalList = document.querySelector('[data-role="payment-modal-list"]');
        const expandBtn = document.querySelector('[data-role="open-payment-modal"]');
        if (!panel || !listEl) return;

        const paidUrl = {{ url_for('admin.mark_account_paid', account_id=0)|tojson }};
        const unpaidUrl = {{ url_for('admin.mark_account_unpaid', account_id=0)|tojson }};

        let lastInteractionAt = Date.now();
        let hideTimerId = null;

        function stampInteraction() {
            lastInteractionAt = Date.now();
            if (hideTimerId) return;
            hideTimerId = window.setTimeout(checkInactivity, 4000);
        }

        function checkInactivity() {
            const sinceLast = Date.now() - lastInteractionAt;
            if (sinceLast >= 4000) {
                prunePendingRows();
                hideTimerId = null;
            } else {
                hideTimerId = window.setTimeout(checkInactivity, 4000 - sinceLast);
            }
        }

        function getCardsByAccount(accountId) {
            return Array.from(document.querySelectorAll(`[data-payment-card][data-account-id="${accountId}"]`));
        }

        function markForRemoval(accountId) {
            getCardsByAccount(accountId).forEach((card) => {
                card.dataset.removePending = '1';
                card.classList.add('is-pending-removal');
            });
            stampInteraction();
        }

        function prunePendingRows() {
            const toRemove = document.querySelectorAll('[data-payment-card][data-remove-pending="1"]');
            toRemove.forEach((el) => el.remove());

            const stillCards = document.querySelectorAll('[data-payment-card]').length > 0;
            if (!stillCards) {
                panel.hidden = true;
                if (modal) modal.hidden = true;
            }
        }

        function applyBlockedState(accountId, blocked) {
            getCardsByAccount(accountId).forEach((card) => {
                card.dataset.blocked = blocked ? '1' : '0';
                card.classList.toggle('is-blocked', blocked);
            });
        }

        function cloneCard(card) {
            const clone = card.cloneNode(true);
            clone.dataset.accountId = card.dataset.accountId;
            return clone;
        }

        function renderModalList() {
            if (!modalList) return;
            modalList.innerHTML = '';
            listEl.querySelectorAll('[data-payment-card]').forEach((card) => {
                const clone = cloneCard(card);
                modalList.appendChild(clone);
            });
        }

        function closeModal() {
            if (modal) {
                modal.hidden = true;
                modal.classList.remove('is-open');
            }
        }

        function openModal() {
            if (!modal) return;
            renderModalList();
            modal.hidden = false;
            modal.classList.add('is-open');
        }

        async function handleAction(card, kind) {
            if (!card) return;
            const accountId = card.dataset.accountId;
            const endpoint = kind === 'paid' ? paidUrl : unpaidUrl;
            const url = (endpoint || '').replace('0', accountId);
            const btns = card.querySelectorAll('.icon-btn');
            btns.forEach((btn) => {
                if ('disabled' in btn) btn.disabled = true;
                btn.classList.add('is-loading');
            });
            try {
                const resp = await fetch(url, { method: 'POST', headers: { 'x-skip-loader': '1' } });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok || !data.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É');
                if (kind === 'paid') {
                    markForRemoval(accountId);
                } else {
                    applyBlockedState(accountId, true);
                    markForRemoval(accountId);
                }
            } catch (err) {
                console.error(err);
                alert(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É');
            } finally {
                btns.forEach((btn) => {
                    if ('disabled' in btn) btn.disabled = false;
                    btn.classList.remove('is-loading');
                });
            }
        }

        function handleClick(event, scope) {
            stampInteraction();
            const card = event.target.closest('[data-payment-card]');
            if (event.target.closest('[data-role="payment-paid"]')) {
                event.stopPropagation();
                handleAction(card, 'paid');
                return;
            }
            if (event.target.closest('[data-role="payment-unpaid"]')) {
                event.stopPropagation();
                handleAction(card, 'unpaid');
                return;
            }
            if (scope === 'panel') {
                openModal();
            }
        }

        listEl.addEventListener('click', (event) => handleClick(event, 'panel'));
        if (modalList) {
            modalList.addEventListener('click', (event) => handleClick(event, 'modal'));
        }

        if (panel) {
            panel.addEventListener('click', stampInteraction, { capture: true });
        }

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });
        }

        if (expandBtn) expandBtn.addEventListener('click', () => {
            stampInteraction();
            openModal();
        });

        const closeBtn = document.querySelector('[data-role="payment-modal-close"]');
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
    })();
</script>
{% endif %}
{% endblock %}
