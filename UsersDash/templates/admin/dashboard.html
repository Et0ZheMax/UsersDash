{% extends "base.html" %}

{% block title %}Админ-дэшборд{% endblock %}

{% block content %}
<h1>Админ-панель</h1>

<div class="admin-top-grid">
    {% if payment_cards %}
        <div class="admin-top-grid__left" data-role="payments-panel">
            <div class="admin-payment-panel">
                <div class="admin-payment-panel__header">
                    <div>
                        <h2 class="admin-payment-panel__title">Ближайшие оплаты</h2>
                        <div class="admin-payment-panel__subtitle">
                            Просмотр просроченных и ближайших платежей. Кликните, чтобы раскрыть полный список.
                        </div>
                    </div>
                    <button class="admin-payment-panel__expand" type="button" data-role="open-payment-modal">Развернуть</button>
                </div>
                <div class="admin-payment-panel__list" data-role="payments-list">
                    {% for item in payment_cards %}
                        {% set acc = item.account %}
                        {% set owner_name = acc.owner.username if acc.owner else '—' %}
                        {% set server_name = acc.server.name if acc.server else 'N/A' %}
                        {% set message_text = 'Привет! Нужно продлить бота на ферме ' ~ acc.name ~ '.' %}
                        <div class="admin-payment-card admin-payment-card--{{ item.status }} {% if item.blocked_for_payment %}is-blocked{% endif %}"
                             data-payment-card
                             data-account-id="{{ acc.id }}"
                             data-account-name="{{ acc.name }}"
                             data-owner="{{ owner_name }}"
                             data-server="{{ server_name }}"
                             data-pay-date="{{ item.pay_date.strftime('%d.%m.%Y') }}"
                             data-amount="{{ item.amount if item.amount is not none else '' }}"
                             data-status="{{ item.status }}"
                             data-telegram-link="{{ item.telegram_link or '' }}"
                             data-blocked="{{ 1 if item.blocked_for_payment else 0 }}">
                            <div class="admin-payment-card__main">
                                <div class="admin-payment-card__title">{{ acc.name }}</div>
                                <div class="admin-payment-card__meta">{{ owner_name }} — {{ server_name }}</div>
                                <div class="admin-payment-card__date">Оплата до {{ item.pay_date.strftime('%d.%m.%Y') }}</div>
                                {% if item.amount is not none %}
                                    <div class="admin-payment-card__amount">{{ item.amount }} ₽</div>
                                {% endif %}
                                {% if item.blocked_for_payment %}
                                    <div class="admin-payment-card__badge">Отключена за неоплату</div>
                                {% endif %}
                            </div>
                            <div class="admin-payment-card__actions">
                                <button type="button" class="icon-btn" data-role="payment-paid" title="Оплата получена">✔</button>
                                <button type="button" class="icon-btn icon-btn--danger" data-role="payment-unpaid" title="Отключить за неоплату">✖</button>
                                {% if item.telegram_link %}
                                    <a class="icon-btn" target="_blank" rel="noopener"
                                       href="{{ item.telegram_link }}?text={{ message_text|urlencode }}"
                                       title="Написать клиенту">✎</a>
                                {% else %}
                                    <span class="icon-btn icon-btn--disabled" title="Нет контакта">✎</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="admin-top-grid__right">
        <div class="kpi-row kpi-row--stacked">
            <button class="kpi-card kpi-card--clickable cash-card" type="button" data-role="cash-card"
                    data-cash-monthly="{{ cash_totals.monthly_total }}"
                    data-cash-remaining="{{ cash_totals.remaining_total }}">
                <div class="kpi-label">Ca$h</div>
                <div class="cash-card__value" data-role="cash-card-total">{{ cash_totals.monthly_total }} ₽</div>
                <div class="cash-card__meta" data-role="cash-card-remaining">До конца месяца: {{ cash_totals.remaining_total }} ₽</div>
                <div class="cash-card__list" data-role="cash-card-servers"></div>
            </button>
            <div class="kpi-card">
                <div class="kpi-label">Пользователей всего</div>
                <div class="kpi-value">{{ total_users }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Админов</div>
                <div class="kpi-value">{{ total_admins }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Клиентов</div>
                <div class="kpi-value">{{ total_clients }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Ферм/аккаунтов</div>
                <div class="kpi-value">{{ total_accounts }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Серверов</div>
                <div class="kpi-value">{{ total_servers }}</div>
            </div>
        </div>
    </div>
</div>

{% if server_states %}
    <div class="admin-watch-panel">
        <div class="admin-watch-panel__header">
            <div>
                <h2 class="admin-watch-panel__title">Состояние серверов</h2>
                <div class="admin-watch-panel__subtitle">Self‑status без SSH, обновляется примерно раз в минуту.</div>
            </div>
        </div>

        <div class="admin-watch-grid" data-role="server-states-grid">
            {% for srv in server_states %}
                <div class="admin-watch-card{% if srv.error %} is-error{% endif %}">
                    <div class="admin-watch-card__title">{{ srv.name }}</div>
                    <div class="admin-watch-card__meta">
                        {% if srv.error %}
                            Ошибка: {{ srv.error }}
                        {% else %}
                            Обновлено {{ srv.updated or '—' }}
                        {% endif %}
                    </div>

                    <div class="admin-watch-card__list">
                        <div class="admin-watch-card__row">
                            <span class="admin-watch-card__name">Ping</span>
                            <span class="admin-watch-card__summary">{{ 'OK' if srv.ping else '—' }}</span>
                        </div>
                        <div class="admin-watch-card__row">
                            <span class="admin-watch-card__name">GnBots</span>
                            <span class="admin-watch-card__summary">{{ 'OK' if srv.gn else '—' }}</span>
                        </div>
                        <div class="admin-watch-card__row">
                            <span class="admin-watch-card__name">LD</span>
                            <span class="admin-watch-card__summary">{{ srv.dn_count if srv.dn_count is not none else '—' }}</span>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}

{% if server_states %}
    <script>
        (() => {
            const grid = document.querySelector('[data-role="server-states-grid"]');
            const endpoint = "{{ url_for('admin.api_server_states') }}";

            if (!grid || !endpoint) {
                return;
            }

            function buildRow(label, value) {
                const row = document.createElement('div');
                row.className = 'admin-watch-card__row';

                const name = document.createElement('span');
                name.className = 'admin-watch-card__name';
                name.textContent = label;
                row.appendChild(name);

                const summary = document.createElement('span');
                summary.className = 'admin-watch-card__summary';
                summary.textContent = value;
                row.appendChild(summary);

                return row;
            }

            function renderServerStates(states) {
                grid.innerHTML = '';

                states.forEach((srv) => {
                    const card = document.createElement('div');
                    card.className = 'admin-watch-card';
                    if (srv.error) {
                        card.classList.add('is-error');
                    }

                    const title = document.createElement('div');
                    title.className = 'admin-watch-card__title';
                    title.textContent = srv.name || '—';
                    card.appendChild(title);

                    const meta = document.createElement('div');
                    meta.className = 'admin-watch-card__meta';
                    meta.textContent = srv.error
                        ? `Ошибка: ${srv.error}`
                        : `Обновлено ${srv.updated || '—'}`;
                    card.appendChild(meta);

                    const list = document.createElement('div');
                    list.className = 'admin-watch-card__list';
                    list.appendChild(buildRow('Ping', srv.ping ? 'OK' : '—'));
                    list.appendChild(buildRow('GnBots', srv.gn ? 'OK' : '—'));
                    const dnVal = srv.dn_count !== null && srv.dn_count !== undefined
                        ? srv.dn_count
                        : (srv.dn ? 1 : '—');
                    list.appendChild(buildRow('LD', dnVal));

                    card.appendChild(list);
                    grid.appendChild(card);
                });
            }

            async function refreshServerStates() {
                try {
                    const resp = await fetch(endpoint, { headers: { 'Accept': 'application/json' } });
                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}`);
                    }

                    const data = await resp.json();
                    if (data && Array.isArray(data.items)) {
                        renderServerStates(data.items);
                    }
                } catch (error) {
                    console.error('[server-states] Не удалось обновить раздел:', error);
                }
            }

            refreshServerStates();
            setInterval(refreshServerStates, 60_000);
        })();
    </script>
{% endif %}

{% if watch_cards %}
    <div class="admin-watch-panel">
        <div class="admin-watch-panel__header">
            <div>
                <h2 class="admin-watch-panel__title">Наблюдение</h2>
                <div class="admin-watch-panel__subtitle">Короткая сводка проблем со всех серверов RSSv7.</div>
            </div>
        </div>

        <div class="admin-watch-grid">
            {% for card in watch_cards %}
                <div class="admin-watch-card{% if card.error %} is-error{% endif %}">
                    <div class="admin-watch-card__title">{{ card.server }}</div>
                    <div class="admin-watch-card__meta">
                        {% if card.error %}
                            Ошибка: {{ card.error }}
                        {% elif card.updated %}
                            Обновлено {{ card.updated }}
                        {% else %}
                            Нет свежих данных
                        {% endif %}
                    </div>

                    {% if card.accounts %}
                        <ul class="admin-watch-card__list">
                            {% for item in card.accounts %}
                                <li class="admin-watch-card__row">
                                    <span class="admin-watch-card__name">{{ item.nickname }}</span>
                                    {% if item.summary %}
                                        <span class="admin-watch-card__summary">{{ item.summary }}</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="admin-watch-card__empty">Проблем не обнаружено</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}

<div class="cash-modal" data-role="cash-modal" hidden>
    <div class="cash-modal__dialog">
        <div class="cash-modal__header">
            <div>
                <div class="cash-modal__title">Ca$h</div>
                <div class="cash-modal__subtitle">Выберите сервера и укажите расходы, которые нужно учесть в прибыли.</div>
            </div>
            <button class="cash-modal__close" type="button" data-role="cash-modal-close" aria-label="Закрыть">×</button>
        </div>

        <div class="cash-modal__content" data-role="cash-modal-content"></div>

        <div class="cash-modal__footer">
            <div class="cash-modal__summary" data-role="cash-modal-summary"></div>
            <button class="btn" type="button" data-role="cash-modal-close">Готово</button>
        </div>
    </div>
</div>

<script id="cash-data" type="application/json">{{ {
    "servers": server_profits,
    "monthly_total": cash_totals.monthly_total,
    "remaining_total": cash_totals.remaining_total,
    "days_in_month": cash_totals.days_in_month,
    "days_left": cash_totals.days_left,
} | tojson }}</script>

<script>
    (function () {
        const cashCard = document.querySelector('[data-role="cash-card"]');
        const modal = document.querySelector('[data-role="cash-modal"]');
        const modalContent = document.querySelector('[data-role="cash-modal-content"]');
        const modalSummary = document.querySelector('[data-role="cash-modal-summary"]');
        const cashDataEl = document.getElementById('cash-data');
        const serversList = document.querySelector('[data-role="cash-card-servers"]');
        const totalLabel = document.querySelector('[data-role="cash-card-total"]');
        const remainingLabel = document.querySelector('[data-role="cash-card-remaining"]');
        const LOCAL_STORAGE_KEY = 'usersdash-cash-settings';

        if (!cashCard || !cashDataEl) {
            return;
        }

        const cashData = JSON.parse(cashDataEl.textContent || '{}');
        const servers = Array.isArray(cashData.servers) ? cashData.servers : [];
        const daysInMonth = cashData.days_in_month || 30;
        const daysLeft = cashData.days_left || daysInMonth;

        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.max(0, Math.round(amount))) + ' ₽';
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (!saved) return null;
                return JSON.parse(saved);
            } catch (err) {
                return null;
            }
        }

        function saveSettings(settings) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(settings));
        }

        function getInitialSettings() {
            const saved = loadSettings();
            if (saved && typeof saved === 'object') {
                return saved;
            }
            return {
                selected: servers.map((srv) => srv.server_id),
                expenses: {},
            };
        }

        let settings = getInitialSettings();

        function calcTotals(currentSettings) {
            let monthlyTotal = 0;
            let remainingTotal = 0;
            const selectedServers = new Set(currentSettings.selected || []);
            const expenses = currentSettings.expenses || {};

            servers.forEach((srv) => {
                if (!selectedServers.has(srv.server_id)) return;
                const expense = Number(expenses[srv.server_id] || 0);
                const monthly = Math.max(0, (srv.monthly_total || 0) - Math.max(0, expense));
                const remaining = monthly * daysLeft / daysInMonth;
                monthlyTotal += monthly;
                remainingTotal += remaining;
            });

            return {
                monthlyTotal,
                remainingTotal,
                selectedCount: selectedServers.size,
            };
        }

        function renderModalContent() {
            const selectedServers = new Set(settings.selected || []);
            const expenses = settings.expenses || {};
            modalContent.innerHTML = servers.map((srv) => {
                const expense = expenses[srv.server_id] || '';
                const srvRemaining = Math.floor((srv.monthly_total || 0) * daysLeft / daysInMonth);
                return `
                    <label class="cash-modal__row">
                        <div class="cash-modal__row-main">
                            <input type="checkbox" class="cash-modal__checkbox" data-server-id="${srv.server_id}" ${selectedServers.has(srv.server_id) ? 'checked' : ''}>
                            <div>
                                <div class="cash-modal__server">${srv.server_name}</div>
                                <div class="cash-modal__server-meta">${formatMoney(srv.monthly_total || 0)} · до конца месяца ${formatMoney(srvRemaining)}</div>
                            </div>
                        </div>
                        <div class="cash-modal__expenses">
                            <div class="cash-modal__expenses-label">Расход</div>
                            <div class="cash-modal__expenses-input">
                                <input type="number" min="0" step="100" value="${expense}" data-expense-input data-server-id="${srv.server_id}" aria-label="Расход для ${srv.server_name}">
                                <span>₽</span>
                            </div>
                        </div>
                    </label>
                `;
            }).join('');
        }

        function renderCardServers() {
            if (!serversList) return;

            const selectedServers = new Set(settings.selected || []);
            const expenses = settings.expenses || {};

            const rows = servers
                .filter((srv) => selectedServers.has(srv.server_id))
                .map((srv) => {
                    const expense = Number(expenses[srv.server_id] || 0);
                    const monthly = Math.max(0, (srv.monthly_total || 0) - Math.max(0, expense));
                    const remaining = Math.max(0, Math.round(monthly * daysLeft / daysInMonth));
                    return `
                        <div class="cash-card__server-row">
                            <span class="cash-card__server-name">${srv.server_name}</span>
                            <span class="cash-card__server-amount">${formatMoney(monthly)} · ${formatMoney(remaining)}</span>
                        </div>
                    `;
                });

            serversList.innerHTML = rows.join('') || '<div class="cash-card__server-empty">Серверы не выбраны</div>';
        }

        function updateCard() {
            const totals = calcTotals(settings);
            totalLabel.textContent = formatMoney(totals.monthlyTotal);
            remainingLabel.textContent = `До конца месяца: ${formatMoney(totals.remainingTotal)}`;
            renderCardServers();
            if (modalSummary) {
                modalSummary.textContent = `${formatMoney(totals.monthlyTotal)} · до конца месяца ${formatMoney(totals.remainingTotal)}`;
            }
        }

        function attachModalHandlers() {
            modalContent.addEventListener('change', (event) => {
                const checkbox = event.target.closest('.cash-modal__checkbox');
                if (checkbox) {
                    const srvId = Number(checkbox.dataset.serverId);
                    const nextSelected = new Set(settings.selected || []);
                    if (checkbox.checked) {
                        nextSelected.add(srvId);
                    } else {
                        nextSelected.delete(srvId);
                    }
                    settings.selected = Array.from(nextSelected);
                    saveSettings(settings);
                    updateCard();
                    return;
                }

                const expenseInput = event.target.closest('[data-expense-input]');
                if (expenseInput) {
                    const srvId = Number(expenseInput.dataset.serverId);
                    const value = Number(expenseInput.value || 0);
                    settings.expenses = {
                        ...settings.expenses,
                        [srvId]: Math.max(0, value),
                    };
                    saveSettings(settings);
                    updateCard();
                }
            });
        }

        function openModal() {
            modal.hidden = false;
            modal.classList.add('is-open');
        }

        function closeModal() {
            modal.classList.remove('is-open');
            modal.hidden = true;
        }

        cashCard.addEventListener('click', openModal);
        document.querySelectorAll('[data-role="cash-modal-close"]').forEach((btn) => {
            btn.addEventListener('click', closeModal);
        });

        renderModalContent();
        attachModalHandlers();
        updateCard();
    })();
</script>

<p>Используйте верхнее меню для управления пользователями, серверами и фермами.</p>

{% if payment_cards %}
    <div class="admin-payment-modal" data-role="payment-modal" hidden>
        <div class="admin-payment-modal__dialog">
            <button class="admin-payment-modal__close" type="button" data-role="payment-modal-close" aria-label="Закрыть">×</button>
            <div class="admin-payment-modal__body">
                <div class="admin-payment-modal__title">Все оплаты</div>
                <div class="admin-payment-modal__subtitle">Увеличенный список для работы с платежами.</div>
                <div class="admin-payment-modal__list" data-role="payment-modal-list"></div>
            </div>
        </div>
    </div>
{% endif %}

{% if accounts_data %}
    <h2 style="margin-top: 32px;">Ресурсы ферм</h2>
    <div class="dashboard-filters">
        <div class="filter-block">
            <div class="filter-label">Быстрый поиск</div>
            <input
                type="search"
                class="form-input filter-input"
                placeholder="Имя фермы, сервер или владелец"
                aria-label="Поиск ферм"
                data-role="account-search"
            />
            <div class="filter-hint">Фильтрует список сразу по мере ввода</div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>Имя фермы</th>
                <th>Сервер</th>
                <th>Владелец</th>
                <th>Ресурсы (Food / Wood / Stone / Gold)</th>
                <th>Прирост за сегодня</th>
                <th>Обновлено</th>
                <th>Действия</th>
            </tr>
            </thead>
            <tbody>
            {% for item in accounts_data %}
                {% set acc = item.account %}
                <tr
                    data-account-id="{{ acc.id }}"
                    data-account-row
                    data-search-text="{{ (acc.name ~ ' ' ~ (acc.server.name if acc.server else '') ~ ' ' ~ (acc.owner.username if acc.owner else ''))|trim }}"
                >
                    <td>{{ acc.name }}</td>
                    <td>{{ acc.server.name if acc.server else "N/A" }}</td>
                    <td>{{ acc.owner.username if acc.owner else "—" }}</td>
                    <td data-role="resources">
                        {% if item.has_data %}
                            {{ item.resources_brief|safe }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td data-role="today-gain">
                        {% if item.today_gain %}
                            {{ item.today_gain }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td data-role="last-updated">
                        {% if item.last_updated %}
                            {{ item.last_updated }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <a href="{{ url_for('admin.manage', account_id=acc.id) }}" class="action-pill">
                            <span class="btn-icon-symbol">⚙</span>
                            <span class="btn-text">Настройки</span>
                        </a>

                        <button class="action-pill action-pill--ghost"
                                data-action="refresh-account"
                                data-account-id="{{ acc.id }}">
                            <span class="btn-text">Обновить</span>
                            <span class="btn-spinner" hidden></span>
                        </button>
                    </td>
                </tr>
            {% endfor %}
            <tr data-role="account-search-empty" hidden>
                <td colspan="7" class="muted">Ничего не найдено по текущему запросу.</td>
            </tr>
            </tbody>
        </table>
    </div>
{% else %}
    <p>Активные фермы не найдены.</p>
{% endif %}

{% if payment_cards %}
<script>
    (() => {
        const panel = document.querySelector('[data-role="payments-panel"]');
        const listEl = document.querySelector('[data-role="payments-list"]');
        const modal = document.querySelector('[data-role="payment-modal"]');
        const modalList = document.querySelector('[data-role="payment-modal-list"]');
        const expandBtn = document.querySelector('[data-role="open-payment-modal"]');
        if (!panel || !listEl) return;

        const paidUrl = {{ url_for('admin.mark_account_paid', account_id=0)|tojson }};
        const unpaidUrl = {{ url_for('admin.mark_account_unpaid', account_id=0)|tojson }};

        let lastInteractionAt = Date.now();
        let hideTimerId = null;

        function stampInteraction() {
            lastInteractionAt = Date.now();
            if (hideTimerId) return;
            hideTimerId = window.setTimeout(checkInactivity, 4000);
        }

        function checkInactivity() {
            const sinceLast = Date.now() - lastInteractionAt;
            if (sinceLast >= 4000) {
                prunePendingRows();
                hideTimerId = null;
            } else {
                hideTimerId = window.setTimeout(checkInactivity, 4000 - sinceLast);
            }
        }

        function getCardsByAccount(accountId) {
            return Array.from(document.querySelectorAll(`[data-payment-card][data-account-id="${accountId}"]`));
        }

        function markForRemoval(accountId) {
            getCardsByAccount(accountId).forEach((card) => {
                card.dataset.removePending = '1';
                card.classList.add('is-pending-removal');
            });
            stampInteraction();
        }

        function prunePendingRows() {
            const toRemove = document.querySelectorAll('[data-payment-card][data-remove-pending="1"]');
            toRemove.forEach((el) => el.remove());

            const stillCards = document.querySelectorAll('[data-payment-card]').length > 0;
            if (!stillCards) {
                panel.hidden = true;
                if (modal) modal.hidden = true;
            }
        }

        function applyBlockedState(accountId, blocked) {
            getCardsByAccount(accountId).forEach((card) => {
                card.dataset.blocked = blocked ? '1' : '0';
                card.classList.toggle('is-blocked', blocked);
            });
        }

        function cloneCard(card) {
            const clone = card.cloneNode(true);
            clone.dataset.accountId = card.dataset.accountId;
            return clone;
        }

        function renderModalList() {
            if (!modalList) return;
            modalList.innerHTML = '';
            listEl.querySelectorAll('[data-payment-card]').forEach((card) => {
                const clone = cloneCard(card);
                modalList.appendChild(clone);
            });
        }

        function closeModal() {
            if (modal) {
                modal.hidden = true;
                modal.classList.remove('is-open');
            }
        }

        function openModal() {
            if (!modal) return;
            renderModalList();
            modal.hidden = false;
            modal.classList.add('is-open');
        }

        async function handleAction(card, kind) {
            if (!card) return;
            const accountId = card.dataset.accountId;
            const endpoint = kind === 'paid' ? paidUrl : unpaidUrl;
            const url = (endpoint || '').replace('0', accountId);
            const btns = card.querySelectorAll('.icon-btn');
            btns.forEach((btn) => {
                if ('disabled' in btn) btn.disabled = true;
                btn.classList.add('is-loading');
            });
            try {
                const resp = await fetch(url, { method: 'POST', headers: { 'x-skip-loader': '1' } });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok || !data.ok) throw new Error(data.error || 'Не удалось обновить оплату');
                if (kind === 'paid') {
                    markForRemoval(accountId);
                } else {
                    applyBlockedState(accountId, true);
                    markForRemoval(accountId);
                }
            } catch (err) {
                console.error(err);
                alert(err.message || 'Не удалось обновить оплату');
            } finally {
                btns.forEach((btn) => {
                    if ('disabled' in btn) btn.disabled = false;
                    btn.classList.remove('is-loading');
                });
            }
        }

        function handleClick(event, scope) {
            stampInteraction();
            const card = event.target.closest('[data-payment-card]');
            if (event.target.closest('[data-role="payment-paid"]')) {
                event.stopPropagation();
                handleAction(card, 'paid');
                return;
            }
            if (event.target.closest('[data-role="payment-unpaid"]')) {
                event.stopPropagation();
                handleAction(card, 'unpaid');
                return;
            }
            if (scope === 'panel') {
                openModal();
            }
        }

        listEl.addEventListener('click', (event) => handleClick(event, 'panel'));
        if (modalList) {
            modalList.addEventListener('click', (event) => handleClick(event, 'modal'));
        }

        if (panel) {
            panel.addEventListener('click', stampInteraction, { capture: true });
        }

        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });
        }

        if (expandBtn) expandBtn.addEventListener('click', () => {
            stampInteraction();
            openModal();
        });

        const closeBtn = document.querySelector('[data-role="payment-modal-close"]');
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
    })();
</script>
{% endif %}
{% endblock %}
