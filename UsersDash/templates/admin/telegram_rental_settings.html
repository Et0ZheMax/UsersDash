{% extends "base.html" %}

{% block title %}Настройки Telegram аренды{% endblock %}

{% block content %}
<h1>Настройки Telegram-бота аренды</h1>

<div class="kpi-row" style="margin-bottom: 20px;">
    <div class="kpi-card">
        <div class="kpi-label">Привязано клиентов</div>
        <div class="kpi-value">{{ stats.linked_clients }}</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Без Telegram</div>
        <div class="kpi-value">{{ stats.unlinked_clients }}</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Заявок на подтверждение</div>
        <div class="kpi-value">{{ stats.pending_requests }}</div>
    </div>
</div>

<form method="post" class="card" style="padding: 20px; margin-bottom: 20px;">
    <h2>Параметры бота</h2>
    <div class="form-grid" style="display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:12px;">
        <label>Username бота (без @)
            <input type="text" name="bot_username" value="{{ settings.bot_username or '' }}">
        </label>
        <label>Часовой пояс по умолчанию
            <input type="text" name="default_timezone" value="{{ settings.default_timezone }}">
        </label>
        <label>Срок продления (дней)
            <input type="number" min="1" name="renew_duration_days" value="{{ settings.renew_duration_days }}">
        </label>
        <label>Контакт администратора (https://t.me/...)
            <input type="text" name="admin_contact" value="{{ settings.admin_contact or '' }}">
        </label>
        <label>Напоминание админу по pending (часов)
            <input type="number" min="1" name="pending_admin_reminder_hours" value="{{ settings.pending_admin_reminder_hours }}">
        </label>
    </div>

    <label style="display:block;margin-top:12px;">Инструкция по оплате
        <textarea name="payment_instructions" rows="4">{{ settings.payment_instructions or '' }}</textarea>
    </label>

    <label style="display:block;margin-top:12px;">Шаблон за 3 дня
        <textarea name="template_reminder_3d" rows="4">{{ settings.template_reminder_3d or '' }}</textarea>
    </label>

    <label style="display:block;margin-top:12px;">Шаблон за 1 день
        <textarea name="template_reminder_1d" rows="4">{{ settings.template_reminder_1d or '' }}</textarea>
    </label>

    <label style="display:block;margin-top:12px;">Шаблон в день окончания
        <textarea name="template_reminder_0d" rows="4">{{ settings.template_reminder_0d or '' }}</textarea>
    </label>

    <label style="display:block;margin-top:12px;">Шаблон для просрочки
        <textarea name="template_expired" rows="4">{{ settings.template_expired or '' }}</textarea>
    </label>

    <button class="btn" type="submit" style="margin-top:12px;">Сохранить настройки</button>
</form>

{% if generated_deep_link %}
<div class="card" style="padding: 20px; margin-bottom: 20px;">
    <h2>Ссылка привязки готова</h2>
    <div style="margin-bottom: 10px; color: #666;">
        Клиент: <strong>{{ generated_user.username if generated_user else 'неизвестный клиент' }}</strong>
    </div>
    <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
        <input id="deepLinkOutput" type="text" readonly value="{{ generated_deep_link }}" style="min-width: 420px; flex: 1;">
        <a class="btn btn-sm" href="{{ generated_deep_link }}" target="_blank" rel="noopener noreferrer">Открыть в Telegram</a>
        <button class="btn btn-sm" type="button" id="copyDeepLinkBtn">Копировать</button>
    </div>
    <div id="copyDeepLinkStatus" style="font-size: 0.9rem; color: #666;">Можно скопировать ссылку вручную из поля выше.</div>
</div>
{% endif %}

<div class="card" style="padding: 20px; margin-bottom: 20px;">
    <h2>Статус Telegram-привязки клиентов</h2>
    <table class="table">
        <thead>
        <tr>
            <th>Клиент</th>
            <th>Статус</th>
            <th>Telegram username</th>
            <th>chat_id</th>
            <th>Последняя активность</th>
            <th>Действие</th>
        </tr>
        </thead>
        <tbody>
        {% for row in clients_telegram_status %}
            <tr>
                <td>{{ row.client.username }}</td>
                <td>{{ row.status_text }}</td>
                <td>{{ row.profile.username if row.profile and row.profile.username else '—' }}</td>
                <td>{{ row.profile.chat_id if row.profile and row.profile.chat_id else '—' }}</td>
                <td>
                    {% if row.profile and row.profile.last_interaction_at %}
                        {{ row.profile.last_interaction_at.strftime('%d.%m.%Y %H:%M') }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>
                    <form method="post" action="{{ url_for('admin.telegram_generate_link_token') }}">
                        <input type="hidden" name="user_id" value="{{ row.client.id }}">
                        <button class="btn btn-sm" type="submit">Сгенерировать новую ссылку</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="card" style="padding: 20px; margin-bottom: 20px;">
    <h2>Клиенты без Telegram-привязки</h2>
    {% if unlinked_clients %}
        <table class="table">
            <thead>
            <tr><th>Клиент</th><th>Действие</th></tr>
            </thead>
            <tbody>
            {% for client in unlinked_clients %}
                <tr>
                    <td>{{ client.username }}</td>
                    <td>
                        <form method="post" action="{{ url_for('admin.telegram_generate_link_token') }}">
                            <input type="hidden" name="user_id" value="{{ client.id }}">
                            <button class="btn btn-sm" type="submit">Сгенерировать deep-link</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div>Все клиенты привязаны к Telegram.</div>
    {% endif %}
</div>

<div class="card" style="padding: 20px;">
    <h2>Последние токены привязки</h2>
    <table class="table">
        <thead>
        <tr><th>ID клиента</th><th>Создан</th><th>Истекает</th><th>Использован</th></tr>
        </thead>
        <tbody>
        {% for token in latest_tokens %}
            <tr>
                <td>{{ token.user_id }}</td>
                <td>{{ token.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td>{{ token.expires_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td>{{ token.consumed_at.strftime('%d.%m.%Y %H:%M') if token.consumed_at else 'Нет' }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% if generated_deep_link %}
<script>
    (function () {
        const output = document.getElementById('deepLinkOutput');
        const button = document.getElementById('copyDeepLinkBtn');
        const status = document.getElementById('copyDeepLinkStatus');
        if (!output || !button || !status) return;

        button.addEventListener('click', async function () {
            const text = output.value || '';
            if (!text) {
                status.textContent = 'Ссылка пустая, копировать нечего.';
                return;
            }

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    output.focus();
                    output.select();
                    document.execCommand('copy');
                }
                status.textContent = 'Ссылка скопирована в буфер обмена.';
            } catch (error) {
                output.focus();
                output.select();
                status.textContent = 'Не удалось скопировать автоматически. Скопируйте ссылку вручную.';
            }
        });
    })();
</script>
{% endif %}
{% endblock %}
