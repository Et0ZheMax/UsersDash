{% extends "base.html" %}

{% block title %}Редактор шаблонов{% endblock %}

{% block content %}
<div class="page-wrapper templates-page">
  <div class="templates-head">
    <div>
      <div class="page-kicker">Админ-панель</div>
      <h1 class="page-title">Редактор manage-шаблонов</h1>
      <p class="page-subtitle">Создавайте и правьте шаблоны с серверов RssCounter без выхода из usersdash.</p>
    </div>
    <div class="templates-actions">
      <button class="btn btn-outline" onclick="goBack()">← В дашборд</button>
      <div class="templates-server">
        <label for="serverSelect" class="templates-label">Сервер</label>
        <select id="serverSelect" class="form-input templates-select" onchange="changeServer(this.value)">
          {% if servers %}
            {% for srv in servers %}
              <option value="{{ srv.id }}">{{ srv.name }}</option>
            {% endfor %}
          {% else %}
            <option disabled selected>Серверы не настроены</option>
          {% endif %}
        </select>
      </div>
      <div class="templates-action-group">
        <button class="btn btn-primary" id="createBtn" onclick="createTemplate()" {% if not servers %}disabled{% endif %}>
          Создать
          <div class="btn-spinner" aria-hidden="true" hidden></div>
        </button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveStep()" disabled>
          Сохранить
          <div class="btn-spinner" aria-hidden="true" hidden></div>
        </button>
        <button class="btn btn-danger" id="deleteBtn" onclick="deleteTemplate()" disabled>
          Удалить
          <div class="btn-spinner" aria-hidden="true" hidden></div>
        </button>
      </div>
    </div>
  </div>

  <div class="card templates-card">
    <div class="templates-layout">
      <div class="templates-panel templates-panel--narrow">
        <div class="templates-panel__head">
          <div>
            <div class="templates-panel__kicker">Список</div>
            <h3 class="templates-panel__title">Шаблоны</h3>
            <div class="templates-panel__hint">Встроенные и загруженные шаблоны выбранного сервера.</div>
          </div>
        </div>
        <div class="templates-table">
          <div class="templates-table__wrapper">
            <table>
              <thead>
              <tr><th>Файл</th><th class="templates-table__count">Шаги</th></tr>
              </thead>
              <tbody id="templatesBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="templates-panel">
        <div class="templates-field">
          <label for="templateNameInput" class="templates-label">Имя файла</label>
          <div class="templates-field__row">
            <input id="templateNameInput" class="form-input" placeholder="example.json" />
            <button class="btn btn-primary" id="renameBtn" onclick="renameTemplate()" disabled>
              Переименовать
              <div class="btn-spinner" aria-hidden="true" hidden></div>
            </button>
          </div>
          <div class="templates-alias" id="aliasLine">Алиасы: —</div>
        </div>

        <div class="templates-steps">
          <div class="templates-steps__controls">
            <div class="templates-field templates-field--compact">
              <label class="templates-label" for="scriptIdInput">ScriptId из схемы</label>
              <input id="scriptIdInput" list="scriptList" class="form-input" placeholder="vikingbot.base.gathervip" />
            </div>
            <div class="templates-step-buttons">
              <button class="btn btn-outline" onclick="addStepFromSchema()">Шаг по схеме</button>
              <button class="btn btn-outline" onclick="addEmptyStep()">Пустой шаг</button>
            </div>
          </div>
          <datalist id="scriptList"></datalist>

          <div class="templates-table">
            <div class="templates-table__wrapper">
              <table>
                <thead>
                <tr><th class="templates-table__count">#</th><th>Описание</th></tr>
                </thead>
                <tbody id="stepsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="templates-editor">
          <div class="templates-editor__header">
            <label for="stepEditor" class="templates-label">JSON шага</label>
            <div class="templates-editor__status" id="editorStatus">Нет выбранного шаблона</div>
          </div>
          <textarea id="stepEditor" class="templates-editor__input" placeholder="Выберите шаг слева или добавьте новый"></textarea>
        </div>

        <div class="templates-config">
          <div class="templates-config__head">
            <div>
              <div class="templates-panel__kicker">Настройки</div>
              <h4 class="templates-config__title">Поля шага</h4>
            </div>
            <button class="btn btn-outline" id="addKeyBtn" onclick="addConfigKey()" disabled>+ Ключ</button>
          </div>
          <div class="templates-config__fields" id="configFields"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const state = {
    serverId: {% if servers %}{{ servers[0].id }}{% else %}null{% endif %},
    templates: [],
    steps: [],
    current: null,
    selectedStep: -1,
    aliases: {},
    schema: {},
    currentAliases: [],
  };

  function goBack(){ window.location.href = "{{ url_for('admin.admin_dashboard') }}"; }

  function apiUrl(path){
    if (!state.serverId) return null;
    const glue = path.includes('?') ? '&' : '?';
    return `/admin/api/templates${path}${glue}server_id=${state.serverId}`;
  }

  function showToast(msg, isError=false){
    const el = document.getElementById('globalToast');
    if (!el) return alert(msg);
    el.textContent = msg;
    el.classList.toggle('is-error', Boolean(isError));
    el.classList.add('show');
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(() => el.classList.remove('show'), 2200);
  }

  function setLoading(btnId, loading){
    const btn = document.getElementById(btnId);
    if (!btn) return;
    btn.classList.toggle('loading', loading);
    btn.disabled = loading;
    const spinner = btn.querySelector('.btn-spinner');
    if (spinner) spinner.hidden = !loading;
  }

  function canonicalName(name){
    if (!name) return '';
    return name.toLowerCase().endsWith('.json') ? name : `${name}.json`;
  }

  function aliasesFor(name){
    const aliases = state.aliases || {};
    const canon = canonicalName(name);
    const list = [];
    Object.entries(aliases).forEach(([k, v]) => {
      if (canonicalName(v) === canon) list.push(k);
    });
    return list;
  }

  function updateAliasLine(extra){
    const el = document.getElementById('aliasLine');
    if (!el) return;
    if (extra) state.aliases = extra;
    const list = state.current ? aliasesFor(state.current) : [];
    state.currentAliases = list;
    el.textContent = list.length ? `Алиасы: ${list.join(', ')}` : 'Алиасы: —';
  }

  function updateButtons(){
    const hasTemplate = Boolean(state.current);
    document.getElementById('saveBtn').disabled = !hasTemplate;
    document.getElementById('deleteBtn').disabled = !hasTemplate;
    document.getElementById('renameBtn').disabled = !hasTemplate;
    document.getElementById('addKeyBtn').disabled = state.selectedStep < 0;
  }

  function renderTemplates(){
    const body = document.getElementById('templatesBody');
    body.innerHTML = '';
    if (!state.templates.length){
      body.innerHTML = '<tr><td colspan="2" class="muted">Нет шаблонов</td></tr>';
      return;
    }
    state.templates.forEach(tpl => {
      const tr = document.createElement('tr');
      tr.className = 'hoverable' + (tpl.name === state.current ? ' selected' : '');
      const aliasBadges = (tpl.aliases || []).map(a => `<span class="badge">${a}</span>`).join('');
      const title = tpl.label && tpl.label !== tpl.name ? `${tpl.label} <span class="muted">(${tpl.name})</span>` : tpl.name;
      tr.innerHTML = `<td>${title} ${aliasBadges}</td><td>${tpl.steps_count ?? ''}</td>`;
      tr.onclick = () => openTemplate(tpl.name);
      body.appendChild(tr);
    });
  }

  function syncEditorWithStep(){
    const area = document.getElementById('stepEditor');
    if (state.selectedStep >= 0 && state.selectedStep < state.steps.length){
      const step = state.steps[state.selectedStep];
      area.value = JSON.stringify(step, null, 2);
      document.getElementById('editorStatus').textContent = `Редактирование шага ${state.selectedStep + 1}`;
    } else {
      area.value = '';
      document.getElementById('editorStatus').textContent = 'Выберите шаг для редактирования';
    }
  }

  function renderConfigFields(){
    const box = document.getElementById('configFields');
    if (!box) return;
    box.innerHTML = '';
    if (state.selectedStep < 0 || state.selectedStep >= state.steps.length){
      box.innerHTML = '<div class="muted">Выберите шаг, чтобы увидеть ключи</div>';
      return;
    }

    const step = state.steps[state.selectedStep] || {};
    const cfg = (step.Config && typeof step.Config === 'object') ? { ...step.Config } : {};
    const scripts = state.schema || {};
    const script = scripts[step.ScriptId] || {};
    const shape = script.Shape || script.fields || {};
    const defaults = script.Defaults || script.defaults || {};
    const keys = Array.from(new Set([...Object.keys(shape), ...Object.keys(cfg)]));

    if (!keys.length){
      box.innerHTML = '<div class="muted">Добавьте ключи в конфиг</div>';
      return;
    }

    keys.forEach(key => {
      const row = document.createElement('div');
      row.className = 'config-row';
      const form = shape[key] || {};
      const current = cfg[key];
      const label = document.createElement('label');
      label.textContent = key;
      row.appendChild(label);

      const type = form.type || (typeof current === 'boolean' ? 'bool' : 'text');
      let control;

      if (type === 'select'){
        control = document.createElement('select');
        const options = form.options || (current && current.options) || defaults[key]?.options || [];
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          control.appendChild(o);
        });
        const value = (current && typeof current === 'object' && 'value' in current)
          ? current.value
          : (defaults[key]?.value ?? '');
        control.value = value ?? '';
        control.onchange = (ev) => updateConfigValue(key, { value: ev.target.value, options });
      } else if (type === 'bool'){
        control = document.createElement('input');
        control.type = 'checkbox';
        control.checked = Boolean(current);
        control.onchange = (ev) => updateConfigValue(key, ev.target.checked);
      } else if (type === 'number'){
        control = document.createElement('input');
        control.type = 'number';
        control.value = current ?? defaults[key] ?? 0;
        control.oninput = (ev) => updateConfigValue(key, Number(ev.target.value));
      } else {
        control = document.createElement('input');
        control.type = 'text';
        const value = (current && typeof current === 'object' && 'value' in current)
          ? current.value
          : (current ?? defaults[key] ?? '');
        control.value = value;
        control.oninput = (ev) => updateConfigValue(key, ev.target.value);
      }

      row.appendChild(control);
      box.appendChild(row);
    });
  }

  function renderSteps(){
    const body = document.getElementById('stepsBody');
    body.innerHTML = '';
    if (!state.steps.length){
      body.innerHTML = '<tr><td colspan="2" class="muted">Нет шагов</td></tr>';
      syncEditorWithStep();
      renderConfigFields();
      updateButtons();
      return;
    }

    state.steps.forEach((step, idx) => {
      const title = step?.ScriptId || step?.Name || step?.Script || step?.Action || 'Шаг';
      const desc = step?.Uid ? `${title} — ${step.Uid}` : title;
      const tr = document.createElement('tr');
      const selected = idx === state.selectedStep;
      tr.className = 'hoverable' + (selected ? ' selected' : '');
      tr.innerHTML = `<td>${idx + 1}</td><td>${desc}</td>`;
      tr.onclick = () => selectStep(idx);
      body.appendChild(tr);
    });

    syncEditorWithStep();
    renderConfigFields();
    updateButtons();
  }

  async function loadTemplates(){
    if (!state.serverId) return;
    const url = apiUrl('/list');
    const res = await fetch(url);
    if (!res.ok){
      showToast('Не удалось загрузить список шаблонов', true);
      return;
    }
    const data = await res.json();
    state.aliases = data.aliases || {};
    state.templates = (data.templates || []).map(item => ({
      name: item.name,
      label: item.label || item.name,
      steps_count: item.steps_count ?? null,
      aliases: item.aliases && item.aliases.length ? item.aliases : aliasesFor(item.name),
    }));
    renderTemplates();
  }

  async function loadSchema(){
    if (!state.serverId) return;
    const res = await fetch(apiUrl('/schema'));
    if (!res.ok) return;
    try {
      const data = await res.json();
      const scripts = data?.schema?.Scripts || data.Scripts || data;
      if (scripts && typeof scripts === 'object'){
        state.schema = scripts;
        renderScriptOptions();
      }
    } catch (e){ console.error(e); }
  }

  function renderScriptOptions(){
    const list = document.getElementById('scriptList');
    if (!list) return;
    list.innerHTML = '';
    Object.keys(state.schema || {}).sort().forEach(sid => {
      const opt = document.createElement('option');
      opt.value = sid;
      list.appendChild(opt);
    });
  }

  async function openTemplate(name){
    if (!state.serverId) return;
    setLoading('saveBtn', true);
    try {
      const res = await fetch(apiUrl(`/${encodeURIComponent(name)}`));
      if (!res.ok){
        showToast('Не удалось загрузить шаблон', true);
        return;
      }
      const data = await res.json();
      state.current = data.name;
      state.steps = Array.isArray(data.steps) ? data.steps : [];
      state.selectedStep = state.steps.length ? 0 : -1;
      state.currentAliases = data.aliases || aliasesFor(data.name);
      state.templates = state.templates.map(tpl =>
        tpl.name === data.name ? { ...tpl, steps_count: data.steps_count, aliases: tpl.aliases?.length ? tpl.aliases : data.aliases } : tpl
      );
      document.getElementById('templateNameInput').value = data.name;
      updateAliasLine();
      renderTemplates();
      renderSteps();
      updateButtons();
    } catch (e){
      console.error(e);
      showToast('Ошибка загрузки шаблона', true);
    } finally {
      setLoading('saveBtn', false);
    }
  }

  async function createTemplate(){
    if (!state.serverId){ showToast('Выберите сервер', true); return; }
    const name = (prompt('Введите имя файла (без .json):') || '').trim();
    if (!name) return;
    setLoading('createBtn', true);
    try {
      const res = await fetch(apiUrl(`/${encodeURIComponent(name)}`), {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ steps: [] })
      });
      if (!res.ok){
        showToast('Не удалось создать шаблон', true);
        return;
      }
      await loadTemplates();
      const safeName = name.endsWith('.json') ? name : `${name}.json`;
      await openTemplate(safeName);
      showToast('Шаблон создан');
    } catch (e){
      console.error(e);
      showToast('Ошибка создания', true);
    } finally {
      setLoading('createBtn', false);
    }
  }

  async function renameTemplate(){
    if (!state.current){ showToast('Сначала выберите шаблон', true); return; }
    const input = document.getElementById('templateNameInput');
    const newName = (input.value || '').trim();
    if (!newName || newName === state.current){
      showToast('Укажите новое имя файла', true);
      return;
    }
    setLoading('renameBtn', true);
    try {
      const res = await fetch(apiUrl(`/${encodeURIComponent(state.current)}/rename`), {
        method: 'PATCH', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_name: newName })
      });
      if (!res.ok){
        showToast('Не удалось переименовать', true);
        return;
      }
      const data = await res.json();
      state.aliases = data.aliases || state.aliases;
      await loadTemplates();
      state.current = data.name;
      input.value = data.name;
      updateAliasLine(data.aliases);
      await openTemplate(data.name);
      showToast('Имя обновлено');
    } catch (e){
      console.error(e);
      showToast('Ошибка при переименовании', true);
    } finally {
      setLoading('renameBtn', false);
    }
  }

  async function saveTemplate(name, steps){
    const res = await fetch(apiUrl(`/${encodeURIComponent(name)}`), {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ steps })
    });
    if (!res.ok) throw new Error('save failed');
    const data = await res.json();
    state.templates = state.templates.map(tpl => tpl.name === data.name ? { ...tpl, steps_count: data.steps_count } : tpl);
  }

  async function saveStep(){
    if (!state.current){
      showToast('Сначала выберите шаблон', true);
      return;
    }
    const raw = document.getElementById('stepEditor').value.trim();
    if (!raw){
      showToast('Вставьте JSON шага', true);
      return;
    }
    let parsed;
    try { parsed = JSON.parse(raw); } catch (e){ showToast('Некорректный JSON', true); return; }
    if (typeof parsed !== 'object' || parsed === null){ showToast('Нужен объект или массив', true); return; }

    const steps = [...state.steps];
    const idx = state.selectedStep;
    if (idx >= 0 && idx < steps.length){ steps[idx] = parsed; } else { steps.push(parsed); state.selectedStep = steps.length - 1; }

    setLoading('saveBtn', true);
    try {
      await saveTemplate(state.current, steps);
      state.steps = steps;
      renderTemplates();
      renderSteps();
      showToast('Сохранено');
    } catch (e){
      console.error(e);
      showToast('Не удалось сохранить', true);
    } finally { setLoading('saveBtn', false); }
  }

  function buildStepFromSchema(scriptId){
    const scripts = state.schema || {};
    const spec = scripts[scriptId] || {};
    const shape = spec.Shape || spec.fields || {};
    const defaults = spec.Defaults || spec.defaults || {};
    const config = {};
    Object.keys(shape).forEach(key => {
      const form = shape[key] || {};
      const def = defaults[key];
      if (form.type === 'select'){
        const opts = form.options || (def && def.options) || [];
        const val = def && typeof def === 'object' && 'value' in def ? def.value : (opts[0] ?? '');
        config[key] = { value: val, options: opts };
      } else if (form.type === 'bool'){
        config[key] = Boolean(def);
      } else if (form.type === 'number'){
        config[key] = typeof def === 'number' ? def : 0;
      } else {
        config[key] = def ?? '';
      }
    });
    Object.entries(defaults).forEach(([k, v]) => { if (!(k in config)) config[k] = v; });
    const baseId = state.steps.length;
    return { ScriptId: scriptId, Uid: `${scriptId}_${Date.now()}`, OrderId: baseId, Config: config, Id: baseId, IsActive: true, IsCopy: true, ScheduleData: { Active: false, Last: '0001-01-01T00:00:00', Daily: false, Hourly: false, Weekly: false }, ScheduleRules: [] };
  }

  function addStepFromSchema(){
    if (!state.current){ showToast('Выберите шаблон', true); return; }
    const sid = (document.getElementById('scriptIdInput').value || '').trim();
    if (!sid){ showToast('Укажите ScriptId', true); return; }
    const step = buildStepFromSchema(sid);
    state.steps = [...state.steps, step];
    state.selectedStep = state.steps.length - 1;
    renderSteps();
    showToast('Шаг добавлен по схеме');
  }

  function addEmptyStep(){
    if (!state.current){ showToast('Выберите шаблон', true); return; }
    const baseId = state.steps.length;
    const fresh = { ScriptId: '', Uid: `custom_${Date.now()}`, OrderId: baseId, Config: {}, Id: baseId, IsActive: true, IsCopy: true, ScheduleData: { Active: false, Last: '0001-01-01T00:00:00', Daily: false, Hourly: false, Weekly: false }, ScheduleRules: [] };
    state.steps = [...state.steps, fresh];
    state.selectedStep = state.steps.length - 1;
    renderSteps();
    showToast('Добавлен пустой шаг');
  }

  function selectStep(idx){ state.selectedStep = idx; renderSteps(); }

  function updateConfigValue(key, value){
    if (state.selectedStep < 0 || state.selectedStep >= state.steps.length) return;
    const step = state.steps[state.selectedStep];
    if (!step.Config || typeof step.Config !== 'object') step.Config = {};
    step.Config[key] = value;
    syncEditorWithStep();
  }

  function addConfigKey(){
    if (state.selectedStep < 0 || state.selectedStep >= state.steps.length){ showToast('Выберите шаг', true); return; }
    const key = (prompt('Имя нового ключа:') || '').trim();
    if (!key) return;
    const step = state.steps[state.selectedStep];
    if (!step.Config || typeof step.Config !== 'object') step.Config = {};
    if (key in step.Config){ showToast('Такой ключ уже есть', true); return; }
    step.Config[key] = '';
    renderConfigFields();
    syncEditorWithStep();
  }

  async function deleteTemplate(){
    if (!state.current) return;
    if (!confirm(`Удалить шаблон ${state.current}?`)) return;
    setLoading('deleteBtn', true);
    try {
      const res = await fetch(apiUrl(`/${encodeURIComponent(state.current)}`), { method:'DELETE' });
      if (!res.ok){ showToast('Не удалось удалить', true); return; }
      state.current = null; state.steps = []; state.selectedStep = -1;
      document.getElementById('templateNameInput').value = '';
      document.getElementById('stepEditor').value = '';
      document.getElementById('editorStatus').textContent = 'Нет выбранного шаблона';
      await loadTemplates();
      renderSteps();
      updateAliasLine();
      updateButtons();
      showToast('Шаблон удалён');
    } catch (e){
      console.error(e);
      showToast('Ошибка удаления', true);
    } finally { setLoading('deleteBtn', false); }
  }

  function changeServer(serverId){
    state.serverId = serverId ? Number(serverId) : null;
    state.templates = [];
    state.steps = [];
    state.current = null;
    state.selectedStep = -1;
    document.getElementById('templateNameInput').value = '';
    renderTemplates();
    renderSteps();
    updateAliasLine();
    loadTemplates();
    loadSchema();
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (state.serverId){
      document.getElementById('serverSelect').value = state.serverId;
      loadTemplates();
      loadSchema();
    }
  });
</script>

<div id="globalToast" class="toast"></div>
{% endblock %}
